<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Learn - 初中数理可视化知识库</title>
    <script src="./assets/tailwindcss.js"></script>
    <script src="data.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* 卡片悬浮特效 */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
            border-color: #93c5fd;
        }
        
        /* 标签按钮选中状态 - 强制覆盖 */
        .tag-btn.active {
            background-color: #2563eb !important; /* blue-600 */
            color: #ffffff !important;
            border-color: #2563eb !important;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            font-weight: 600;
        }

        /* 搜索高亮 */
        .highlight {
            background-color: #fef08a; /* yellow-200 */
            color: #854d0e; /* yellow-800 */
            padding: 0 2px;
            border-radius: 2px;
            font-weight: bold;
        }

        /* 隐藏滚动条但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 多行文本截断 */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <header class="bg-white sticky top-0 z-50 shadow-md border-b border-slate-200/80 backdrop-blur-sm bg-white/95">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer group select-none" onclick="app.resetAll()" title="点击重置所有筛选">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-2.5 rounded-xl shadow-lg group-hover:scale-105 transition-transform duration-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold tracking-tight text-slate-800 group-hover:text-blue-600 transition-colors">Visual Learn</h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide">全量资源库 (<span id="headerCount">--</span>个演示)</p>
                    </div>
                </div>

                <div class="w-full md:w-1/2 relative group">
                    <input type="text" id="searchInput" placeholder="搜索知识点（如：凸透镜、勾股定理、函数...）" 
                        class="w-full pl-11 pr-10 py-3 rounded-xl bg-slate-100 border-2 border-transparent focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/10 transition-all shadow-inner font-medium text-slate-700 placeholder-slate-400">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3.5 top-3.5 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <button id="clearSearchBtn" onclick="app.clearSearch()" class="hidden absolute right-3 top-3 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full p-1 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-slate-200 shadow-sm relative z-40">
        <div class="container mx-auto px-4 py-5 space-y-4">
            <div id="filterContainer"></div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center text-sm gap-3 sticky top-[73px] z-30 bg-slate-50/90 backdrop-blur border-b border-slate-200 md:static md:bg-transparent md:border-none">
        <div class="flex items-center gap-2 overflow-x-auto w-full md:w-auto no-scrollbar pb-1 md:pb-0">
            <span class="font-bold text-slate-700 whitespace-nowrap">当前筛选:</span>
            <div id="activeFilters" class="flex items-center gap-2">
                <span class="text-slate-400 italic text-xs py-1">暂无筛选条件 (显示全部)</span>
            </div>
        </div>
        <div class="text-slate-500 font-medium bg-white px-4 py-1.5 rounded-full border border-slate-200 shadow-sm whitespace-nowrap">
            共找到 <span id="totalCount" class="text-blue-600 font-bold">0</span> 个资源
        </div>
    </div>

    <main class="container mx-auto px-4 pb-16 flex-grow">
        <div id="contentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
        
        <div id="noResults" class="hidden flex-col items-center justify-center py-20 opacity-0 transition-opacity duration-500">
            <div class="w-32 h-32 bg-slate-100 rounded-full flex items-center justify-center mb-6 relative overflow-hidden">
                <div class="absolute inset-0 bg-grid-slate-200 [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))]"></div>
                <svg class="w-16 h-16 text-slate-300 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl text-slate-800 font-bold mb-2">没有找到匹配的演示</h3>
            <p class="text-slate-500 text-sm mb-6 max-w-md text-center">可能是关键词拼写错误，或者当前的标签组合下没有对应的内容。</p>
            <button onclick="app.resetAll()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg shadow-blue-500/30 transition-all font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                清除所有筛选条件
            </button>
        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-slate-500 text-sm font-medium">Visual Learn Knowledge Base</p>
            <p class="text-slate-400 text-xs mt-2">Designed for Interactive Education &middot; 2024-2026</p>
        </div>
    </footer>

    <script>
        const app = (() => {
            // ================== 1. 数据配置 ==================
            // 从全局对象中获取配置，如果未加载则使用空默认值
            const { TAG_COLOR_MAP, FILTER_GROUPS, RESOURCES } = window.VISUAL_LEARN_DATA || {
                TAG_COLOR_MAP: { 'default': 'bg-slate-50 text-slate-500 border-slate-200' },
                FILTER_GROUPS: [],
                RESOURCES: []
            };

            // 安全检查
            if (!window.VISUAL_LEARN_DATA) {
                console.error('Critical Error: data.js not loaded. Please ensure data.js is in the same directory and loaded correctly.');
                alert('数据文件 (data.js) 加载失败，页面可能无法正常显示。请检查文件位置。');
            }

            // ================== 2. 状态管理 ==================
            
            let state = {
                searchQuery: '',
                selectedTags: new Set()
            };

            // ================== 3. 核心逻辑 ==================

            function init() {
                // 初始化 Header 计数
                const headerCount = document.getElementById('headerCount');
                if(headerCount) headerCount.innerText = RESOURCES.length;

                const params = new URLSearchParams(window.location.search);
                if (params.get('q')) state.searchQuery = decodeURIComponent(params.get('q'));
                if (params.get('tags')) {
                    params.get('tags').split(',').filter(t => t).forEach(t => state.selectedTags.add(t));
                }

                renderFilterSections();
                const searchInput = document.getElementById('searchInput');
                searchInput.value = state.searchQuery;
                searchInput.addEventListener('input', (e) => handleSearch(e.target.value));

                renderContent();
                updateUIState();
            }

            function renderFilterSections() {
                const container = document.getElementById('filterContainer');
                if (!container) return;

                container.innerHTML = FILTER_GROUPS.map(group => `
                    <div class="flex flex-col sm:flex-row items-start gap-3 sm:gap-4 border-b border-slate-100 last:border-0 pb-3 last:pb-0">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2 w-12 flex-shrink-0 text-left sm:text-right">
                            ${group.label}
                        </span>
                        <div class="flex flex-wrap gap-2" id="group-${group.id}">
                            ${group.tags.map(tag => `
                                <button 
                                    class="tag-btn px-3 py-1.5 text-xs rounded-full border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 hover:border-blue-300 transition-all select-none cursor-pointer"
                                    onclick="app.toggleTag('${tag}', '${group.id}')"
                                    data-tag="${tag}"
                                    data-group="${group.id}">
                                    ${tag}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            function toggleTag(tag, groupId) {
                // 学科组实现互斥（单选），其他组多选
                if (groupId === 'subject') {
                    if (state.selectedTags.has(tag)) {
                        state.selectedTags.delete(tag);
                    } else {
                        FILTER_GROUPS.find(g => g.id === 'subject').tags.forEach(t => state.selectedTags.delete(t));
                        state.selectedTags.add(tag);
                    }
                } else {
                    if (state.selectedTags.has(tag)) {
                        state.selectedTags.delete(tag);
                    } else {
                        state.selectedTags.add(tag);
                    }
                }
                updateUIState();
                renderContent();
                updateURL();
            }

            function handleSearch(query) {
                state.searchQuery = query.trim();
                const clearBtn = document.getElementById('clearSearchBtn');
                if (state.searchQuery) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
                renderContent();
                updateURL();
            }

            function clearSearch() {
                state.searchQuery = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('clearSearchBtn').classList.add('hidden');
                document.getElementById('searchInput').focus();
                renderContent();
                updateURL();
            }

            function resetAll() {
                state.searchQuery = '';
                state.selectedTags.clear();
                document.getElementById('searchInput').value = '';
                document.getElementById('clearSearchBtn').classList.add('hidden');
                updateUIState();
                renderContent();
                updateURL();
            }

            // 更新 UI 状态
            function updateUIState() {
                // 1. 更新按钮样式
                document.querySelectorAll('.tag-btn').forEach(btn => {
                    const tag = btn.dataset.tag;
                    if (state.selectedTags.has(tag)) {
                        btn.classList.add('active');
                        btn.classList.remove('hover:bg-slate-50');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('hover:bg-slate-50');
                    }
                });

                // 2. 更新下方状态条
                const activeContainer = document.getElementById('activeFilters');
                if (state.selectedTags.size === 0) {
                    activeContainer.innerHTML = '<span class="text-slate-400 italic text-xs py-1">暂无筛选条件 (显示全部)</span>';
                } else {
                    activeContainer.innerHTML = Array.from(state.selectedTags).map(tag => `
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                            ${tag}
                            <button onclick="app.toggleTag('${tag}', null)" class="hover:text-blue-900 ml-1 focus:outline-none" title="移除标签">
                                &times;
                            </button>
                        </span>
                    `).join('');
                }
            }

            // 渲染内容卡片
            function renderContent() {
                const grid = document.getElementById('contentGrid');
                const noResults = document.getElementById('noResults');
                const totalSpan = document.getElementById('totalCount');
                
                const queryLower = state.searchQuery.toLowerCase();
                const filtered = RESOURCES.filter(item => {
                    // 关键词匹配
                    const matchSearch = !state.searchQuery || 
                                        item.title.toLowerCase().includes(queryLower) || 
                                        item.desc.toLowerCase().includes(queryLower) ||
                                        item.tags.some(t => t.toLowerCase().includes(queryLower));
                    
                    // 标签匹配 (AND 逻辑)
                    let matchTags = true;
                    if (state.selectedTags.size > 0) {
                        for (let tag of state.selectedTags) {
                            if (!item.tags.includes(tag)) {
                                matchTags = false;
                                break;
                            }
                        }
                    }
                    return matchSearch && matchTags;
                });

                totalSpan.textContent = filtered.length;

                if (filtered.length === 0) {
                    grid.innerHTML = '';
                    noResults.classList.remove('hidden');
                    noResults.classList.add('flex');
                    setTimeout(() => noResults.classList.remove('opacity-0'), 10);
                } else {
                    noResults.classList.add('hidden');
                    noResults.classList.remove('flex');
                    noResults.classList.add('opacity-0');

                    grid.innerHTML = filtered.map(item => {
                        const isMath = item.tags.includes('数学');
                        const isPhysics = item.tags.includes('物理');
                        let barClass = 'bg-slate-400';
                        if (isPhysics) barClass = 'bg-blue-500';
                        if (isMath) barClass = 'bg-emerald-500';
                        if (isPhysics && isMath) barClass = 'bg-gradient-to-r from-blue-500 to-emerald-500';

                        const tagBadges = item.tags.slice(0, 3).map(tag => {
                            const style = TAG_COLOR_MAP[tag] || TAG_COLOR_MAP['default'];
                            return `<span class="text-[10px] px-2 py-0.5 rounded border ${style}">${tag}</span>`;
                        }).join('');
                        
                        const moreTags = item.tags.length > 3 
                            ? `<span class="text-[10px] px-1.5 py-0.5 text-slate-400 bg-slate-50 rounded border border-slate-200">+${item.tags.length - 3}</span>` 
                            : '';

                        return `
                            <a href="knowledge-nodes/${item.file}" class="group relative bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden card-hover flex flex-col h-full hover:border-blue-300">
                                <div class="absolute top-0 left-0 w-full h-1.5 ${barClass}"></div>
                                <div class="p-5 flex flex-col h-full">
                                    <div class="flex flex-wrap gap-1.5 mb-3 mt-1">
                                        ${tagBadges}
                                        ${moreTags}
                                    </div>
                                    <h3 class="text-lg font-bold text-slate-800 mb-2 group-hover:text-blue-600 transition-colors leading-tight">
                                        ${highlightText(item.title, state.searchQuery)}
                                    </h3>
                                    <p class="text-xs text-slate-500 leading-relaxed mb-4 flex-grow line-clamp-3">
                                        ${highlightText(item.desc, state.searchQuery)}
                                    </p>
                                    <div class="pt-4 border-t border-slate-50 flex items-center justify-between text-xs font-medium text-slate-400 mt-auto">
                                        <span class="group-hover:text-blue-600 transition-colors flex items-center gap-1">
                                            ${item.tags.includes('互动探究') || item.tags.includes('实验模拟') ? '开始演示' : '查看详情'}
                                        </span>
                                        <div class="w-6 h-6 rounded-full bg-slate-50 group-hover:bg-blue-100 flex items-center justify-center transition-colors">
                                            <svg class="w-3.5 h-3.5 text-slate-300 group-hover:text-blue-600 transition-colors transform group-hover:translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        `;
                    }).join('');
                }
            }

            function highlightText(text, query) {
                if (!query) return text;
                const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${safeQuery})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            }

            function updateURL() {
                const url = new URL(window.location);
                if (state.searchQuery) url.searchParams.set('q', state.searchQuery);
                else url.searchParams.delete('q');
                if (state.selectedTags.size > 0) {
                    url.searchParams.set('tags', Array.from(state.selectedTags).join(','));
                } else {
                    url.searchParams.delete('tags');
                }
                window.history.replaceState({}, '', url);
            }

            return { init, toggleTag, clearSearch, resetAll };
        })();

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>