<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ºè§„ä½œå›¾äº¤äº’æ¼”ç¤ºï¼šæ±‚ç›´çº¿ä¸Šä¸€ç‚¹åˆ°ä¸¤ç‚¹è·ç¦»ç›¸ç­‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        canvas { touch-action: none; }
        .control-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .step-active { background-color: #e0f2fe; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden">

    <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
    <header class="bg-white shadow-sm p-4 z-10 flex justify-between items-center shrink-0">
        <div>
            <h1 class="text-xl font-bold text-slate-800">ğŸ“ äº¤äº’æ¼”ç¤ºï¼šåœ¨ç›´çº¿ä¸Šç¡®å®šä¸€ç‚¹ Pï¼Œä½¿ PA = PB</h1>
            <p class="text-sm text-slate-500 mt-1">æ‹–åŠ¨ç‚¹ Aã€B æˆ–ç›´çº¿ä¸Šçš„ç‚¹ Cã€D æ”¹å˜é¢˜ç›®æ¡ä»¶</p>
        </div>
        <div class="hidden md:block text-xs text-slate-400">
            åŸç†ï¼šå‚ç›´å¹³åˆ†çº¿ä¸Šçš„ç‚¹åˆ°çº¿æ®µä¸¤ç«¯è·ç¦»ç›¸ç­‰
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <aside class="control-panel w-full md:w-80 border-r border-slate-200 p-4 flex flex-col gap-4 overflow-y-auto absolute md:relative z-20 h-full transform transition-transform duration-300" id="sidebar">
            
            <!-- æ­¥éª¤æ§åˆ¶å™¨ -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                <h2 class="font-semibold text-slate-700 mb-3">ä½œå›¾æ­¥éª¤</h2>
                <div class="flex justify-between gap-2 mb-4">
                    <button onclick="changeStep(-1)" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 rounded text-sm font-medium transition">ä¸Šä¸€æ­¥</button>
                    <span id="step-indicator" class="self-center font-bold text-blue-600">0 / 4</span>
                    <button onclick="changeStep(1)" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">ä¸‹ä¸€æ­¥</button>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div id="desc-step-0" class="step-desc p-2 rounded transition-colors step-active">
                        <strong>Step 0: é¢˜ç›®æ¡ä»¶</strong><br>
                        å·²çŸ¥çº¿æ®µ AB å’Œä¸€æ¡ç›´çº¿ Lã€‚ç›®æ ‡æ˜¯åœ¨ L ä¸Šæ‰¾ä¸€ç‚¹ Pã€‚
                    </div>
                    <div id="desc-step-1" class="step-desc p-2 rounded transition-colors text-slate-500">
                        <strong>Step 1: ä½œåœ†å¼§</strong><br>
                        åˆ†åˆ«ä»¥ Aã€B ä¸ºåœ†å¿ƒï¼Œå¤§äº 1/2 AB é•¿ä¸ºåŠå¾„ç”»å¼§ã€‚
                    </div>
                    <div id="desc-step-2" class="step-desc p-2 rounded transition-colors text-slate-500">
                        <strong>Step 2: ä½œå‚ç›´å¹³åˆ†çº¿</strong><br>
                        è¿æ¥ä¸¤å¼§äº¤ç‚¹ï¼Œå¾—åˆ°çº¿æ®µ AB çš„å‚ç›´å¹³åˆ†çº¿ï¼ˆä¸­å‚çº¿ï¼‰ã€‚
                    </div>
                    <div id="desc-step-3" class="step-desc p-2 rounded transition-colors text-slate-500">
                        <strong>Step 3: ç¡®å®šäº¤ç‚¹ P</strong><br>
                        å‚ç›´å¹³åˆ†çº¿ä¸ç›´çº¿ L çš„äº¤ç‚¹å³ä¸ºæ‰€æ±‚ç‚¹ Pã€‚
                    </div>
                    <div id="desc-step-4" class="step-desc p-2 rounded transition-colors text-slate-500">
                        <strong>Step 4: éªŒè¯ç»“æœ</strong><br>
                        è¿æ¥ PA å’Œ PBï¼Œæµ‹é‡é•¿åº¦éªŒè¯ PA = PBã€‚
                    </div>
                </div>
            </div>

            <!-- å¯è§†åŒ–å¼€å…³ -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                <h2 class="font-semibold text-slate-700 mb-3">å›¾å±‚å¼€å…³</h2>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="check-grid" checked onchange="requestRender()" class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-slate-600">æ˜¾ç¤ºç½‘æ ¼èƒŒæ™¯</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="check-measure" checked onchange="requestRender()" class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-slate-600">æ˜¾ç¤ºè·ç¦»æ•°å€¼</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="check-perp-mark" checked onchange="requestRender()" class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-slate-600">æ˜¾ç¤ºå‚ç›´/ç›¸ç­‰ç¬¦å·</span>
                    </label>
                </div>
            </div>

            <!-- åŸç†è¯´æ˜åŒºåŸŸ -->
            <div class="bg-indigo-50 p-4 rounded-lg shadow-sm border border-indigo-100">
                <h2 class="font-semibold text-indigo-800 mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    åŸç†æ­ç§˜ï¼šä¸ºä»€ä¹ˆè¿™æ ·ç”»ï¼Ÿ
                </h2>
                <div class="text-sm text-indigo-900 space-y-3 leading-relaxed">
                    
                    <div class="bg-white p-2 rounded border border-indigo-100 shadow-sm">
                        <strong class="text-indigo-700 block mb-1 text-xs uppercase tracking-wide">æ ¸å¿ƒå®šç† (åˆ¤å®šä¾æ®)</strong>
                        <p>åˆ°çº¿æ®µä¸¤ç«¯ç‚¹è·ç¦»ç›¸ç­‰çš„ç‚¹ï¼Œå‡åœ¨çº¿æ®µçš„<strong>å‚ç›´å¹³åˆ†çº¿</strong>ä¸Šã€‚</p>
                    </div>

                    <ul class="list-disc pl-4 space-y-2 text-indigo-800 text-xs">
                        <li>
                            <strong>æ„é€ ç­‰è·ç‚¹ï¼š</strong>
                            æˆ‘ä»¬ä»¥ Aã€B ä¸ºåœ†å¿ƒï¼Œ<span class="font-mono bg-indigo-100 px-1 rounded">R > Â½AB</span> ä¸ºåŠå¾„ç”»å¼§ã€‚
                        </li>
                        <li>
                            <strong>äº¤ç‚¹çš„æ€§è´¨ï¼š</strong>
                            ä¸¤å¼§çš„äº¤ç‚¹ï¼ˆè®¾ä¸º Mï¼‰åˆ° A å’Œ B çš„è·ç¦»éƒ½æ˜¯ Rï¼Œå³ <span class="font-mono bg-indigo-100 px-1 rounded">MA = MB</span>ã€‚
                        </li>
                        <li>
                            <strong>ç»“è®ºï¼š</strong>
                            æ ¹æ®æ ¸å¿ƒå®šç†ï¼Œç‚¹ M å¿…å®šåœ¨ AB çš„å‚ç›´å¹³åˆ†çº¿ä¸Šã€‚è¿æ¥ä¸¤ä¸ªè¿™æ ·çš„äº¤ç‚¹ï¼Œå³ç¡®å®šäº†æ•´æ¡å‚ç›´å¹³åˆ†çº¿ã€‚
                        </li>
                    </ul>

                    <div class="pt-2 border-t border-indigo-200 mt-2">
                        <span class="text-xs text-indigo-500 font-semibold">æ·±å±‚å‡ ä½•é€»è¾‘ (SSS)ï¼š</span>
                        <p class="text-xs text-indigo-700 mt-1">
                            æ„é€ å‡ºçš„ä¸‰è§’å½¢ <span class="font-serif italic">â–³AMB</span> æ˜¯ç­‰è…°ä¸‰è§’å½¢ã€‚è‹¥æœ‰ä¸¤ä¸ªäº¤ç‚¹ Mã€Nï¼Œåˆ™å››è¾¹å½¢ <span class="font-serif italic">AMBN</span> æ˜¯è±å½¢ï¼Œè±å½¢çš„å¯¹è§’çº¿äº’ç›¸å‚ç›´å¹³åˆ†ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-4 border-t border-slate-200">
                <button onclick="resetView()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded text-sm transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    é‡ç½®ä½ç½®
                </button>
            </div>
        </aside>

        <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
        <button class="md:hidden absolute top-4 left-4 z-30 bg-white p-2 rounded shadow text-slate-600" onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <!-- ä¸»ç»˜å›¾åŒº -->
        <main class="flex-1 bg-slate-50 relative cursor-crosshair h-full w-full">
            <canvas id="canvas" class="block w-full h-full"></canvas>
            
            <!-- æ‚¬æµ®æç¤º -->
            <div id="status-tooltip" class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-4 py-2 rounded shadow-lg text-sm font-mono hidden border border-slate-200 pointer-events-none text-slate-700">
                PA: 0.00 | PB: 0.00
            </div>
        </main>
    </div>

<script>
/**
 * æ•°å­¦ä¸ç‰©ç†äº’åŠ¨æ¼”ç¤ºå¼•æ“
 * è§’è‰²ï¼šå‰ç«¯å¯è§†åŒ–å·¥ç¨‹å¸ˆ
 */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let width, height;

// çŠ¶æ€ç®¡ç†
const state = {
    step: 0, // 0: Start, 1: Arcs, 2: Bisector, 3: Intersection, 4: Verify
    points: {
        A: { x: 0, y: 0, label: 'A', color: '#1e40af', isDragging: false },
        B: { x: 0, y: 0, label: 'B', color: '#1e40af', isDragging: false },
        C: { x: 0, y: 0, label: '', color: '#334155', isDragging: false }, // Line L control point 1
        D: { x: 0, y: 0, label: 'ç›´çº¿ L', color: '#334155', isDragging: false }  // Line L control point 2
    },
    intersectionP: null,
    draggedPointKey: null
};

// æ ·å¼é…ç½®
const style = {
    pointRadius: 6,
    touchRadius: 20,
    lineColor: '#334155', // Slate 700 (Darker for visibility)
    lineWidth: 3,         // Thicker line
    bisectorColor: '#f97316', // Orange 500
    constructionColor: '#94a3b8', // Slate 400 (Faint)
    resultColor: '#dc2626', // Red 600
    verifyColor: '#16a34a', // Green 600
    font: '14px sans-serif'
};

// --- åˆå§‹åŒ–ä¸äº‹ä»¶ç›‘å¬ ---

function init() {
    window.addEventListener('resize', resize);
    resize();
    resetView();
    
    // é¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    
    // è§¦æ‘¸äº‹ä»¶
    canvas.addEventListener('touchstart', (e) => handleStart(e.touches[0]));
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e.touches[0]); }, { passive: false });
    window.addEventListener('touchend', handleEnd);
    
    requestRender();
}

function resize() {
    width = canvas.parentElement.clientWidth;
    height = canvas.parentElement.clientHeight;
    // é˜²æ­¢åˆå§‹é«˜åº¦ä¸º0å¯¼è‡´è®¡ç®—é”™è¯¯
    if (!width) width = window.innerWidth;
    if (!height) height = window.innerHeight;

    canvas.width = width * window.devicePixelRatio;
    canvas.height = height * window.devicePixelRatio;
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    requestRender();
}

function resetView() {
    // é»˜è®¤ä½ç½®ï¼šå°†ç‚¹æ”¾åœ¨å±å¹•ç›¸å¯¹ä½ç½®ï¼Œç¡®ä¿é€‚åº”ä¸åŒå±å¹•
    const cx = width / 2;
    const cy = height / 2;
    
    // ç¡®ä¿çº¿æ®µ AB åœ¨å±å¹•ä¸‹æ–¹
    state.points.A = { x: cx - 100, y: cy + height * 0.15, label: 'A', color: '#1e40af' };
    state.points.B = { x: cx + 100, y: cy + height * 0.15 + 30, label: 'B', color: '#1e40af' };
    
    // ç›´çº¿ L çš„ä½ç½® (ä¸Šæ–¹æ°´å¹³çº¿)ï¼Œä½¿ç”¨ç›¸å¯¹é«˜åº¦é¿å…å‡ºç•Œ
    const lineY = cy - height * 0.25; 
    state.points.C = { x: cx - 180, y: lineY, label: '', color: '#334155' };
    state.points.D = { x: cx + 180, y: lineY, label: 'ç›´çº¿ L', color: '#334155' };
    
    state.step = 0;
    updateUI();
    requestRender();
}

// --- æ ¸å¿ƒäº¤äº’é€»è¾‘ ---

function handleStart(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // å¯»æ‰¾æœ€è¿‘çš„ç‚¹
    let minDist = style.touchRadius;
    let target = null;
    
    for (const key in state.points) {
        const p = state.points[key];
        const d = Math.hypot(p.x - x, p.y - y);
        if (d < minDist) {
            minDist = d;
            target = key;
        }
    }
    
    if (target) {
        state.draggedPointKey = target;
        canvas.style.cursor = 'grabbing';
    }
}

function handleMove(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    if (state.draggedPointKey) {
        state.points[state.draggedPointKey].x = x;
        state.points[state.draggedPointKey].y = y;
        requestRender();
    } else {
        // æ‚¬åœæ•ˆæœ
        let hovering = false;
        for (const key in state.points) {
            const p = state.points[key];
            if (Math.hypot(p.x - x, p.y - y) < style.touchRadius) {
                hovering = true;
            }
        }
        canvas.style.cursor = hovering ? 'grab' : 'crosshair';
    }
}

function handleEnd() {
    state.draggedPointKey = null;
    canvas.style.cursor = 'default';
}

function changeStep(delta) {
    state.step = Math.max(0, Math.min(4, state.step + delta));
    updateUI();
    requestRender();
}

function updateUI() {
    // æ›´æ–°æ­¥éª¤æ–‡å­—é«˜äº®
    document.querySelectorAll('.step-desc').forEach((el, idx) => {
        if (idx === state.step) {
            el.classList.add('step-active', 'text-slate-900');
            el.classList.remove('text-slate-500');
        } else {
            el.classList.remove('step-active', 'text-slate-900');
            el.classList.add('text-slate-500');
        }
    });
    
    document.getElementById('step-indicator').innerText = `${state.step} / 4`;
    
    // è‡ªåŠ¨æ‰“å¼€/å…³é—­æŸäº›å›¾å±‚å¼€å…³ä»¥é…åˆæ­¥éª¤
    if (state.step >= 1) document.getElementById('check-perp-mark').checked = true;
    if (state.step >= 4) document.getElementById('check-measure').checked = true;
}

// --- å‡ ä½•è®¡ç®—ä¸ç»˜å›¾ ---

function requestRender() {
    window.requestAnimationFrame(draw);
}

function draw() {
    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, width, height);
    
    const showGrid = document.getElementById('check-grid').checked;
    const showMeasure = document.getElementById('check-measure').checked;
    const showMarks = document.getElementById('check-perp-mark').checked;
    
    // 1. ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
    if (showGrid) drawGrid();
    
    const A = state.points.A;
    const B = state.points.B;
    const C = state.points.C;
    const D = state.points.D;
    
    // è®¡ç®—ä¸­ç‚¹å’Œè·ç¦»
    const midAB = { x: (A.x + B.x)/2, y: (A.y + B.y)/2 };
    const distAB = Math.hypot(B.x - A.x, B.y - A.y);
    const radius = distAB * 0.7; // ä½œå›¾åŠå¾„
    
    // 2. ç»˜åˆ¶ç›´çº¿ L (æ— é™å»¶ä¼¸) - åŠ ç²—æ˜¾ç¤º
    drawLineExtended(C, D, style.lineColor, style.lineWidth);
    
    // ç»˜åˆ¶æ§åˆ¶ç‚¹ C, D (éšå½¢æˆ–æ·¡è‰²ï¼Œä¸ºäº†æ–¹ä¾¿æ‹–æ‹½)
    drawPoint(C, style.lineColor, 5, false);
    drawPoint(D, style.lineColor, 5, true, '  ç›´çº¿ L'); // å¢åŠ ç©ºæ ¼é¿å…æ–‡å­—é‡å 
    
    // 3. ç»˜åˆ¶çº¿æ®µ AB
    ctx.beginPath();
    ctx.moveTo(A.x, A.y);
    ctx.lineTo(B.x, B.y);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // 4. æ ¹æ®æ­¥éª¤ç»˜åˆ¶
    
    // Step 1: ç”»å¼§çº¿
    if (state.step >= 1) {
        ctx.strokeStyle = style.constructionColor;
        ctx.setLineDash([5, 5]);
        ctx.lineWidth = 1;
        
        // å¼§ A
        ctx.beginPath();
        ctx.arc(A.x, A.y, radius, 0, Math.PI * 2);
        ctx.stroke();
        
        // å¼§ B
        ctx.beginPath();
        ctx.arc(B.x, B.y, radius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    
    // è®¡ç®—å‚ç›´å¹³åˆ†çº¿å‚æ•°
    // æ–œç‡ k_AB = (By - Ay) / (Bx - Ax)
    // å‚ç›´å¹³åˆ†çº¿æ–œç‡ k_perp = -1 / k_AB
    // é€šå¼ Ax + By + C = 0
    // ä¸ºäº†ç¨³å¥æ€§ï¼Œä½¿ç”¨å‘é‡æ³•è®¡ç®—äº¤ç‚¹
    
    // Step 2: å‚ç›´å¹³åˆ†çº¿
    let bisectorP1, bisectorP2;
    // å‘é‡ AB = (dx, dy)
    const dx = B.x - A.x;
    const dy = B.y - A.y;
    // å‚ç›´å‘é‡ (-dy, dx)
    // ä¸­å‚çº¿è¿‡ä¸­ç‚¹ midABï¼Œæ–¹å‘ä¸º (-dy, dx)
    // ä¸ºäº†ç”»çº¿ï¼Œå–è¶³å¤Ÿè¿œçš„ä¸¤ä¸ªç‚¹
    bisectorP1 = { x: midAB.x - dy * 10, y: midAB.y + dx * 10 };
    bisectorP2 = { x: midAB.x + dy * 10, y: midAB.y - dx * 10 };
    
    if (state.step >= 2) {
        drawLineExtended(bisectorP1, bisectorP2, style.bisectorColor, 2, true);
        
        // å‚ç›´ç¬¦å·
        if (showMarks) drawRightAngleMark(midAB, Math.atan2(dy, dx));
        // ç›¸ç­‰ç¬¦å·
        if (showMarks) {
            drawTickMark({x: (A.x+midAB.x)/2, y: (A.y+midAB.y)/2}, Math.atan2(dy, dx));
            drawTickMark({x: (B.x+midAB.x)/2, y: (B.y+midAB.y)/2}, Math.atan2(dy, dx));
        }
    }
    
    // Step 3 & 4: è®¡ç®—äº¤ç‚¹ P
    // ç›´çº¿ L ç”± C, D å®šä¹‰
    // ä¸­å‚çº¿ç”± midAB å’Œ (midAB + (-dy, dx)) å®šä¹‰
    const P = getLineIntersection(C, D, bisectorP1, bisectorP2);
    state.intersectionP = P;
    
    if (state.step >= 3) {
        if (P) {
            // ç»˜åˆ¶ P ç‚¹
            drawPoint(P, style.resultColor, 8, true, 'P');
            
            // æ ‡è®° P ç‚¹åæ ‡æˆ–é«˜äº®
            ctx.beginPath();
            ctx.arc(P.x, P.y, 12, 0, Math.PI * 2);
            ctx.strokeStyle = style.resultColor;
            ctx.lineWidth = 1;
            ctx.stroke();
        } else {
            // å¹³è¡Œæ— è§£æƒ…å†µ
            ctx.fillStyle = 'red';
            ctx.font = '16px sans-serif';
            ctx.fillText('æ— è§£ï¼šç›´çº¿ L ä¸å‚ç›´å¹³åˆ†çº¿å¹³è¡Œ', width/2 - 100, 50);
        }
    }
    
    // Step 4: éªŒè¯è¿çº¿
    if (state.step >= 4 && P) {
        ctx.beginPath();
        ctx.moveTo(P.x, P.y);
        ctx.lineTo(A.x, A.y);
        ctx.moveTo(P.x, P.y);
        ctx.lineTo(B.x, B.y);
        ctx.strokeStyle = style.verifyColor;
        ctx.lineWidth = 2;
        ctx.setLineDash([2, 2]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // æ˜¾ç¤ºè·ç¦»æ–‡æœ¬
        if (showMeasure) {
            const distPA = Math.hypot(P.x - A.x, P.y - A.y).toFixed(0);
            const distPB = Math.hypot(P.x - B.x, P.y - B.y).toFixed(0);
            
            drawLabel(`PA = ${distPA}`, {x: (P.x+A.x)/2, y: (P.y+A.y)/2}, style.verifyColor);
            drawLabel(`PB = ${distPB}`, {x: (P.x+B.x)/2, y: (P.y+B.y)/2}, style.verifyColor);
            
            // æ›´æ–°æ‚¬æµ®çª—
            const tooltip = document.getElementById('status-tooltip');
            tooltip.style.display = 'block';
            tooltip.innerHTML = `PA: <span style="color:${style.verifyColor}">${distPA}</span> | PB: <span style="color:${style.verifyColor}">${distPB}</span>`;
        }
    } else {
        document.getElementById('status-tooltip').style.display = 'none';
    }
    
    // ç»˜åˆ¶å¯æ‹–åŠ¨ç‚¹ (æ”¾åœ¨æœ€ä¸Šå±‚)
    drawPoint(A, A.color, style.pointRadius, true, 'A');
    drawPoint(B, B.color, style.pointRadius, true, 'B');
}

// --- è¾…åŠ©ç»˜å›¾å‡½æ•° ---

function drawGrid() {
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = 1;
    const step = 50;
    
    ctx.beginPath();
    for (let x = 0; x < width; x += step) {
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
    }
    for (let y = 0; y < height; y += step) {
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
    }
    ctx.stroke();
}

function drawPoint(p, color, r, showLabel, labelText) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    if (showLabel) {
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 16px sans-serif';
        const txt = labelText || p.label;
        ctx.fillText(txt, p.x + 12, p.y - 12);
    }
}

function drawLineExtended(p1, p2, color, lineWidth, dashed=false) {
    // ç®€å•çš„ä»å±å¹•è¾¹ç¼˜å»¶ä¼¸ç®—æ³•
    // y - y1 = m(x - x1)
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    
    if (Math.abs(dx) < 0.001) { // å‚ç›´çº¿
        ctx.beginPath();
        ctx.moveTo(p1.x, 0);
        ctx.lineTo(p1.x, height);
    } else {
        const m = dy / dx;
        const b = p1.y - m * p1.x;
        // x = 0, y = b
        // x = width, y = m*width + b
        ctx.beginPath();
        ctx.moveTo(0, b);
        ctx.lineTo(width, m * width + b);
    }
    
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    if (dashed) ctx.setLineDash([8, 6]);
    else ctx.setLineDash([]);
    ctx.stroke();
    ctx.setLineDash([]);
}

function drawLabel(text, p, color) {
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    const w = ctx.measureText(text).width;
    ctx.fillRect(p.x - w/2 - 4, p.y - 10, w + 8, 20);
    ctx.fillStyle = color;
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, p.x, p.y);
    ctx.textAlign = 'start';
    ctx.textBaseline = 'alphabetic';
}

function drawRightAngleMark(center, angle) {
    const size = 10;
    ctx.save();
    ctx.translate(center.x, center.y);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(-size, 0); // å®é™…ä¸Šéœ€è¦æ ¹æ®ä¸­å‚çº¿æ–¹å‘åç§»
    // ç®€å•èµ·è§ï¼Œç”»ä¸€ä¸ªæ–¹æ¡†
    // ä¸­å‚çº¿æ–¹å‘æ˜¯ angle + 90deg
    ctx.moveTo(0, 0);
    ctx.lineTo(size, 0);
    ctx.lineTo(size, size); // å‘ä¸‹
    ctx.lineTo(0, size);
    ctx.strokeStyle = '#64748b';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
}

function drawTickMark(center, angle) {
    const len = 6;
    ctx.save();
    ctx.translate(center.x, center.y);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(0, -len);
    ctx.lineTo(0, len);
    // åŒçº¿
    ctx.moveTo(4, -len);
    ctx.lineTo(4, len);
    ctx.strokeStyle = '#64748b';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
}

// --- æ•°å­¦è®¡ç®—å·¥å…· ---

// è®¡ç®—ä¸¤æ¡ç›´çº¿çš„äº¤ç‚¹ (P1-P2) å’Œ (P3-P4)
function getLineIntersection(p1, p2, p3, p4) {
    const x1 = p1.x, y1 = p1.y;
    const x2 = p2.x, y2 = p2.y;
    const x3 = p3.x, y3 = p3.y;
    const x4 = p4.x, y4 = p4.y;

    const denom = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);
    if (denom === 0) return null; // å¹³è¡Œ

    const ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denom;
    
    return {
        x: x1 + ua * (x2 - x1),
        y: y1 + ua * (y2 - y1)
    };
}

// å¯åŠ¨
init();

</script>
</body>
</html>