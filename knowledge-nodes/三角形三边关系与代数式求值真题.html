<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰è§’å½¢ä¸‰è¾¹å…³ç³»ä¸ä»£æ•°å¼æ±‚å€¼äº’åŠ¨è¯¾ä»¶</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --sidebar-width: 420px;
            --accent-color: #007bff;
            --success-color: #28a745;
            --error-color: #dc3545;
            --text-main: #333;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--primary-bg);
        }

        /* å¸ƒå±€æ§åˆ¶ */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        #canvas-container {
            flex: 1;
            position: relative;
            background: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é¡¶éƒ¨é¢˜ç›®å¡ç‰‡ (v3.1 å¼ºåˆ¶) */
        .problem-card {
            background: #f1f3f5;
            margin: 15px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--accent-color);
        }
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .problem-title {
            font-weight: bold;
            color: #495057;
        }
        .copy-btn {
            background: #fff;
            border: 1px solid #ced4da;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover { background: #e9ecef; }

        /* å†…å®¹æ¿å— */
        .section {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .tab-group {
            display: flex;
            background: #e9ecef;
            margin: 10px 15px;
            border-radius: 6px;
            padding: 3px;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .step-content {
            min-height: 120px;
            background: #fff9db;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px dashed #fab005;
        }

        .control-panel { padding: 10px 0; }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .slider-row input { flex: 1; }
        .slider-row label { width: 40px; font-weight: bold; }

        .verification-panel {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        .status-pass { background: var(--success-color); }
        .status-fail { background: var(--error-color); }

        .formula-box {
            background: #fdfdfe;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            visibility: hidden; /* MathJax æ¸²æŸ“å‰éšè— */
        }

        #status-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <!-- (TOP) é¢˜ç›®åŸé¢˜ -->
    <div class="problem-card">
        <div class="problem-header">
            <span class="problem-title">é¢˜ç›®åŸé¢˜ (å¯å¤åˆ¶)</span>
            <button class="copy-btn" onclick="copyProblem()">å¤åˆ¶é¢˜é¢</button>
        </div>
        <div id="problem-statement-display">
            å·²çŸ¥ \(\triangle ABC\) çš„ä¸‰è¾¹åˆ†åˆ«ä¸º 3, \(a-2\), 7, \(a\) ä¸ºå¶æ•°ï¼Œåˆ™ä»£æ•°å¼ \(4a^2 b^{-3} \cdot (-a^{-1} b^3)\) çš„å€¼ä¸º <span style="border-bottom: 1px solid #333; padding: 0 20px;"></span>ã€‚
        </div>
    </div>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="tab-group">
        <div id="tab-guided" class="tab active" onclick="switchMode('guided')">å¼•å¯¼æ¨¡å¼</div>
        <div id="tab-sandbox" class="tab" onclick="switchMode('sandbox')">é¢˜å¢ƒæ¢ç´¢</div>
        <div id="tab-principles" class="tab" onclick="switchMode('principles')" style="color: var(--accent-color);">åŸç†æ¼”ç¤º</div>
    </div>

    <!-- æ­¥éª¤/æ§åˆ¶åŒº -->
    <div class="section">
        <!-- å¼•å¯¼æ¨¡å¼ -->
        <div id="guided-ui">
            <div id="step-title" style="font-weight: bold; color: var(--accent-color); margin-bottom: 5px;"></div>
            <div id="step-reasoning" class="step-content"></div>
            <div id="step-formula" class="formula-box"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="prevStep()" id="prev-btn" style="flex:1; padding: 8px;">ä¸Šä¸€æ­¥</button>
                <button onclick="nextStep()" id="next-btn" style="flex:1; padding: 8px;">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- é¢˜å¢ƒæ¢ç´¢æ¨¡å¼ -->
        <div id="sandbox-ui" style="display: none;">
            <div class="control-panel">
                <div class="slider-row">
                    <label>a:</label>
                    <input type="range" id="a-slider" min="0" max="20" step="0.1" oninput="updateParamA(this.value)">
                    <span id="a-val" style="width: 30px;">8</span>
                </div>
                <div style="font-size:12px; color:#666; margin-top:5px; line-height:1.4;">
                    å¯¹åº”é¢˜ç›®ä¸­çš„è¾¹ï¼š<br>
                    è¾¹1 = 3<br>
                    è¾¹2 = 7<br>
                    è¾¹3 = a - 2
                </div>
                <button onclick="resetApp()" style="width: 100%; padding: 8px; margin-top: 10px;">é‡ç½®é¢˜ç›®å‚æ•°</button>
            </div>
        </div>

        <!-- åŸç†æ¼”ç¤ºæ¨¡å¼ (æ–°å¢) -->
        <div id="principles-ui" style="display: none;">
            <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 13px; color: #0d47a1;">
                <b>è‡ªç”±å®éªŒå®¤</b>ï¼šæ­¤å¤„è„±ç¦»é¢˜ç›®ï¼Œä»»æ„è°ƒèŠ‚ä¸‰è¾¹é•¿åº¦ï¼Œè§‚å¯Ÿä¸‰è§’å½¢å½¢æˆæ¡ä»¶ã€‚
            </div>
            <div class="control-panel">
                <div class="slider-row">
                    <label style="color:#28a745">åº•(c)</label>
                    <input type="range" oninput="updatePrincipleParam('c', this.value)" min="1" max="15" step="0.1" value="8">
                    <span id="p-c-val">8.0</span>
                </div>
                <div class="slider-row">
                    <label style="color:#007bff">å·¦(a)</label>
                    <input type="range" oninput="updatePrincipleParam('a', this.value)" min="1" max="15" step="0.1" value="4">
                    <span id="p-a-val">4.0</span>
                </div>
                <div class="slider-row">
                    <label style="color:#fd7e14">å³(b)</label>
                    <input type="range" oninput="updatePrincipleParam('b', this.value)" min="1" max="15" step="0.1" value="5">
                    <span id="p-b-val">5.0</span>
                </div>
            </div>
            <div id="principle-feedback" style="margin-top:10px; font-weight:bold; font-size:14px; text-align:center;">
                <!-- åŠ¨æ€åé¦ˆ -->
            </div>
        </div>
    </div>

    <!-- éªŒè¯/è‡ªæ£€é¢æ¿ -->
    <div class="section">
        <div style="font-weight: bold; margin-bottom: 8px;">éªŒè¯ / è‡ªæ£€</div>
        <div id="verification-list" class="verification-panel">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- è§£ç­”æ­¥éª¤ (æŠ˜å ) -->
    <div class="section">
        <details>
            <summary style="cursor: pointer; font-weight: bold; color: #666;">æŸ¥çœ‹å®Œæ•´è§£ç­”æ­¥éª¤</summary>
            <div style="padding-top: 10px; font-size: 14px; line-height: 1.6;">
                1. <b>ç¡®å®šèŒƒå›´</b>ï¼šæ ¹æ®ä¸‰è§’å½¢ä¸‰è¾¹å…³ç³»ï¼Œ\(|7-3| < a-2 < 7+3\)ï¼Œå³ \(4 < a-2 < 10\)ã€‚<br>
                2. <b>è§£ä¸ç­‰å¼</b>ï¼š\(6 < a < 12\)ã€‚<br>
                3. <b>ç¡®å®šæ•°å€¼</b>ï¼šå·²çŸ¥ \(a\) ä¸ºå¶æ•°ï¼Œåˆ™ \(a\) å¯å– 8 æˆ– 10ã€‚<br>
                4. <b>åŒ–ç®€ä»£æ•°å¼</b>ï¼šåŸå¼ = \(-4 \cdot a^{2-1} \cdot b^{-3+3} = -4a\)ã€‚<br>
                5. <b>æ±‚å€¼</b>ï¼š<br>
                å½“ \(a=8\) æ—¶ï¼Œå€¼ä¸º -32ï¼›<br>
                å½“ \(a=10\) æ—¶ï¼Œå€¼ä¸º -40ã€‚<br>
            </div>
        </details>
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½ -->
    <div class="section" style="margin-top: auto;">
        <label style="font-size: 13px; display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="large-font-toggle" onchange="toggleLargeFont()"> å¤§å­—æ¨¡å¼
        </label>
        <div style="font-size: 11px; color: #999; margin-top: 10px;">
            v3.5 | å•æ–‡ä»¶ HTML5 | ä½“éªŒä¼˜åŒ–ï¼š0.1æ­¥é•¿é«˜ç²¾åº¦è°ƒèŠ‚
        </div>
    </div>
</div>

<div id="canvas-container">
    <div id="status-bar">å‡†å¤‡å°±ç»ª</div>
</div>

<script>
/** * v3.1 Logic-First STEM Courseware
 * STATE Management
 */
const STATE = {
    mode: 'guided', // 'guided' | 'sandbox' | 'principles'
    stepIndex: 0,
    params: {
        a: 8, // é¢˜ç›®ä¸­çš„å‚æ•°
        b: 1
    },
    // ç‹¬ç«‹çš„åŸç†æ¼”ç¤ºå‚æ•°
    principles: {
        a: 4, // å·¦è¾¹
        b: 5, // å³è¾¹
        c: 8  // åº•è¾¹
    },
    problem: {
        statementCN: "å·²çŸ¥ \triangle ABC çš„ä¸‰è¾¹åˆ†åˆ«ä¸º 3, a-2, 7, a ä¸ºå¶æ•°ï¼Œåˆ™ä»£æ•°å¼ 4a^2 b^{-3} \cdot (-a^{-1} b^3) çš„å€¼ä¸º_______ã€‚",
        statementTeX: String.raw`å·²çŸ¥ \(\triangle ABC\) çš„ä¸‰è¾¹åˆ†åˆ«ä¸º 3, \(a-2\), 7, \(a\) ä¸ºå¶æ•°ï¼Œåˆ™ä»£æ•°å¼ \(4a^2 b^{-3} \cdot (-a^{-1} b^3)\) çš„å€¼ä¸º_______ã€‚`,
        constraints: ["a æ˜¯å¶æ•°", "èƒ½æ„æˆä¸‰è§’å½¢"]
    },
    expected: null,
    planSteps: []
};

/** * Solve Phase */
function solveProblem() {
    STATE.expected = {
        rangeA: [6, 12],
        possibleA: [8, 10],
        simplifiedForm: "-4a",
        finalValues: [-32, -40]
    };

    STATE.planSteps = [
        {
            titleCN: "ç¬¬ä¸€æ­¥ï¼šæ¼”ç¤ºä¸‰è¾¹å…³ç³»ç»“è®º",
            reasoningCN: "è§‚å¯Ÿå›¾ä¸­è™šçº¿åœ†ä¸ä¸‹æ–¹çº¿æ®µå›¾ã€‚ä¸¤åœ†ç›¸äº¤ï¼ˆå³ä¸¤è¾¹ä¹‹å’Œå¤§äºç¬¬ä¸‰è¾¹ï¼Œä¹‹å·®å°äºç¬¬ä¸‰è¾¹ï¼‰æ‰èƒ½æ„æˆä¸‰è§’å½¢ã€‚æ‹–åŠ¨æ»‘å—ä½“éªŒä½•æ—¶â€œæ–­å¼€â€ã€‚",
            formulasTeX: [String.raw`|7 - 3| < a - 2 < 7 + 3`],
            revealedObjects: ['inequality_range', 'circles'],
            checkItemNameCN: "ä¸‰è§’å½¢æ„æˆæ¡ä»¶"
        },
        {
            titleCN: "ç¬¬äºŒæ­¥ï¼šç¡®å®š a çš„èŒƒå›´",
            reasoningCN: "è§£ä¸ç­‰å¼ 4 < a - 2 < 10ï¼Œå¾—åˆ° a çš„å–å€¼åŒºé—´ã€‚",
            formulasTeX: [String.raw`6 < a < 12`],
            revealedObjects: ['range_visual'],
            checkItemNameCN: "æ•°å€¼èŒƒå›´åˆ¤å®š"
        },
        {
            titleCN: "ç¬¬ä¸‰æ­¥ï¼šç»“åˆå·²çŸ¥æ¡ä»¶",
            reasoningCN: "åœ¨ (6, 12) èŒƒå›´å†…å¯»æ‰¾æ»¡è¶³æ¡ä»¶çš„å¶æ•°ã€‚",
            formulasTeX: [String.raw`a \in \{8, 10\}`],
            revealedObjects: ['even_points'],
            checkItemNameCN: "å¶æ•°æ¡ä»¶"
        },
        {
            titleCN: "ç¬¬å››æ­¥ï¼šä»£æ•°å¼åŒ–ç®€",
            reasoningCN: "åˆ©ç”¨å¹‚çš„è¿ç®—æ€§è´¨ï¼šåŒåº•æ•°å¹‚ç›¸ä¹˜ï¼Œåº•æ•°ä¸å˜ï¼ŒæŒ‡æ•°ç›¸åŠ ã€‚",
            formulasTeX: [String.raw`4a^2 b^{-3} \cdot (-a^{-1} b^3) = -4 a^{2-1} b^{-3+3} = -4a`],
            revealedObjects: ['simplified_formula'],
            checkItemNameCN: "åŒ–ç®€æ­£ç¡®æ€§"
        },
        {
            titleCN: "ç¬¬äº”æ­¥ï¼šä»£å…¥æ±‚å€¼",
            reasoningCN: "å°†ç¡®å®šå‡ºçš„ a å€¼ä»£å…¥åŒ–ç®€åçš„ç»“æœä¸­ã€‚",
            formulasTeX: [String.raw`a=8 \rightarrow -32`, String.raw`a=10 \rightarrow -40`],
            revealedObjects: ['final_result'],
            checkItemNameCN: "ç»“æœæ ¸å¯¹"
        }
    ];
}

/** Verification Phase */
// ç¼“å­˜ä¸Šä¸€æ¬¡çš„åŸç†éªŒè¯HTMLï¼Œé¿å…ä¸å¿…è¦çš„é‡ç»˜
let lastPrinciplesHTML = "";

function verifyAll() {
    if (STATE.mode === 'principles') {
        const { a, b, c } = STATE.principles;
        const sumOK = a + b > c;
        const diffOK = Math.abs(a - b) < c;
        const formTriangle = sumOK && diffOK;
        
        // ç”Ÿæˆå†…å®¹
        const newHTML = `
            <div style="margin-bottom:5px;"><b>åŸç†éªŒè¯ï¼š</b></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
               <span>ä¸¤è¾¹ä¹‹å’Œ (${a.toFixed(1)}+${b.toFixed(1)} > ${c.toFixed(1)})</span>
               <span class="status-badge ${sumOK?'status-pass':'status-fail'}">${sumOK?'æ»¡è¶³':'ä¸æ»¡è¶³'}</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
               <span>ä¸¤è¾¹ä¹‹å·® (|${a.toFixed(1)}-${b.toFixed(1)}| < ${c.toFixed(1)})</span>
               <span class="status-badge ${diffOK?'status-pass':'status-fail'}">${diffOK?'æ»¡è¶³':'ä¸æ»¡è¶³'}</span>
            </div>
             <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-top:1px solid #ddd; padding-top:5px;">
               <span>ç»“è®º</span>
               <span class="status-badge ${formTriangle?'status-pass':'status-fail'}">${formTriangle?'æ„æˆä¸‰è§’å½¢':'æ— æ³•æ„æˆ'}</span>
            </div>
        `;
        
        const container = document.getElementById('verification-list');
        // ç®€å•DOMä¼˜åŒ–ï¼šåªæœ‰å†…å®¹å˜åŒ–æ—¶æ‰æ›´æ–°innerHTML
        if (newHTML !== lastPrinciplesHTML) {
            container.innerHTML = newHTML;
            lastPrinciplesHTML = newHTML;
        }
        
        const feedback = document.getElementById('principle-feedback');
        if (!sumOK) {
            feedback.innerHTML = `<span style="color:red">ä¸¤è¾¹ä¹‹å’Œä¸å¤Ÿ (è¿‡çŸ­)</span>`;
        } else if (!diffOK) {
            feedback.innerHTML = `<span style="color:red">ä¸¤è¾¹ä¹‹å·®å¤ªå¤§ (è¿‡é•¿)</span>`;
        } else {
            feedback.innerHTML = `<span style="color:green">å®Œç¾æ„æˆä¸‰è§’å½¢</span>`;
        }
        return;
    }

    // Default problem verification
    const a = STATE.params.a;
    const s3 = a - 2;
    const isTriangle = (3 + 7 > s3) && (3 + s3 > 7) && (7 + s3 > 3);
    const isEven = a % 2 === 0;

    const items = [
        { nameCN: "ä¸‰è§’å½¢æ„æˆæ¡ä»¶", pass: isTriangle, msg: isTriangle ? "ç¬¦åˆ" : "ä¸‰è¾¹æ— æ³•æˆä¸‰è§’å½¢" },
        { nameCN: "æ•°å€¼èŒƒå›´åˆ¤å®š", pass: (a > 6 && a < 12), msg: (a > 6 && a < 12) ? "åœ¨(6,12)å†…" : "è¶…å‡ºç†è®ºèŒƒå›´" },
        { nameCN: "å¶æ•°æ¡ä»¶", pass: isEven, msg: isEven ? "æ˜¯å¶æ•°" : "å½“å‰éå¶æ•°" },
        { nameCN: "åŒ–ç®€æ­£ç¡®æ€§", pass: true, msg: "ä»£æ•°å¼åŒ–ç®€ä¸º -4a" },
        { nameCN: "ç»“æœæ ¸å¯¹", pass: (a === 8 || a === 10), msg: `ç»“æœä¸º ${-4*a}` }
    ];

    const container = document.getElementById('verification-list');
    container.innerHTML = items.map(item => `
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${item.nameCN}:</span>
            <span class="status-badge ${item.pass ? 'status-pass' : 'status-fail'}">${item.msg}</span>
        </div>
    `).join('');
}

/** P5.js Visualization */
let p5AppInstance;
function initP5() {
    p5AppInstance = new p5(sketch, 'canvas-container');
}

const sketch = (s) => {
    s.setup = () => {
        let canvas = s.createCanvas(s.windowWidth - 420, s.windowHeight);
        s.textAlign(s.CENTER, s.CENTER);
    };

    s.draw = () => {
        s.background(250);
        
        if (STATE.mode === 'principles') {
            drawPrinciples(s);
        } else {
            drawProblem(s);
        }
    };
    
    // --- åŸç†æ¨¡å¼ç»˜åˆ¶ (Enhanced) ---
    function drawPrinciples(s) {
        const { a, b, c } = STATE.principles;
        const scale = 25; // ç¨å¾®ç¼©å°ä¸€ç‚¹æ¯”ä¾‹ä»¥å®¹çº³æ›´å¤šå†…å®¹
        
        // 1. é¡¶éƒ¨ï¼šåœ†è§„ä½œå›¾
        s.push();
        s.translate(s.width/2, s.height/2 - 120);
        
        // è®¾ Cè¾¹ (Base) ä¸­å¿ƒåœ¨åŸç‚¹
        const p1x = -c * scale / 2;
        const p1y = 0;
        const p2x = c * scale / 2;
        const p2y = 0;
        
        let cosA = (c*c + a*a - b*b) / (2 * c * a);
        let valid = Math.abs(cosA) <= 1;
        let p3x, p3y;
        
        // ç»˜åˆ¶è¾…åŠ©åœ†
        s.noFill();
        s.strokeWeight(1);
        s.drawingContext.setLineDash([5, 5]);
        s.stroke(0, 123, 255, 200); // Blue
        s.circle(p1x, p1y, a * scale * 2);
        s.stroke(253, 126, 20, 200); // Orange
        s.circle(p2x, p2y, b * scale * 2);
        s.drawingContext.setLineDash([]);
        
        // Base C
        s.stroke(40, 167, 69); // Green
        s.strokeWeight(4);
        s.line(p1x, p1y, p2x, p2y);
        
        if (valid) {
            let angle = Math.acos(cosA);
            p3x = p1x + Math.cos(angle) * a * scale;
            p3y = p1y - Math.sin(angle) * a * scale;
            s.stroke(0, 123, 255);
            s.line(p1x, p1y, p3x, p3y);
            s.stroke(253, 126, 20);
            s.line(p2x, p2y, p3x, p3y);
            s.noStroke(); s.fill(0); s.circle(p3x, p3y, 5);
        } else {
            // æ— æ³•æ„æˆæ—¶çš„å€’ä¼çº¿
            s.stroke(0, 123, 255);
            s.strokeWeight(4);
            s.line(p1x, p1y, p1x + a * scale, 0);
            s.stroke(253, 126, 20);
            s.line(p2x, p2y, p2x - b * scale, 0);
        }
        
        // æ ‡ç­¾
        s.noStroke(); s.fill(0); s.textSize(16);
        s.text(`c=${c.toFixed(1)}`, 0, 20);
        s.pop();

        // 2. ä¸­éƒ¨ï¼šä¸¤è¾¹ä¹‹å’Œæ¼”ç¤º
        s.push();
        s.translate(s.width/2 - c*scale/2, s.height/2 + 20);
        drawSumVisualization(s, scale, a, b, c);
        s.pop();

        // 3. åº•éƒ¨ï¼šä¸¤è¾¹ä¹‹å·®æ¼”ç¤º (å…¨æ–°ç›´è§‚ç‰ˆ)
        s.push();
        s.translate(s.width/2 - c*scale/2, s.height/2 + 100); // æ”¾åœ¨ä¸‹æ–¹
        drawDiffVisualization(s, scale, a, b, c);
        s.pop();
    }

    function drawSumVisualization(s, scale, a, b, c) {
        // Line 1: a + b
        let y1 = 0;
        s.stroke(0, 123, 255); s.strokeWeight(4);
        s.line(0, y1, a*scale, y1);
        s.stroke(253, 126, 20);
        s.line(a*scale, y1, (a+b)*scale, y1);
        
        // Line 2: c
        let y2 = 25;
        s.stroke(40, 167, 69);
        s.line(0, y2, c*scale, y2);

        // Labels
        s.noStroke(); s.fill(100); s.textSize(12); s.textAlign(s.RIGHT);
        s.text("ä¸¤è¾¹ä¹‹å’Œ:", -10, y1+5);
        s.text("ç¬¬ä¸‰è¾¹ c:", -10, y2+5);

        // Result
        let total = a + b;
        let ok = total > c;
        s.textAlign(s.LEFT);
        s.fill(ok ? varColor('--success-color') : varColor('--error-color'));
        s.text(ok ? `âœ… ${total.toFixed(1)} > ${c.toFixed(1)}` : `âŒ ${total.toFixed(1)} <= ${c.toFixed(1)}`, Math.max(total, c)*scale + 10, y1 + 15);
    }

    function drawDiffVisualization(s, scale, a, b, c) {
        // é€»è¾‘ï¼šç”»å‡ºè¾ƒé•¿è¾¹ï¼Œç„¶åæŠŠè¾ƒçŸ­è¾¹å ä¸Šå»ï¼Œç©ºå‡ºçš„å°±æ˜¯â€œå·®â€ã€‚ç„¶åæŠŠcå’Œè¿™ä¸ªâ€œå·®â€æ¯”ã€‚
        const maxS = Math.max(a, b);
        const minS = Math.min(a, b);
        const diff = maxS - minS;

        // Line 1: é•¿è¾¹ (åº•è‰²)
        let y1 = 0;
        let cLong = (a >= b) ? [0, 123, 255] : [253, 126, 20];
        s.stroke(cLong); s.strokeWeight(4);
        s.line(0, y1, maxS*scale, y1);

        // Line 1 Overlay: çŸ­è¾¹ (è¦†ç›–åœ¨å·¦ä¾§)
        let cShort = (a >= b) ? [253, 126, 20] : [0, 123, 255];
        s.stroke(cShort);
        s.line(0, y1, minS*scale, y1);

        // æ ‡æ³¨ "å·®" çš„éƒ¨åˆ† (è™šçº¿æ¡† + æ–‡å­—)
        s.stroke(100); s.strokeWeight(1);
        s.drawingContext.setLineDash([3, 3]);
        // ç”»ä¸€ä¸ªæ‹¬å·æˆ–è€…æ ‡è®°
        let diffStartX = minS * scale;
        let diffEndX = maxS * scale;
        // ä¸Šæ–¹è¿çº¿
        s.line(diffStartX, y1 - 8, diffEndX, y1 - 8);
        s.line(diffStartX, y1 - 8, diffStartX, y1);
        s.line(diffEndX, y1 - 8, diffEndX, y1);
        s.drawingContext.setLineDash([]);
        
        s.noStroke(); s.fill(100); s.textSize(12); s.textAlign(s.CENTER);
        s.text(`å·® (${diff.toFixed(1)})`, (diffStartX + diffEndX)/2, y1 - 12);

        // Line 2: c (æ”¾åœ¨å·®çš„ä¸‹æ–¹ï¼Œèµ·ç‚¹å¯¹é½å·®çš„èµ·ç‚¹ï¼Œç›´è§‚å¯¹æ¯”)
        let y2 = 25;
        
        // å…³é”®è§†è§‰å‡çº§ï¼šæŠŠ c æ”¾åœ¨å·®å€¼åŒºé—´ä¸‹æ–¹
        // å¦‚æœ c æ¯”å·®å€¼å¤§ï¼Œå®ƒä¼šâ€œè¶…å‡ºâ€å·®å€¼åŒºé—´ï¼Œè¿™æ˜¯å¥½çš„ (diff < c)
        // å¦‚æœ c æ¯”å·®å€¼å°ï¼Œå®ƒä¼šâ€œæ‰è¿›â€å·®å€¼åŒºé—´ï¼Œè¿™æ˜¯åçš„ (diff > c)
        
        s.stroke(40, 167, 69); s.strokeWeight(4);
        // èµ·ç‚¹ä¸ Difference çš„èµ·ç‚¹å¯¹é½
        s.line(diffStartX, y2, diffStartX + c*scale, y2);
        
        // Labels
        s.noStroke(); s.fill(100); s.textAlign(s.RIGHT);
        s.text("ä¸¤è¾¹é‡å :", -10, y1+5);
        s.text("ç¬¬ä¸‰è¾¹ c:", -10, y2+5); // ç¨å¾®ä¸å‡†ç¡®ï¼Œä¸ºäº†å¸ƒå±€å¯¹é½

        // Result
        let ok = diff < c;
        let endX = Math.max(diffEndX, diffStartX + c*scale);
        s.textAlign(s.LEFT);
        s.fill(ok ? varColor('--success-color') : varColor('--error-color'));
        s.text(ok ? `âœ… å·® < c` : `âŒ å·® >= c`, endX + 10, y2 + 5);
        
        // è¾…åŠ©çº¿è¿æ¥ c å’Œ å·®
        s.stroke(200); s.strokeWeight(1);
        s.drawingContext.setLineDash([2, 2]);
        s.line(diffStartX, y1, diffStartX, y2); // èµ·ç‚¹å¯¹é½çº¿
        s.drawingContext.setLineDash([]);
    }

    // --- é¢˜ç›®æ¨¡å¼ç»˜åˆ¶ (Original) ---
    function drawProblem(s) {
        s.push();
        s.translate(s.width/2 - 100, s.height/2 - 50);
        
        const scale = 30;
        const side1 = 3 * scale;
        const side2 = 7 * scale;
        const aVal = STATE.params.a;
        const side3 = (aVal - 2) * scale;

        let Ax = 0, Ay = 0;
        let Bx = side2, By = 0;
        
        let Cx, Cy;
        let cosA = (side2*side2 + side1*side1 - side3*side3) / (2 * side2 * side1);
        let canForm = Math.abs(cosA) <= 1;

        // è¾…åŠ©åœ†
        s.noFill();
        s.drawingContext.setLineDash([5, 5]);
        s.stroke(50, 150, 250, 200); 
        s.circle(Ax, Ay, side1 * 2);
        s.stroke(255, 165, 0, 200); 
        s.circle(Bx, By, side3 * 2);
        s.drawingContext.setLineDash([]);

        s.strokeWeight(2);
        
        // ç»˜åˆ¶
        s.stroke(200);
        if (canForm) {
            let angle = Math.acos(cosA);
            Cx = Math.cos(angle) * side1;
            Cy = -s.abs(Math.sin(angle) * side1);
            s.stroke(50, 150, 250);
            s.line(Ax, Ay, Cx, Cy);
            s.line(Bx, By, Cx, Cy);
            s.noStroke(); s.fill(0); s.text("C", Cx, Cy - 15);
        } else {
            s.stroke(varColor('--error-color'));
            s.drawingContext.setLineDash([5, 5]);
            s.stroke(50, 150, 250);
            s.line(Ax, Ay, side1, 0); 
            s.stroke(255, 165, 0);
            s.line(Bx, By, Bx - side3, 0); 
            s.drawingContext.setLineDash([]);
            
            s.fill(varColor('--error-color'));
            s.noStroke();
            let msg = (side1 + side3 < side2) ? "å¤Ÿä¸ç€ (å’Œ < ç¬¬ä¸‰è¾¹)" : "åŒ…å«äº† (å·® > ç¬¬ä¸‰è¾¹)";
            s.text(msg, (Bx - side1)/2, -40);
        }

        s.stroke(100); s.strokeWeight(2);
        s.line(Ax, Ay, Bx, By);

        // æ ‡ç­¾
        s.noStroke(); s.fill(50); s.textSize(STATE.largeFont ? 20 : 16);
        s.text("7", (Ax + Bx)/2, 20);
        s.fill(50, 100, 200);
        if (canForm) {
            s.text("3", (Ax + Cx)/2 - 15, (Ay + Cy)/2);
            s.fill(200, 100, 0);
            s.text(`a-2 (${(aVal-2).toFixed(1)})`, (Bx + Cx)/2 + 40, (By + Cy)/2 - 10);
        } else {
            s.text("3", side1/2, -15);
            s.fill(200, 100, 0);
            s.text(`a-2 (${(aVal-2).toFixed(1)})`, Bx - side3/2, -15);
        }

        s.fill(0); s.text("A", Ax - 15, Ay); s.text("B", Bx + 15, By);
        s.pop();

        // é¢˜ç›®æ¨¡å¼ä¸‹æ–¹çš„å¯¹æ¯”æ¡
        drawInequalityBar(s, scale, aVal);
        drawUIOverlay(s);
    }

    function drawInequalityBar(s, scale, aVal) {
        s.push();
        s.translate(s.width/2 - 100, s.height/2 + 150);

        const L_base = 7 * scale;
        const L_side1 = 3 * scale;
        const L_side3 = (aVal - 2) * scale;
        
        s.noStroke(); s.fill(100); s.textAlign(s.LEFT); s.textSize(12);
        s.text("åŸºå‡†è¾¹ (7):", -80, 5);
        
        s.stroke(80); s.strokeWeight(4);
        s.line(0, 0, L_base, 0);
        
        s.noStroke(); s.fill(100); s.text(`ä¸¤è¾¹ä¹‹å’Œ:`, -80, 35);

        let yOffset = 30;
        s.stroke(50, 150, 250);
        s.line(0, yOffset, L_side1, yOffset);
        s.stroke(255, 165, 0);
        s.line(L_side1, yOffset, L_side1 + L_side3, yOffset);

        let sumLen = L_side1 + L_side3;
        s.noStroke();
        if (sumLen > L_base) {
            if (L_side3 > L_base + L_side1) {
                 s.fill(varColor('--error-color')); s.text(`âŒ å¤ªé•¿!`, sumLen + 10, yOffset + 5);
            } else {
                 s.fill(varColor('--success-color')); s.text("âœ… > 7", sumLen + 10, yOffset + 5);
            }
        } else {
            s.fill(varColor('--error-color')); s.text("âŒ < 7", sumLen + 10, yOffset + 5);
        }
        s.pop();
    }

    function drawUIOverlay(s) {
        s.resetMatrix();
        s.fill(240, 240, 240, 200);
        s.rect(20, 20, 250, 100, 10);
        s.fill(0);
        s.textSize(14);
        s.textAlign(s.LEFT);
        s.text(`å½“å‰ a = ${STATE.params.a.toFixed(1)}`, 30, 45);
        s.text(`ä¸‰è¾¹: [3, 7, ${(STATE.params.a - 2).toFixed(1)}]`, 30, 70);
        let msg = (STATE.params.a > 6 && STATE.params.a < 12) ? "âœ… æ„æˆä¸‰è§’å½¢" : "âŒ æ— æ³•æ„æˆ";
        s.text(msg, 30, 95);
    }
    
    function varColor(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
};

/** UI Actions */
function switchMode(mode) {
    STATE.mode = mode;
    ['guided', 'sandbox', 'principles'].forEach(m => {
        document.getElementById(`tab-${m}`).className = (mode === m) ? 'tab active' : 'tab';
        document.getElementById(`${m}-ui`).style.display = (mode === m) ? 'block' : 'none';
    });
    updateUI();
}

function updateParamA(val) {
    STATE.params.a = parseFloat(val);
    document.getElementById('a-val').innerText = parseFloat(val).toFixed(1); // ç»Ÿä¸€ä¿ç•™1ä½
    document.getElementById('a-slider').value = val;
    recompute();
}

function updatePrincipleParam(key, val) {
    STATE.principles[key] = parseFloat(val);
    document.getElementById(`p-${key}-val`).innerText = parseFloat(val).toFixed(1); // ç»Ÿä¸€ä¿ç•™1ä½
    recompute();
}

function nextStep() {
    if (STATE.stepIndex < STATE.planSteps.length - 1) {
        STATE.stepIndex++;
        if (STATE.stepIndex === 2) updateParamA(8); 
        updateUI();
    }
}

function prevStep() {
    if (STATE.stepIndex > 0) {
        STATE.stepIndex--;
        updateUI();
    }
}

async function updateUI() {
    recompute();
    if (STATE.mode !== 'guided') return;
    
    const step = STATE.planSteps[STATE.stepIndex];
    document.getElementById('step-title').innerText = step.titleCN;
    document.getElementById('step-reasoning').innerText = step.reasoningCN;
    
    const formulaEl = document.getElementById('step-formula');
    formulaEl.style.visibility = 'hidden';
    const tex = step.formulasTeX.map(f => `\\[ ${f} \\]`).join('');
    formulaEl.innerHTML = tex;
    
    document.getElementById('prev-btn').disabled = (STATE.stepIndex === 0);
    document.getElementById('next-btn').disabled = (STATE.stepIndex === STATE.planSteps.length - 1);

    await MathJax.typesetPromise([formulaEl]);
    formulaEl.style.visibility = 'visible';
}

function recompute() {
    verifyAll();
    const status = document.getElementById('status-bar');
    if (STATE.mode === 'principles') {
        status.innerText = "ğŸ§ª åŸç†æ¼”ç¤ºæ¨¡å¼ - è‡ªç”±è°ƒèŠ‚ä¸‰è¾¹";
        status.style.color = "#007bff";
    } else {
        const a = STATE.params.a;
        if (a < 6 || a > 12) {
            status.innerText = "âš ï¸ é¢˜ç›®æ¨¡å¼ï¼šä¸‰è¾¹å…³ç³»ä¸æˆç«‹";
            status.style.color = "red";
        } else {
            status.innerText = "âœ… é¢˜ç›®æ¨¡å¼ï¼šæ¡ä»¶æ»¡è¶³";
            status.style.color = "green";
        }
    }
}

function resetApp() {
    updateParamA(8);
    STATE.stepIndex = 0;
    STATE.principles = { a: 4, b: 5, c: 8 };
    ['a', 'b', 'c'].forEach(k => {
        const el = document.querySelector(`input[oninput="updatePrincipleParam('${k}', this.value)"]`);
        if(el) {
            el.value = STATE.principles[k];
            document.getElementById(`p-${k}-val`).innerText = STATE.principles[k].toFixed(1);
        }
    });
    switchMode('guided');
}

function toggleLargeFont() {
    STATE.largeFont = document.getElementById('large-font-toggle').checked;
    document.body.style.fontSize = STATE.largeFont ? '18px' : '14px';
}

function copyProblem() {
    const text = STATE.problem.statementCN;
    const dummy = document.createElement("textarea");
    document.body.appendChild(dummy);
    dummy.value = text;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
    
    const btn = document.querySelector('.copy-btn');
    const old = btn.innerText;
    btn.innerText = "å·²å¤åˆ¶ï¼";
    setTimeout(() => btn.innerText = old, 2000);
}

window.onload = () => {
    solveProblem();
    initP5();
    updateUI();
};
</script>

</body>
</html>