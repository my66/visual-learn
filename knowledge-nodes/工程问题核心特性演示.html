<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥ç¨‹é—®é¢˜æ ¸å¿ƒç‰¹æ€§æ¼”ç¤º</title>
  
  <!-- p5.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- MathJax CDN -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --bg-color: #f5f7fa;
      --panel-bg: #ffffff;
      --primary: #4CAF50;    /* Team A Green */
      --accent: #2196F3;     /* Team B Blue */
      --mixed: #00BCD4;      /* Coop Mixed */
      --warning: #FF9800;    /* Highlight */
      --text: #37474f;
      --border: #eceff1;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: var(--bg-color);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    header {
      background: #fff;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-shrink: 0;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-switch {
      display: flex;
      background: #eee;
      padding: 3px;
      border-radius: 6px;
    }

    .mode-btn {
      padding: 6px 15px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #666;
    }

    .mode-btn.active {
      background: #fff;
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Main Layout */
    .container {
      display: flex;
      flex: 1;
      padding: 20px;
      gap: 20px;
      overflow: hidden;
    }

    /* Controls */
    .controls {
      width: 320px;
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .control-group {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .control-group h3 {
      font-size: 14px;
      color: #78909c;
      margin: 0 0 10px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    label {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text);
    }

    .val {
      font-family: "Menlo", monospace;
      color: #555;
    }

    input[type=range] {
      width: 100%;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .btn-action {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 5px;
      transition: opacity 0.2s;
    }
    .btn-play { background: var(--text); color: white; }
    .btn-reset { background: #e0e0e0; color: #333; margin-top: 10px; }
    .btn-action:hover { opacity: 0.9; }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Visual */
    .visual-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow: hidden;
    }

    .canvas-wrapper {
      flex: 2;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }

    .math-wrapper {
      flex: 1;
      min-height: 180px; /* Taller for detailed formulas */
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .math-box {
      font-size: 16px;
      background: #fafafa;
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: 4px;
      visibility: hidden;
    }

    .legend {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #666;
    }
    .legend span { display: flex; align-items: center; gap: 5px; }
    .dot { width: 10px; height: 10px; border-radius: 2px; }

    .hidden { display: none !important; }

    @media (max-width: 800px) {
      .container { flex-direction: column; overflow-y: auto; }
      .controls { width: 100%; }
      .canvas-wrapper { min-height: 300px; }
    }
  </style>
</head>
<body>

  <header>
    <h1>ğŸ—ï¸ å·¥ç¨‹é—®é¢˜æ¼”ç¤º</h1>
    <div class="mode-switch">
      <button class="mode-btn active" id="btn-mode-basic" onclick="setMode('basic')">åŸºç¡€åˆä½œ</button>
      <button class="mode-btn" id="btn-mode-step" onclick="setMode('step')">å…ˆç”²ååˆ (åˆ†æ®µ)</button>
    </div>
  </header>

  <div class="container">
    <div class="controls">
      
      <!-- Efficiency Settings -->
      <div class="control-group">
        <h3>å·¥ä½œæ•ˆç‡è®¾å®š</h3>
        <label>
          <span style="color:var(--primary)">ç”²å•ç‹¬å®Œæˆéœ€ \(T_ç”²\)</span>
          <span class="val" id="val-tA">10å¤©</span>
        </label>
        <input type="range" id="inp-tA" min="5" max="30" step="1" value="10">
        <div style="font-size:11px; color:#999; margin-bottom:10px;">
          ç”²æ•ˆç‡ \( = \frac{1}{T_ç”²} = \)<span id="eff-A">1/10</span>
        </div>

        <label>
          <span style="color:var(--accent)">ä¹™å•ç‹¬å®Œæˆéœ€ \(T_ä¹™\)</span>
          <span class="val" id="val-tB">15å¤©</span>
        </label>
        <input type="range" id="inp-tB" min="5" max="30" step="1" value="15">
        <div style="font-size:11px; color:#999;">
          ä¹™æ•ˆç‡ \( = \frac{1}{T_ä¹™} = \)<span id="eff-B">1/15</span>
        </div>
      </div>

      <!-- Step Mode Specific -->
      <div class="control-group hidden" id="group-step">
        <h3>å·¥ç¨‹å®‰æ’ (åˆ†æ®µ)</h3>
        <label>
          ç”²å…ˆåšå¤©æ•° \(t_1\)
          <span class="val" id="val-tPre">4å¤©</span>
        </label>
        <input type="range" id="inp-tPre" min="0" max="15" step="1" value="4">
      </div>

      <button class="btn-action btn-play" id="btn-play">å¼€å§‹æ–½å·¥</button>
      <button class="btn-action btn-reset" id="btn-reset">é‡ç½®å·¥ç¨‹</button>
      
      <div style="margin-top:15px; font-size:12px; color:#666; line-height:1.5;">
        <span id="desc-text">è§‚å¯Ÿï¼šç”²ä¹™åˆä½œæ—¶ï¼Œæ€»æ•ˆç‡æ˜¯ä¸¤è€…ä¹‹å’Œï¼Œå·¥æœŸæ˜æ˜¾ç¼©çŸ­ã€‚</span>
      </div>
    </div>

    <div class="visual-area">
      <div class="canvas-wrapper" id="p5-container"></div>
      
      <div class="math-wrapper">
        <div class="legend">
          <span><div class="dot" style="background:var(--primary)"></div> ç”²åšéƒ¨åˆ†</span>
          <span><div class="dot" style="background:var(--accent)"></div> ä¹™åšéƒ¨åˆ†</span>
          <span><div class="dot" style="border:1px solid #ccc; background:none;"></div> å·¥ç¨‹æ€»é‡ "1"</span>
        </div>
        <div id="math-box" class="math-box"></div>
      </div>
    </div>
  </div>

<script>
/**
 * Config
 */
const STYLE_CONFIG = {
  bg: 255,
  trackBg: 240,
  colorA: '#4CAF50',
  colorB: '#2196F3',
  colorCoop: '#00BCD4',
  text: 50
};

/**
 * State
 */
let mode = 'basic'; // 'basic' | 'step'
let state = {
  TA: 10,  // Days for A solo
  TB: 15,  // Days for B solo
  tPre: 4, // Days A works before B joins (Step mode)
  
  // Animation
  daysPassed: 0,
  isPlaying: false,
  isFinished: false,
  
  // Computed
  workA: 0, // Work done by A row
  workB: 0, // Work done by B row
  workC: 0, // Work done by Coop row
  
  finishTimeA: 0,
  finishTimeB: 0,
  finishTimeC: 0
};

// DOM
const dom = {};

function setup() {
  const container = document.getElementById('p5-container');
  const canvas = createCanvas(container.clientWidth, container.clientHeight);
  canvas.parent('p5-container');

  // Inputs
  dom.inpTA = document.getElementById('inp-tA');
  dom.inpTB = document.getElementById('inp-tB');
  dom.inpTPre = document.getElementById('inp-tPre');
  
  // Displays
  dom.valTA = document.getElementById('val-tA');
  dom.valTB = document.getElementById('val-tB');
  dom.effA = document.getElementById('eff-A');
  dom.effB = document.getElementById('eff-B');
  dom.valTPre = document.getElementById('val-tPre');
  dom.desc = document.getElementById('desc-text');
  
  // Logic
  dom.groupStep = document.getElementById('group-step');
  dom.btnPlay = document.getElementById('btn-play');
  dom.btnReset = document.getElementById('btn-reset');
  dom.mathBox = document.getElementById('math-box');

  // Listeners
  [dom.inpTA, dom.inpTB, dom.inpTPre].forEach(el => el.addEventListener('input', updateParams));
  
  dom.btnPlay.addEventListener('click', togglePlay);
  dom.btnReset.addEventListener('click', resetSim);
  
  window.addEventListener('resize', () => {
    resizeCanvas(container.clientWidth, container.clientHeight);
    redraw();
  });

  updateParams();
}

/**
 * Mode Switch
 */
window.setMode = function(m) {
  mode = m;
  document.getElementById('btn-mode-basic').className = m==='basic'?'mode-btn active':'mode-btn';
  document.getElementById('btn-mode-step').className = m==='step'?'mode-btn active':'mode-btn';
  
  if (m === 'basic') {
    dom.groupStep.classList.add('hidden');
    dom.desc.innerText = "è§‚å¯Ÿï¼šç”²ä¹™åˆä½œæ—¶ï¼Œè¿›åº¦æ¡æ˜¯ä¸¤äººæ•ˆç‡çš„å åŠ ã€‚";
  } else {
    dom.groupStep.classList.remove('hidden');
    dom.desc.innerText = "è§‚å¯Ÿï¼šç”²å…ˆåšä¸€æ®µæ—¶é—´ï¼Œè¿›åº¦æ¡ä»…ç”±ç”²å¢é•¿ï¼›ä¹™åŠ å…¥åï¼Œå¢é•¿é€Ÿåº¦å˜å¿«ã€‚";
  }
  
  resetSim();
  updateParams();
};

function updateParams() {
  state.TA = parseInt(dom.inpTA.value);
  state.TB = parseInt(dom.inpTB.value);
  state.tPre = parseInt(dom.inpTPre.value);
  
  // UI Updates
  dom.valTA.innerText = state.TA + "å¤©";
  dom.valTB.innerText = state.TB + "å¤©";
  dom.effA.innerText = `1/${state.TA}`;
  dom.effB.innerText = `1/${state.TB}`;
  
  dom.inpTPre.max = state.TA - 1; // logical constraint
  dom.valTPre.innerText = state.tPre + "å¤©";

  // Pre-calculate Finish Times
  state.finishTimeA = state.TA;
  state.finishTimeB = state.TB;
  
  if (mode === 'basic') {
    // 1 / (1/TA + 1/TB)
    const effSum = (1/state.TA) + (1/state.TB);
    state.finishTimeC = 1 / effSum;
  } else {
    // Work done in tPre is (tPre/TA)
    // Remaining work is 1 - (tPre/TA)
    // Remaining time = RemWork / (1/TA + 1/TB)
    const wDone = state.tPre / state.TA;
    if (wDone >= 1) {
      state.finishTimeC = state.TA; // A finishes before B joins
    } else {
      const remW = 1 - wDone;
      const effSum = (1/state.TA) + (1/state.TB);
      state.finishTimeC = state.tPre + (remW / effSum);
    }
  }

  updateMath();
  if (!state.isPlaying) redraw();
}

function draw() {
  background(STYLE_CONFIG.bg);
  
  const marginX = 60;
  const barH = 30;
  const gap = 50;
  const w = width - marginX * 2;
  const startY = height * 0.25;

  // --- Animation Logic ---
  if (state.isPlaying && !state.isFinished) {
    const dt = 0.05; // Simulation speed (days per frame)
    state.daysPassed += dt;
    
    // Track A (Solo)
    if (state.workA < 1) state.workA = state.daysPassed / state.TA;
    
    // Track B (Solo)
    if (state.workB < 1) state.workB = state.daysPassed / state.TB;
    
    // Track C (Scenario)
    if (state.workC < 1) {
      let currentEff = 0;
      if (mode === 'basic') {
        currentEff = (1/state.TA) + (1/state.TB);
      } else {
        // Step Mode
        if (state.daysPassed <= state.tPre) {
          currentEff = 1/state.TA; // A only
        } else {
          currentEff = (1/state.TA) + (1/state.TB); // A + B
        }
      }
      // Increment work directly
      state.workC += currentEff * dt;
    }

    // Clamp
    if (state.workA > 1) state.workA = 1;
    if (state.workB > 1) state.workB = 1;
    if (state.workC > 1) state.workC = 1;
    
    // Finish check
    // We stop when the SCENARIO track (C) is done, usually fastest
    if (state.workC >= 1) {
      state.isFinished = true;
      state.isPlaying = false;
      dom.btnPlay.innerText = "å·¥ç¨‹ç»“æŸ";
      dom.btnPlay.disabled = true;
    }
  }

  // --- Drawing ---

  // Row 1: A Solo
  drawProjectRow(startY, w, state.workA, "ç”²å•ç‹¬", STYLE_CONFIG.colorA, state.TA);
  
  // Row 2: B Solo
  drawProjectRow(startY + gap + barH, w, state.workB, "ä¹™å•ç‹¬", STYLE_CONFIG.colorB, state.TB);
  
  // Row 3: Scenario
  let labelC = mode === 'basic' ? "ç”²ä¹™åˆä½œ" : "æ··åˆæ–½å·¥";
  drawProjectRow(startY + (gap + barH)*2, w, state.workC, labelC, "#666", state.finishTimeC, true);

  // Time Marker (Vertical Line)
  drawTimeMarker(state.daysPassed, w, marginX);
}

/**
 * Draw a single project track
 */
function drawProjectRow(y, w, progress, label, color, totalTime, isComposite=false) {
  const x = 60;
  
  // Label
  noStroke();
  fill(80);
  textSize(14);
  textAlign(RIGHT, CENTER);
  text(label, x - 15, y + 15);

  // Empty Container (The "1")
  stroke(200);
  strokeWeight(2);
  noFill();
  rect(x, y, w, 30, 4);
  
  // Fill
  noStroke();
  if (!isComposite) {
    // Simple Fill
    fill(color);
    rect(x, y, w * progress, 30, 4);
  } else {
    if (mode === 'basic') {
       // Basic: Ratio is constant.
       let effA = 1/state.TA;
       let effB = 1/state.TB;
       let totalEff = effA + effB;
       let hA = 30 * (effA / totalEff);
       let hB = 30 * (effB / totalEff);
       
       fill(STYLE_CONFIG.colorA);
       rect(x, y, w * progress, hA, 4, 4, 0, 0);
       fill(STYLE_CONFIG.colorB);
       rect(x, y + hA, w * progress, hB, 0, 0, 4, 4);
    } else {
      // Step Mode
      let wStep = state.tPre / state.TA; // Work done at step point
      let pA = Math.min(progress, wStep);
      
      // Segment 1: Only A
      fill(STYLE_CONFIG.colorA);
      rect(x, y, w * pA, 30, 4, (progress>wStep?0:4), (progress>wStep?0:4), 4);
      
      // Segment 2: Coop
      if (progress > wStep) {
        let pRem = progress - wStep;
        let startX = x + w * wStep;
        let widthRem = w * pRem;
        
        let effA = 1/state.TA;
        let effB = 1/state.TB;
        let totalEff = effA + effB;
        let hA = 30 * (effA / totalEff);
        let hB = 30 * (effB / totalEff);
        
        fill(STYLE_CONFIG.colorA);
        rect(startX, y, widthRem, hA, 0, 4, 0, 0);
        fill(STYLE_CONFIG.colorB);
        rect(startX, y+hA, widthRem, hB, 0, 0, 4, 0);
        
        // Draw step marker
        stroke(255);
        strokeWeight(2);
        line(startX, y, startX, y+30);
      }
    }
  }
  
  // 100% Marker text
  if (progress >= 1) {
    fill(50);
    noStroke();
    textSize(12);
    textAlign(LEFT, CENTER);
    text(`å®Œæˆ! ç”¨æ—¶ ${totalTime.toFixed(1)}å¤©`, x + w + 10, y + 15);
  }
}

function drawTimeMarker(days, w, marginX) {
  fill(50);
  textSize(24);
  textAlign(CENTER, TOP);
  text(`ç¬¬ ${days.toFixed(1)} å¤©`, width/2, 20);
}

async function updateMath() {
  let tex = "";
  
  if (mode === 'basic') {
    // Basic Mode: Sum of efficiencies
    const rateA = `\\frac{1}{${state.TA}}`;
    const rateB = `\\frac{1}{${state.TB}}`;
    const tVal = state.finishTimeC.toFixed(2);
    
    tex = String.raw`
      \begin{aligned}
      & \text{æ€»æ•ˆç‡} = \underbrace{${rateA}}_{ç”²} + \underbrace{${rateB}}_{ä¹™} = \frac{${state.TA+state.TB}}{${state.TA*state.TB}} \\
      & \text{åˆä½œå·¥æœŸ} = 1 \div \text{æ€»æ•ˆç‡} \approx ${tVal} \text{ (å¤©)}
      \end{aligned}
    `;
  } else {
    // Step Mode: Detailed Equation
    const rateSum = `(\\frac{1}{${state.TA}} + \\frac{1}{${state.TB}})`;
    const step1Work = `\\frac{${state.tPre}}{${state.TA}}`;
    const remWorkCalc = (1 - state.tPre/state.TA).toFixed(2);
    const coopDays = (state.finishTimeC - state.tPre).toFixed(2);
    const totalDays = state.finishTimeC.toFixed(2);
    
    tex = String.raw`
      \begin{aligned}
      & \textbf{è®¾åˆä½œéœ€ } x \textbf{ å¤©å®Œæˆå‰©ä½™éƒ¨åˆ†ï¼š} \\
      & \underbrace{ \frac{${state.tPre}}{${state.TA}} }_{\text{ç”²å…ˆåšå·¥ä½œé‡}} + \underbrace{ ${rateSum} \times x }_{\text{åˆä½œå·¥ä½œé‡}} = 1 \\
      & \Rightarrow x = (1 - ${step1Work}) \div ${rateSum} \approx ${coopDays} \\
      & \textbf{æ€»å·¥æœŸ} = ${state.tPre} + ${coopDays} = ${totalDays} \text{ (å¤©)}
      \end{aligned}
    `;
  }

  dom.mathBox.style.visibility = 'hidden';
  dom.mathBox.innerHTML = `\\[ ${tex} \\]`;
  await MathJax.typesetPromise([dom.mathBox]);
  dom.mathBox.style.visibility = 'visible';
}

function togglePlay() {
  if (state.isFinished) return;
  state.isPlaying = !state.isPlaying;
  dom.btnPlay.innerText = state.isPlaying ? "æš‚åœæ–½å·¥" : "ç»§ç»­æ–½å·¥";
}

function resetSim() {
  state.daysPassed = 0;
  state.workA = 0;
  state.workB = 0;
  state.workC = 0;
  state.isPlaying = false;
  state.isFinished = false;
  dom.btnPlay.innerText = "å¼€å§‹æ–½å·¥";
  dom.btnPlay.disabled = false;
  redraw();
}

</script>
</body>
</html>