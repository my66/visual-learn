<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰æ³¢åŸºç¡€æ¼”ç¤ºï¼šæ³¢é•¿ã€é€Ÿåº¦ä¸æŒ¯å¹…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --panel-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #3b82f6;
            --border-color: #e5e7eb;
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
        }

        h1 {
            color: #1e293b;
            margin-bottom: 5px;
            text-align: center;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 0.9em;
            max-width: 800px;
            text-align: center;
        }

        /* ä¸»å®¹å™¨ï¼šFlexå¸ƒå±€ï¼Œæ”¹ä¸ºä¸Šä¸‹æ’åˆ— (Column) */
        .main-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1200px; /* ç¨å¾®æ”¶çª„ä¸€ç‚¹ï¼Œé€‚åˆé˜…è¯» */
            align-items: center;
        }

        /* é¡¶éƒ¨ï¼šæ§åˆ¶é¢æ¿ - æ”¹ä¸ºæ¨ªå‘æ’åˆ—å†…éƒ¨å…ƒç´  */
        .controls {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%; /* å æ»¡å®½åº¦ */
            box-sizing: border-box;
            
            display: flex;
            flex-direction: row; /* æ¨ªå‘æ’åˆ— */
            flex-wrap: wrap;     /* å…è®¸æ¢è¡Œ */
            justify-content: center;
            gap: 20px;
            
            border: 1px solid var(--border-color);
        }

        /* æ§åˆ¶ç»„æ¨¡å— */
        .control-group {
            border-bottom: none; /* ç§»é™¤åŸæ¥çš„åº•è¾¹æ¡† */
            border-right: 1px solid #f1f5f9; /* æ”¹ä¸ºå³è¾¹æ¡†åˆ†éš” */
            padding-right: 20px;
            padding-bottom: 0;
            min-width: 200px;
            flex: 1; /* å¼¹æ€§å®½åº¦ */
        }

        .control-group:last-child {
            border-right: none;
            padding-right: 0;
            flex: 1.5; /* ä¿¡æ¯é¢æ¿ç¨å¾®å®½ä¸€ç‚¹ */
        }
        
        /* åœ¨å°å±å¹•ä¸‹å–æ¶ˆå³è¾¹æ¡†ï¼Œæ¢å¤åº•è¾¹æ¡† */
        @media (max-width: 900px) {
            .controls {
                flex-direction: column;
            }
            .control-group {
                border-right: none;
                border-bottom: 1px solid #f1f5f9;
                padding-right: 0;
                padding-bottom: 15px;
            }
            .control-group:last-child {
                border-bottom: none;
            }
        }

        .control-header {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #475569;
            white-space: nowrap;
        }

        label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .value-display {
            font-family: monospace;
            color: var(--accent-color);
            font-weight: bold;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        button {
            flex: 1;
            padding: 8px 12px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background-color: #f8fafc;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* åº•éƒ¨ï¼šç”»å¸ƒå®¹å™¨ */
        #canvas-container {
            background: var(--panel-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            padding: 10px;
            
            width: 100%; /* å æ»¡å®½åº¦ */
            height: 600px; /* å›ºå®šé«˜åº¦ï¼Œæˆ–è€… min-height */
            box-sizing: border-box;
            
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* åº•éƒ¨ä¿¡æ¯æ æ ·å¼è°ƒæ•´ */
        .info-panel {
            margin-top: 0;
            padding: 10px;
            background: #eff6ff;
            border-radius: 8px;
            font-size: 0.9em;
            color: #1e3a8a;
            line-height: 1.6;
        }

    </style>
</head>
<body>

    <h1>å…‰æ³¢å®éªŒå®¤ï¼šæ³¢é•¿ã€æŒ¯å¹…ä¸æ³¢é€Ÿ</h1>
    <div class="subtitle">
        é€šè¿‡è°ƒèŠ‚å‚æ•°ï¼Œç›´è§‚ç†è§£å…‰çš„æ³¢åŠ¨æ€§ã€‚æ³¢é•¿å†³å®šå…‰çš„é¢œè‰²ï¼ŒæŒ¯å¹…å†³å®šå…‰çš„å¼ºåº¦ï¼ˆäº®åº¦ï¼‰ã€‚
    </div>

    <div class="main-container">
        
        <!-- ä¸Šæ–¹ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="controls">
            
            <!-- æ¨¡å—1ï¼šæ’­æ”¾æ§åˆ¶ -->
            <div class="control-group" style="flex: 0.8;">
                <div class="control-header">ğŸ“º æ’­æ”¾æ§åˆ¶</div>
                <div class="btn-group">
                    <button id="btn-play" class="active">æ’­æ”¾</button>
                    <button id="btn-pause">æš‚åœ</button>
                    <button id="btn-reset">é‡ç½®</button>
                </div>
            </div>

            <!-- æ¨¡å—2ï¼šç‰©ç†å‚æ•° -->
            <div class="control-group" style="flex: 1.5;">
                <div class="control-header">ğŸŒˆ ç‰©ç†å‚æ•°</div>
                
                <label>
                    <span>æ³¢é•¿ (Î») [é¢œè‰²]</span>
                    <span id="val-wavelength" class="value-display">550 nm</span>
                </label>
                <input type="range" id="slider-wavelength" min="380" max="750" step="1" value="550">
                
                <label>
                    <span>æŒ¯å¹… (A) [å¼ºåº¦]</span>
                    <span id="val-amplitude" class="value-display">80</span>
                </label>
                <input type="range" id="slider-amplitude" min="10" max="150" step="1" value="80">

                <label>
                    <span>æ¨¡æ‹Ÿæ³¢é€Ÿ (v)</span>
                    <span id="val-speed" class="value-display">1.0x</span>
                </label>
                <input type="range" id="slider-speed" min="0" max="3" step="0.1" value="1.0">
            </div>

            <!-- æ¨¡å—3ï¼šæ¦‚å¿µæ˜¾ç¤º -->
            <div class="control-group">
                <div class="control-header">ğŸ‘ï¸ æ¦‚å¿µæ˜¾ç¤º</div>
                
                <div class="toggle-row" id="toggle-measure-wl">
                    <span>ğŸ“ æ˜¾ç¤ºæ³¢é•¿æ ‡æ³¨</span>
                    <input type="checkbox" checked>
                </div>
                <div class="toggle-row" id="toggle-measure-amp">
                    <span>â†•ï¸ æ˜¾ç¤ºæŒ¯å¹…æ ‡æ³¨</span>
                    <input type="checkbox" checked>
                </div>
                <div class="toggle-row" id="toggle-particle">
                    <span>ğŸ”´ æ˜¾ç¤ºåœºå¼ºå‚è€ƒç‚¹</span>
                    <input type="checkbox" checked>
                </div>
                <div class="toggle-row" id="toggle-grid">
                    <span>ğŸ•¸ï¸ æ˜¾ç¤ºç½‘æ ¼</span>
                    <input type="checkbox" checked>
                </div>
            </div>

            <!-- æ¨¡å—4ï¼šè¯´æ˜ -->
            <div class="control-group info-panel">
                <strong>ç‰©ç†å°è´´å£«ï¼š</strong><br>
                1. <strong>æ³¢é•¿ (Î»)</strong>ï¼šä¸¤ä¸ªæ³¢å³°ä¹‹é—´çš„è·ç¦»ã€‚åœ¨çœŸç©ºä¸­ï¼Œä¸åŒé¢œè‰²çš„å…‰æ³¢é•¿ä¸åŒã€‚<br>
                2. <strong>æŒ¯å¹… (A)</strong>ï¼šæ³¢å³°åç¦»å¹³è¡¡ä½ç½®çš„è·ç¦»ã€‚æŒ¯å¹…è¶Šå¤§ï¼Œå…‰è¶Šäº®ã€‚<br>
                3. <strong>é¢œè‰²</strong>ï¼šæœ¬æ¼”ç¤ºæ ¹æ®æ³¢é•¿è‡ªåŠ¨è®¡ç®—å¯¹åº”çš„å…‰è°±é¢œè‰²ã€‚
            </div>

        </div>

        <!-- ä¸‹æ–¹ï¼šç”»å¸ƒ -->
        <div id="canvas-container"></div>

    </div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let wavelength = 550; // nm
        let amplitude = 80;   // pixels (mapped from intensity)
        let speedMult = 1.0;  // multiplier
        let phase = 0;
        
        let isPlaying = true;
        
        // æ ‡è®°å¼€å…³
        let showWavelength = true;
        let showAmplitude = true;
        let showParticle = true;
        let showGrid = true;

        // ç”»å¸ƒå°ºå¯¸
        let cWidth, cHeight;

        // p5.js å®ä¾‹
        function setup() {
            // æ ¹æ®å®¹å™¨åŠ¨æ€è®¡ç®—å¤§å°
            const container = document.getElementById('canvas-container');
            cWidth = container.clientWidth;
            cHeight = container.clientHeight; // è‡³å°‘500px

            const canvas = createCanvas(cWidth, cHeight);
            canvas.parent('canvas-container');
            
            frameRate(60);
            rectMode(CENTER);
            textAlign(CENTER, CENTER);
            textSize(14);
            
            // åˆå§‹åŒ–DOMç›‘å¬å™¨
            initControls();
        }

        function windowResized() {
            const container = document.getElementById('canvas-container');
            if (container) {
                cWidth = container.clientWidth;
                cHeight = container.clientHeight;
                resizeCanvas(cWidth, cHeight);
            }
        }

        function draw() {
            background(255); // ç™½è‰²èƒŒæ™¯

            if (showGrid) drawGrid();
            drawAxes();

            // è®¡ç®—å½“å‰æ³¢çš„é¢œè‰²
            let waveColor = wavelengthToColor(wavelength);
            
            // ç‰©ç†è®¡ç®—
            // è¿™é‡Œçš„ scalingFactor æ˜¯ä¸ºäº†å°†nmæ˜ å°„åˆ°å±å¹•åƒç´ 
            // å‡è®¾å±å¹•å®½åº¦å¯¹åº”çº¦ 2000nm çš„è§†é‡ï¼ˆä»…ä¸ºæ¼”ç¤ºæ¯”ä¾‹ï¼‰
            let displayWavelength = map(wavelength, 380, 750, 150, 400); 
            
            // æ›´æ–°ç›¸ä½
            if (isPlaying) {
                // é€Ÿåº¦ = é¢‘ç‡ * æ³¢é•¿
                phase -= (0.05 * speedMult); 
            }

            // ç»˜åˆ¶æ³¢å½¢
            noFill();
            stroke(waveColor);
            strokeWeight(4);
            
            beginShape();
            for (let x = 0; x <= width; x += 2) {
                // æ ¸å¿ƒæ³¢æ–¹ç¨‹: y = A * sin(kx - Ï‰t)
                let k = TWO_PI / displayWavelength; // æ³¢æ•°
                // x å¯¹åº”å±å¹•åæ ‡ï¼Œwidth/2 ä¸ºåŸç‚¹
                let xRel = x - 50; // ä»å·¦ä¾§å¼€å§‹ä¸€ç‚¹
                let y = height / 2 + amplitude * sin(k * xRel + phase);
                vertex(x, y);
            }
            endShape();

            // ç»˜åˆ¶è§†è§‰è¾…åŠ© (æ ‡æ³¨)
            drawAnnotations(displayWavelength, waveColor);

            // ç»˜åˆ¶å‚è€ƒç‚¹ (ç²’å­/åœºå¼ºç‚¹)
            if (showParticle) {
                drawReferenceParticle(displayWavelength, waveColor);
            }
            
            // å·¦ä¸Šè§’æ˜¾ç¤ºå½“å‰å…‰è‰²å—
            drawColorIndicator(waveColor);
        }

        // --- è¾…åŠ©ç»˜å›¾å‡½æ•° ---

        function drawGrid() {
            stroke(240);
            strokeWeight(1);
            // ç«–çº¿
            for (let x = 0; x < width; x += 50) {
                line(x, 0, x, height);
            }
            // æ¨ªçº¿
            for (let y = 0; y < height; y += 50) {
                line(0, y, width, y);
            }
        }

        function drawAxes() {
            stroke(100);
            strokeWeight(1);
            // Xè½´ (ä¼ æ’­æ–¹å‘)
            line(20, height / 2, width - 20, height / 2);
            fill(100);
            noStroke();
            triangle(width - 20, height / 2 - 5, width - 20, height / 2 + 5, width - 10, height / 2);
            text("ä¼ æ’­æ–¹å‘ (x)", width - 60, height / 2 + 20);

            // Yè½´ (ç”µåœºå¼ºåº¦ E)
            stroke(100);
            line(50, height - 50, 50, 50);
            triangle(45, 50, 55, 50, 50, 40);
            noStroke();
            text("ç”µåœºå¼ºåº¦ (E)", 90, 40);
        }

        function drawAnnotations(displayWl, color) {
            let k = TWO_PI / displayWl;
            
            let startPhase = phase % TWO_PI; // Normalize
            // å¯»æ‰¾ç¬¬ä¸€ä¸ªå®Œæ•´çš„æ³¢å³°
            let firstPeakX = (HALF_PI - startPhase) / k;
            while(firstPeakX < 100) firstPeakX += displayWl; 
            
            let secondPeakX = firstPeakX + displayWl;

            // 1. ç»˜åˆ¶æ³¢é•¿æ ‡æ³¨ (Î»)
            if (showWavelength && secondPeakX < width - 20) {
                let peakY = height / 2 - amplitude - 20;
                
                stroke(50);
                strokeWeight(1);
                // è¾…åŠ©ç«–çº¿
                drawingContext.setLineDash([5, 5]); // è™šçº¿
                line(firstPeakX, height/2 - amplitude, firstPeakX, peakY - 10);
                line(secondPeakX, height/2 - amplitude, secondPeakX, peakY - 10);
                drawingContext.setLineDash([]); // å®çº¿

                // ç®­å¤´çº¿
                fill(50);
                stroke(50);
                line(firstPeakX + 10, peakY, secondPeakX - 10, peakY);
                // ç®­å¤´
                triangle(firstPeakX, peakY, firstPeakX + 10, peakY - 4, firstPeakX + 10, peakY + 4);
                triangle(secondPeakX, peakY, secondPeakX - 10, peakY - 4, secondPeakX - 10, peakY + 4);

                noStroke();
                fill(0);
                rectMode(CENTER);
                // èƒŒæ™¯ç™½å—é˜²æ­¢å­—çœ‹ä¸æ¸…
                fill(255, 200); 
                rect((firstPeakX + secondPeakX)/2, peakY, 80, 20);
                fill(0);
                text(`æ³¢é•¿ Î» = ${wavelength} nm`, (firstPeakX + secondPeakX)/2, peakY);
            }

            // 2. ç»˜åˆ¶æŒ¯å¹…æ ‡æ³¨ (A)
            if (showAmplitude && firstPeakX < width) {
                let baseX = firstPeakX; 
                let topY = height / 2 - amplitude;
                let midY = height / 2;

                stroke(50);
                strokeWeight(1);
                
                // ç®­å¤´çº¿
                line(baseX, midY - 5, baseX, topY + 5);
                fill(50);
                // ä¸Šç®­å¤´
                triangle(baseX, topY, baseX - 4, topY + 5, baseX + 4, topY + 5);
                // ä¸‹ç®­å¤´
                triangle(baseX, midY, baseX - 4, midY - 5, baseX + 4, midY - 5);

                noStroke();
                fill(0);
                text("æŒ¯å¹… A", baseX + 40, (topY + midY)/2);
            }
        }

        function drawReferenceParticle(displayWl, color) {
            // åœ¨å›ºå®šçš„ x ä½ç½®æ˜¾ç¤ºä¸€ä¸ªç‚¹
            let particleX = width / 2;
            let k = TWO_PI / displayWl;
            let particleY = height / 2 + amplitude * sin(k * (particleX - 50) + phase);

            // è™šçº¿è½¨è¿¹
            stroke(color);
            strokeWeight(1);
            drawingContext.setLineDash([2, 4]);
            line(particleX, height/2 - amplitude, particleX, height/2 + amplitude);
            drawingContext.setLineDash([]);

            // ç²’å­æœ¬ä½“
            fill(color);
            stroke(0);
            strokeWeight(1);
            circle(particleX, particleY, 15);

            // æ ‡ç­¾
            fill(100);
            noStroke();
            textAlign(LEFT);
            text("åœºå¼ºå˜åŒ–ç‚¹", particleX + 15, particleY);
            textAlign(CENTER);
        }
        
        function drawColorIndicator(col) {
            push();
            resetMatrix();
            fill(col);
            stroke(200);
            strokeWeight(1);
            rectMode(CORNER);
            rect(10, 10, 30, 30, 5);
            fill(50);
            noStroke();
            textAlign(LEFT, CENTER);
            textSize(12);
            text("å½“å‰å…‰è‰²", 45, 25);
            pop();
        }

        // --- é€»è¾‘æ§åˆ¶å‡½æ•° ---

        function initControls() {
            // æ’­æ”¾æŒ‰é’®
            document.getElementById('btn-play').onclick = () => {
                isPlaying = true;
                setActiveBtn('btn-play');
                loop();
            };
            document.getElementById('btn-pause').onclick = () => {
                isPlaying = false;
                setActiveBtn('btn-pause');
                noLoop();
            };
            document.getElementById('btn-reset').onclick = () => {
                resetSim();
            };

            // æ»‘å—ç›‘å¬
            const sWavelength = document.getElementById('slider-wavelength');
            const vWavelength = document.getElementById('val-wavelength');
            sWavelength.oninput = (e) => {
                wavelength = parseInt(e.target.value);
                vWavelength.innerText = wavelength + " nm";
                if(!isPlaying) redraw();
            };

            const sAmplitude = document.getElementById('slider-amplitude');
            const vAmplitude = document.getElementById('val-amplitude');
            sAmplitude.oninput = (e) => {
                amplitude = parseInt(e.target.value);
                vAmplitude.innerText = amplitude;
                if(!isPlaying) redraw();
            };

            const sSpeed = document.getElementById('slider-speed');
            const vSpeed = document.getElementById('val-speed');
            sSpeed.oninput = (e) => {
                speedMult = parseFloat(e.target.value);
                vSpeed.innerText = speedMult.toFixed(1) + "x";
            };

            // Toggleç›‘å¬
            bindToggle('toggle-measure-wl', (v) => { showWavelength = v; if(!isPlaying) redraw(); });
            bindToggle('toggle-measure-amp', (v) => { showAmplitude = v; if(!isPlaying) redraw(); });
            bindToggle('toggle-particle', (v) => { showParticle = v; if(!isPlaying) redraw(); });
            bindToggle('toggle-grid', (v) => { showGrid = v; if(!isPlaying) redraw(); });
        }

        function bindToggle(id, callback) {
            const div = document.getElementById(id);
            const checkbox = div.querySelector('input');
            div.onclick = (e) => {
                if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
                callback(checkbox.checked);
            };
            checkbox.onchange = () => callback(checkbox.checked);
        }

        function setActiveBtn(id) {
            ['btn-play', 'btn-pause'].forEach(btnId => {
                document.getElementById(btnId).classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function resetSim() {
            wavelength = 550;
            amplitude = 80;
            speedMult = 1.0;
            phase = 0;
            
            document.getElementById('slider-wavelength').value = 550;
            document.getElementById('val-wavelength').innerText = "550 nm";
            
            document.getElementById('slider-amplitude').value = 80;
            document.getElementById('val-amplitude').innerText = "80";
            
            document.getElementById('slider-speed').value = 1.0;
            document.getElementById('val-speed').innerText = "1.0x";
            
            isPlaying = true;
            setActiveBtn('btn-play');
            loop();
        }

        // --- æ ¸å¿ƒç®—æ³•ï¼šæ³¢é•¿è½¬RGBé¢œè‰² ---
        function wavelengthToColor(wl) {
            let r, g, b, alpha;
            if (wl >= 380 && wl < 440) { r = -1 * (wl - 440) / (440 - 380); g = 0; b = 1; } 
            else if (wl >= 440 && wl < 490) { r = 0; g = (wl - 440) / (490 - 440); b = 1; } 
            else if (wl >= 490 && wl < 510) { r = 0; g = 1; b = -1 * (wl - 510) / (510 - 490); } 
            else if (wl >= 510 && wl < 580) { r = (wl - 510) / (580 - 510); g = 1; b = 0; } 
            else if (wl >= 580 && wl < 645) { r = 1; g = -1 * (wl - 645) / (645 - 580); b = 0; } 
            else if (wl >= 645 && wl <= 750) { r = 1; g = 0; b = 0; } 
            else { r = 0; g = 0; b = 0; }

            if (wl > 700) { alpha = 0.3 + 0.7 * (750 - wl) / (750 - 700); } 
            else if (wl < 420) { alpha = 0.3 + 0.7 * (wl - 380) / (420 - 380); } 
            else { alpha = 1; }

            return color(r * 255, g * 255, b * 255, alpha * 255);
        }

    </script>
</body>
</html>