<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-V-T ç‰©ç†æŠ•å½±æ¼”ç¤º (æ•™å­¦ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Inter', sans-serif; }
        
        #ui-layer {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10; background: rgba(15, 23, 42, 0.9);
            padding: 12px 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(12px); display: flex; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .btn {
            padding: 12px 24px; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; color: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; align-items: center; gap: 10px;
            font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;
            opacity: 0.8;
        }
        
        .btn.active { opacity: 1; transform: scale(1.05); filter: brightness(1.2); border: 1px solid rgba(255,255,255,0.5); }
        
        .btn-3d { background: linear-gradient(145deg, #fbbf24, #b45309); }
        .btn-vt { background: linear-gradient(145deg, #ef4444, #991b1b); }
        .btn-st { background: linear-gradient(145deg, #3b82f6, #1e40af); }
        .btn-sv { background: linear-gradient(145deg, #10b981, #065f46); }

        .btn:hover { opacity: 1; transform: translateY(-2px); }

        #title-box {
            position: absolute; top: 20px; left: 20px; pointer-events: none;
            background: rgba(0,0,0,0.6); padding: 20px; border-radius: 12px;
            border-left: 4px solid #fbbf24;
        }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #e2e8f0; margin-top: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 8px currentColor; }
        
        /* æç¤ºæ–‡å­— */
        #hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; font-weight: bold; opacity: 0; pointer-events: none;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8); transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="title-box">
        <h1 class="text-2xl font-bold text-white mb-3 tracking-wide">S-V-T ç‰©ç†è¿åŠ¨æŠ•å½±</h1>
        <div class="legend-item"><div class="dot" style="background:#fbbf24; color:#fbbf24"></div> <span>å½“å‰çŠ¶æ€ (Current State)</span></div>
        <div class="legend-item"><div class="dot" style="background:#475569; color:#475569; border:1px solid #94a3b8"></div> <span>3D åŸåƒ (Ghost Reference)</span></div>
        <div class="mt-4 text-xs text-gray-400 max-w-[200px] leading-relaxed">
            è§‚å¯Ÿçº¿æ¡æ˜¯å¦‚ä½•"å¡Œç¼©"åˆ°äºŒç»´å¹³é¢ä¸Šçš„ã€‚ç°çº¿ä»£è¡¨åŸå§‹çš„ä¸‰ç»´è¿åŠ¨è½¨è¿¹ã€‚
        </div>
    </div>

    <div id="hint">æŠ•å½±ä¸­...</div>

    <div id="ui-layer">
        <button class="btn btn-3d active" onclick="transformView('3d', this)">âœ¨ 3D å…¨è²Œ</button>
        <button class="btn btn-vt" onclick="transformView('vt', this)">ğŸ“‰ å‹æ‰ Sè½´ (v-t)</button>
        <button class="btn btn-st" onclick="transformView('st', this)">ğŸ“ˆ å‹æ‰ Vè½´ (s-t)</button>
        <button class="btn btn-sv" onclick="transformView('sv', this)">ğŸŒ å‹æ‰ Tè½´ (v-s)</button>
    </div>

    <div id="canvas-container" class="w-full h-screen"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { LineMaterial } from 'three/addons/lines/LineMaterial.js'; // å¦‚æœéœ€è¦ç²—çº¿å¯ä»¥ç”¨ Line2ï¼Œè¿™é‡Œæš‚æ—¶ä¿æŒç®€ä¾¿ç”¨åŸç”Ÿ
        import TWEEN from 'three/addons/libs/tween.module.js';

        // ==========================================
        // 1. ç‰©ç†æ•°æ®åˆå§‹åŒ– (å·²ä¿®æ­£é€»è¾‘)
        // ==========================================
        const script = [
            { dur: 2, endV: 30 }, { dur: 30, endV: 30 }, { dur: 5, endV: 100 },
            { dur: 120, endV: 100 }, { dur: 3, endV: 0 }, { dur: 20, endV: 0 },
            { dur: 5, endV: 120 }, { dur: 30, endV: 120 }, { dur: 5, endV: 40 },
            { dur: 8, endV: 40 }, { dur: 2, endV: 0 }
        ];

        let rawPoints = [];
        let maxT = 0, maxS = 0;

        function initData() {
            let t = 0, s = 0, v = 0;
            rawPoints.push({t, v, s});
            
            script.forEach(step => {
                const dt = step.dur, dt_h = dt/60;
                const acc = dt_h===0 ? 0 : (step.endV - v)/dt_h;
                
                for(let sub=0.5; sub<=dt; sub+=0.5) {
                    const sub_h = sub/60;
                    rawPoints.push({
                        t: t + sub,
                        v: v + acc*sub_h,
                        s: s + v*sub_h + 0.5*acc*sub_h*sub_h
                    });
                }
                s += (v*dt_h + 0.5*acc*dt_h*dt_h); 
                t += dt; 
                v = step.endV; 
            });
            maxT = t; maxS = s;
        }
        initData();

        const ST = 100 / maxT;
        const SV = 100 / 140;
        const SS = 100 / maxS;

        // ==========================================
        // 2. åœºæ™¯ä¸æ¸²æŸ“
        // ==========================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);
        scene.fog = new THREE.FogExp2(0x0f172a, 0.0015); // å¢åŠ ä¸€ç‚¹é›¾æ°”å¢åŠ æ·±é‚ƒæ„Ÿ
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 3000);
        camera.position.set(180, 140, 180); // åˆå§‹è§†è§’æ‹‰è¿œä¸€ç‚¹

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // ä¼˜åŒ–é«˜æ¸…å±
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(50, 50, 50);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // ==========================================
        // 3. å¢™é¢ç³»ç»Ÿ (Grid Walls)
        // ==========================================
        const walls = {};

        function createWall(name, w, h, color, pos, rot) {
            const group = new THREE.Group();
            
            // ç½‘æ ¼
            const grid = new THREE.GridHelper(w, 10, color, 0x1e293b);
            grid.position.copy(pos);
            if(rot) grid.rotation.copy(rot);
            
            // å¢åŠ ä¸€ä¸ªé€æ˜å¹³é¢ï¼Œç”¨äºé«˜äº®æ•ˆæœ
            const planeGeo = new THREE.PlaneGeometry(w, h);
            const planeMat = new THREE.MeshBasicMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.05, // é»˜è®¤å¾ˆæ·¡
                side: THREE.DoubleSide
            });
            const plane = new THREE.Mesh(planeGeo, planeMat);
            plane.position.copy(pos);
            if(rot) plane.rotation.copy(rot);
            
            // ç¨å¾®è°ƒæ•´å¹³é¢ä½ç½®ï¼Œé¿å… Z-fighting
            if(name === 'st') plane.position.y -= 0.1;
            if(name === 'vt') plane.position.z -= 0.1;
            if(name === 'sv') plane.position.x -= 0.1;

            group.add(grid);
            group.add(plane);
            scene.add(group);
            
            walls[name] = { group, grid, plane, baseColor: new THREE.Color(color) };
        }
        
        createWall('st', 100, 100, 0x3b82f6, new THREE.Vector3(50, 0, 50), new THREE.Euler(0,0,0)); // åœ°é¢
        createWall('vt', 100, 100, 0xef4444, new THREE.Vector3(50, 50, 0), new THREE.Euler(Math.PI/2, 0, 0)); // èƒŒå¢™
        createWall('sv', 100, 100, 0x10b981, new THREE.Vector3(0, 50, 50), new THREE.Euler(0, 0, Math.PI/2)); // ä¾§å¢™

        const axes = new THREE.AxesHelper(110);
        scene.add(axes);

        // æ ‡ç­¾
        function addLabel(txt, col, x, y, z) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 128;
            ctx.fillStyle = col; ctx.font = "bold 60px Arial"; ctx.textAlign = "center";
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4;
            ctx.fillText(txt, 128, 85);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent:true, opacity: 0.8 }));
            sprite.position.set(x,y,z);
            sprite.scale.set(20, 10, 1);
            scene.add(sprite);
        }
        addLabel("æ—¶é—´ t", "#94a3b8", 115, 5, 0); 
        addLabel("é€Ÿåº¦ v", "#ef4444", 0, 115, 0); 
        addLabel("è·¯ç¨‹ s", "#3b82f6", 0, 5, 115); 

        // ==========================================
        // 4. å‡ ä½•ä½“ï¼šå¹½çµçº¿ & åŠ¨æ€çº¿
        // ==========================================
        const pointCount = rawPoints.length;
        const positions = new Float32Array(pointCount * 3);
        const originalPos = [];
        
        rawPoints.forEach((p, i) => {
            const x = p.t * ST;
            const y = p.v * SV;
            const z = p.s * SS;
            positions[i*3] = x; positions[i*3+1] = y; positions[i*3+2] = z;
            originalPos.push({x, y, z});
        });
        
        // 1. å¹½çµçº¿ (Ghost Line) - æ°¸è¿œä¿æŒ 3D å½¢çŠ¶ï¼Œä½œä¸ºå‚è€ƒ
        const ghostGeo = new THREE.BufferGeometry();
        ghostGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        const ghostMat = new THREE.LineBasicMaterial({ 
            color: 0x94a3b8, 
            opacity: 0.3, // æé«˜ä¸€ç‚¹å¯è§åº¦
            transparent: true,
            linewidth: 1 // æ³¨æ„ï¼šWebGL ä¸­ linewidth åœ¨å¤§å¤šæ•°æµè§ˆå™¨æ— æ•ˆï¼Œè¿™å¾ˆæ­£å¸¸
        });
        // æ—¢ç„¶åŸç”Ÿ linewidth ä¸èµ·ä½œç”¨ï¼Œä¸ºäº†è®©å¹½çµçº¿æ›´æ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒåšæˆè™šçº¿
        const ghostLine = new THREE.Line(ghostGeo, new THREE.LineDashedMaterial({
            color: 0x94a3b8,
            dashSize: 2,
            gapSize: 1,
            opacity: 0.3,
            transparent: true,
            scale: 1
        }));
        ghostLine.computeLineDistances(); // å¿…é¡»è°ƒç”¨è¿™ä¸ªè™šçº¿æ‰ç”Ÿæ•ˆ
        scene.add(ghostLine);

        // 2. ä¸»è§’çº¿ (Active Morphing Line)
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions.slice(), 3)); // å¤åˆ¶ä¸€ä»½ä½ç½®
        const material = new THREE.LineBasicMaterial({ color: 0xfbbf24, linewidth: 2 });
        const line = new THREE.Line(geometry, material);
        scene.add(line);

        // å¤´éƒ¨å°çƒ
        const headMesh = new THREE.Mesh(
            new THREE.SphereGeometry(2.5),
            new THREE.MeshBasicMaterial({ color: 0xffffff })
        );
        scene.add(headMesh);

        // ==========================================
        // 5. æ ¸å¿ƒåŠ¨ç”»é€»è¾‘ (ä¼˜åŒ–ç‰ˆ)
        // ==========================================
        const scaleState = { x: 1, y: 1, z: 1 };
        const colorState = { r: 0.98, g: 0.75, b: 0.14 };

        // è¾…åŠ©å‡½æ•°ï¼šé«˜äº®æŸä¸ªå¢™é¢
        function highlightWall(targetName) {
            ['st', 'vt', 'sv'].forEach(name => {
                const w = walls[name];
                const isTarget = (name === targetName);
                
                // ç›®æ ‡å¢™é¢å˜äº®ï¼Œç½‘æ ¼å˜æ¸…æ¥š
                const targetOpacity = isTarget ? 0.2 : 0.05; 
                const targetGridColor = isTarget ? new THREE.Color(0xffffff) : new THREE.Color(0x1e293b);
                
                new TWEEN.Tween(w.plane.material)
                    .to({ opacity: targetOpacity }, 1000)
                    .start();
            });
        }

        window.transformView = (mode, btn) => {
            // UI æŒ‰é’®çŠ¶æ€æ›´æ–°
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // æç¤ºæ–‡å­—
            const hintEl = document.getElementById('hint');
            hintEl.style.opacity = 1;
            setTimeout(() => hintEl.style.opacity = 0, 2000);

            let targetScale = { x:1, y:1, z:1 };
            let targetCamPos = { x:180, y:140, z:180 };
            let targetColor = { r: 0.98, g: 0.75, b: 0.14 };
            let wallName = null;

            // è®¾å®šç›®æ ‡å‚æ•°
            switch(mode) {
                case '3d':
                    hintEl.innerText = "è¿˜åŸ 3D ç©ºé—´";
                    break;
                case 'vt':
                    targetScale = { x:1, y:1, z:0 };
                    targetCamPos = { x: 50, y: 50, z: 200 };
                    targetColor = { r: 0.93, g: 0.26, b: 0.26 };
                    wallName = 'vt';
                    hintEl.innerText = "å‹ç¼©è·¯ç¨‹ (S) -> æŸ¥çœ‹ V-T å›¾";
                    break;
                case 'st':
                    targetScale = { x:1, y:0, z:1 };
                    targetCamPos = { x: 50, y: 200, z: 50.01 }; 
                    targetColor = { r: 0.23, g: 0.51, b: 0.96 };
                    wallName = 'st';
                    hintEl.innerText = "å‹ç¼©é€Ÿåº¦ (V) -> æŸ¥çœ‹ S-T å›¾";
                    break;
                case 'sv':
                    targetScale = { x:0, y:1, z:1 };
                    targetCamPos = { x: 200, y: 50, z: 50 };
                    targetColor = { r: 0.06, g: 0.72, b: 0.5 };
                    wallName = 'sv';
                    hintEl.innerText = "å‹ç¼©æ—¶é—´ (T) -> æŸ¥çœ‹ V-S å›¾";
                    break;
            }

            highlightWall(wallName);

            // ---------------------------------------------
            // åŠ¨ç”» 1: å‡ ä½•ä½“å˜å½¢ (å˜æ…¢ï¼Œå˜å¹³æ»‘)
            // ---------------------------------------------
            // æŒç»­æ—¶é—´ä» 1500 æ”¹ä¸º 2500ï¼Œä½¿ç”¨ Cubic.InOut æ¨¡æ‹Ÿæœºæ¢°è¿åŠ¨
            new TWEEN.Tween(scaleState)
                .to(targetScale, 2500) 
                .easing(TWEEN.Easing.Cubic.InOut) 
                .onUpdate(() => {
                    const positions = line.geometry.attributes.position.array;
                    for(let i=0; i<pointCount; i++) {
                        positions[i*3]     = originalPos[i].x * scaleState.x;
                        positions[i*3 + 1] = originalPos[i].y * scaleState.y;
                        positions[i*3 + 2] = originalPos[i].z * scaleState.z;
                    }
                    line.geometry.attributes.position.needsUpdate = true;
                    
                    // å°çƒè·Ÿéš
                    const lastIdx = pointCount - 1;
                    headMesh.position.set(
                        originalPos[lastIdx].x * scaleState.x,
                        originalPos[lastIdx].y * scaleState.y,
                        originalPos[lastIdx].z * scaleState.z
                    );
                })
                .start();

            // ---------------------------------------------
            // åŠ¨ç”» 2: é¢œè‰²è¿‡æ¸¡
            // ---------------------------------------------
            new TWEEN.Tween(colorState)
                .to(targetColor, 2000)
                .easing(TWEEN.Easing.Sinusoidal.Out)
                .onUpdate(() => {
                    line.material.color.setRGB(colorState.r, colorState.g, colorState.b);
                    headMesh.material.color.setRGB(colorState.r, colorState.g, colorState.b);
                })
                .start();

            // ---------------------------------------------
            // åŠ¨ç”» 3: ç›¸æœºç§»åŠ¨ (å»¶è¿Ÿå¯åŠ¨)
            // ---------------------------------------------
            // æ ¸å¿ƒä¼˜åŒ–ï¼šå»¶è¿Ÿ 500ms å¯åŠ¨ç›¸æœºï¼Œè®©ç”¨æˆ·å…ˆçœ‹æ¸…å˜å½¢æ–¹å‘
            new TWEEN.Tween(camera.position)
                .to(targetCamPos, 2500)
                .delay(300) // å»¶è¿Ÿ! è®©ç”¨æˆ·å…ˆçœ‹åˆ°çº¿å¾€å¢™ä¸Šæ‹ï¼Œç„¶åè§†è§’å†è¿‡å»
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();
                
            new TWEEN.Tween(controls.target)
                .to({ x:50, y:50, z:50 }, 2500)
                .delay(300)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();
        };

        // ==========================================
        // 6. å¾ªç¯
        // ==========================================
        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>