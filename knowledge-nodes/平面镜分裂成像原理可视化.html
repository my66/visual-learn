<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³é¢é•œæˆåƒæ·±åº¦æ¢ç©¶æ¼”ç¤º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif; overflow: hidden; }
        .main-layout { display: flex; flex-direction: column; height: 100vh; }
        .canvas-container { flex: 1; position: relative; background-color: #0f172a; overflow: hidden; }
        .controls-container { height: auto; min-height: 220px; background-color: white; border-top: 1px solid #e2e8f0; z-index: 10; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1); }
        input[type=range] { accent-color: #3b82f6; }
        
        /* ç®€å•çš„å…‰æ™•åŠ¨ç”» */
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .glow-text { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="main-layout">
        <!-- 1. æ ¸å¿ƒæ¼”ç¤ºåŒº -->
        <div class="canvas-container" id="canvasContainer">
            <canvas id="simCanvas" class="block w-full h-full"></canvas>
            
            <!-- æ‚¬æµ®å›¾ä¾‹ -->
            <div class="absolute top-4 left-4 flex flex-col gap-2 bg-slate-900/80 backdrop-blur-md p-4 rounded-xl text-white text-xs select-none border border-slate-700 shadow-xl ring-1 ring-white/10">
                <div class="font-bold text-slate-400 mb-1 tracking-wider uppercase">Legend</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span>ç‰©ä½“ AB</div>
                <div class="flex items-center"><span class="w-8 h-0.5 bg-yellow-400 border-t border-dashed mr-2"></span>ç‰©åƒè¿çº¿ (å‚ç›´)</div>
                <div class="border-t border-white/10 my-1"></div>
                <div class="flex items-center text-red-200"><span class="w-8 h-4 bg-gradient-to-r from-red-500/0 via-red-500/30 to-red-500/0 mr-2 rounded"></span>é¡¶éƒ¨å…‰æŸ A (ä¸Šé•œ)</div>
                <div class="flex items-center text-purple-200"><span class="w-8 h-4 bg-gradient-to-r from-purple-500/0 via-purple-500/30 to-purple-500/0 mr-2 rounded"></span>åº•éƒ¨å…‰æŸ B (ä¸‹é•œ)</div>
            </div>

            <!-- çŠ¶æ€æç¤º -->
            <div id="statusTip" class="absolute top-4 right-4 bg-green-600/90 text-white px-5 py-2 rounded-full font-bold shadow-lg transition-all border border-white/20 backdrop-blur-sm transform hover:scale-105 cursor-default">
                åƒçš„ä½ç½®ä¸å˜
            </div>
        </div>

        <!-- 2. æ§åˆ¶ä¸è¯´æ˜åŒº -->
        <div class="controls-container flex flex-col md:flex-row">
            
            <!-- å·¦ä¾§ï¼šé€‰é¡¹èœå• -->
            <div class="w-full md:w-1/3 p-6 bg-slate-50 border-r border-slate-200 flex flex-col gap-3">
                <h2 class="text-lg font-bold text-slate-800 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    å®éªŒåœºæ™¯é€‰æ‹©
                </h2>
                
                <label class="cursor-pointer group">
                    <input type="radio" name="scenario" value="split" checked class="peer hidden">
                    <div class="p-3 rounded-lg border border-slate-200 bg-white peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:bg-slate-100 transition-all flex items-center justify-between shadow-sm">
                        <span class="font-semibold">â‘  ä¸Šä¸‹å¹³ç§» (é¢˜ç›®åŸæ™¯)</span>
                        <div class="w-4 h-4 rounded-full border border-slate-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 flex items-center justify-center">
                             <div class="w-1.5 h-1.5 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer group">
                    <input type="radio" name="scenario" value="depth" class="peer hidden">
                    <div class="p-3 rounded-lg border border-slate-200 bg-white peer-checked:border-amber-500 peer-checked:bg-amber-50 peer-checked:text-amber-700 hover:bg-slate-100 transition-all flex items-center justify-between shadow-sm">
                        <span class="font-semibold">â‘¡ å‰åé”™ä½ (å‡è®¾æƒ…å†µ)</span>
                        <div class="w-4 h-4 rounded-full border border-slate-300 peer-checked:bg-amber-500 peer-checked:border-amber-500 flex items-center justify-center">
                             <div class="w-1.5 h-1.5 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer group">
                    <input type="radio" name="scenario" value="tilt" class="peer hidden">
                    <div class="p-3 rounded-lg border border-slate-200 bg-white peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:text-purple-700 hover:bg-slate-100 transition-all flex items-center justify-between shadow-sm">
                        <span class="font-semibold">â‘¢ è§’åº¦å€¾æ–œ (é«˜é˜¶æ¢ç©¶)</span>
                         <div class="w-4 h-4 rounded-full border border-slate-300 peer-checked:bg-purple-500 peer-checked:border-purple-500 flex items-center justify-center">
                             <div class="w-1.5 h-1.5 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                        </div>
                    </div>
                </label>
            </div>

            <!-- å³ä¾§ï¼šæ§åˆ¶ä¸è®²è§£ -->
            <div class="w-full md:w-2/3 p-6 relative bg-white">
                
                <!-- åœºæ™¯ 1 -->
                <div id="panel-split" class="control-panel h-full flex flex-col justify-center">
                    <div class="mb-6">
                        <div class="flex justify-between mb-2 items-end">
                            <label class="font-bold text-blue-800 text-lg">ä¸Šä¸‹åˆ†ç¦»ç¨‹åº¦</label>
                            <span id="val-split" class="font-mono text-blue-600 bg-blue-50 px-2 py-0.5 rounded">0 px</span>
                        </div>
                        <input type="range" id="slider-split" min="0" max="250" value="0" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition-colors">
                        <p class="text-xs text-slate-400 mt-2">â† æ‹–åŠ¨æ»‘å—ï¼Œå°†å®Œæ•´é•œå­åˆ†ç¦»</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500 text-sm text-blue-900 leading-relaxed shadow-sm">
                        <strong class="text-blue-700">ç‰©ç†ç°è±¡ï¼š</strong> 
                        æ— è®ºä¸Šä¸‹ä¸¤å—é•œå­åˆ†å¼€å¤šè¿œï¼Œåªè¦å®ƒä»¬åœ¨åŒä¸€ä¸ªå¹³é¢å†…ï¼Œ<br>
                        1. çº¢è‰²å…‰æŸï¼ˆä¸Šï¼‰å’Œç´«è‰²å…‰æŸï¼ˆä¸‹ï¼‰çš„åå‘å»¶é•¿çº¿ä¾ç„¶æ±‡èšåœ¨<b>åŒä¸€ä¸ªç‚¹</b>ã€‚<br>
                        2. åƒçš„ä½ç½®æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜ã€‚<br>
                        ğŸ‘‰ <b>ç»“è®ºï¼šéƒ½æˆå®Œæ•´çš„åƒï¼Œä¸”ä½ç½®ä¸å˜ (é€‰ D)</b>
                    </div>
                </div>

                <!-- åœºæ™¯ 2 -->
                <div id="panel-depth" class="control-panel h-full flex flex-col justify-center hidden">
                    <div class="mb-6">
                        <div class="flex justify-between mb-2 items-end">
                            <label class="font-bold text-amber-800 text-lg">ä¸‹åŠé•œåé€€è·ç¦»</label>
                            <span id="val-depth" class="font-mono text-amber-600 bg-amber-50 px-2 py-0.5 rounded">0 px</span>
                        </div>
                        <input type="range" id="slider-depth" min="0" max="150" value="0" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition-colors">
                        <p class="text-xs text-slate-400 mt-2">â† æ‹–åŠ¨æ»‘å—ï¼Œä¸‹åŠæˆªé•œå­å‘åæ–­è£‚å¹³ç§»</p>
                    </div>
                    <div class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-500 text-sm text-amber-900 leading-relaxed shadow-sm">
                         <strong class="text-amber-700">å¯¹æ¯”å®éªŒï¼š</strong> <br>
                         è§‚å¯Ÿç´«è‰²å…‰æŸï¼ˆä¸‹åŠéƒ¨åˆ†ï¼‰ã€‚å½“é•œé¢å‘åç§»åŠ¨æ—¶ï¼Œå…‰æŸçš„åå°„é¢åé€€äº†ã€‚<br>
                         æ ¹æ®å¯¹ç§°æ€§ï¼Œä¸‹åŠéƒ¨åˆ†çš„åƒï¼ˆç´«è‰²è™šåƒï¼‰ä¹Ÿéšä¹‹åç§»ã€‚<br>
                         æ­¤æ—¶åƒåˆ†è£‚æˆäº†ä¸¤ä¸ªï¼Œè¯´æ˜<b>â€œå…±é¢â€</b>æ˜¯åƒé‡åˆçš„å¿…è¦æ¡ä»¶ã€‚
                    </div>
                </div>

                <!-- åœºæ™¯ 3 -->
                <div id="panel-tilt" class="control-panel h-full flex flex-col justify-center hidden">
                    <div class="mb-6">
                        <div class="flex justify-between mb-2 items-end">
                            <label class="font-bold text-purple-800 text-lg">ä¸‹åŠé•œå€¾æ–œè§’åº¦</label>
                            <span id="val-tilt" class="font-mono text-purple-600 bg-purple-50 px-2 py-0.5 rounded">0Â°</span>
                        </div>
                        <input type="range" id="slider-tilt" min="-45" max="45" value="0" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition-colors">
                        <p class="text-xs text-slate-400 mt-2">â† æ‹–åŠ¨æ»‘å—ï¼Œä¸‹åŠæˆªé•œå­å‘ç”Ÿæ—‹è½¬</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-500 text-sm text-purple-900 leading-relaxed shadow-sm">
                        <strong class="text-purple-700">é«˜é˜¶æ¢ç©¶ï¼š</strong> <br>
                        å½“é•œå­å€¾æ–œæ—¶ï¼Œå¯¹ç§°é¢å‘ç”Ÿäº†åè½¬ã€‚<br>
                        ä»”ç»†è§‚å¯Ÿç´«è‰²å…‰æŸå’Œç‰©åƒè¿çº¿ï¼ˆé»„è‰²è™šçº¿ï¼‰ï¼Œå®ƒä»¬å§‹ç»ˆä¿æŒ<b>å…³äºé•œé¢å‚ç›´å¯¹ç§°</b>ã€‚<br>
                        å› æ­¤ï¼Œåƒä¸ä»…ä½ç½®å˜äº†ï¼Œæ–¹å‘ä¹Ÿæ­ªäº†ã€‚
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ– ---
        const canvas = document.getElementById('simCanvas');
        const container = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');
        
        let currentMode = 'split'; 
        let params = {
            split: 0,
            depth: 0,
            tilt: 0
        };

        const config = {
            objX: -260,    // ç‰©ä½“ä½ç½®
            objH: 100,     // ç‰©ä½“é«˜åº¦
            mirrorX: 0,    // é•œå­åŸºå‡†ä½ç½®
            mirrorH: 240   // é•œå­é«˜åº¦
        };

        // --- DOM å…ƒç´ ç»‘å®š ---
        const radios = document.getElementsByName('scenario');
        const panels = {
            split: document.getElementById('panel-split'),
            depth: document.getElementById('panel-depth'),
            tilt: document.getElementById('panel-tilt')
        };
        const sliders = {
            split: document.getElementById('slider-split'),
            depth: document.getElementById('slider-depth'),
            tilt: document.getElementById('slider-tilt')
        };
        const labels = {
            split: document.getElementById('val-split'),
            depth: document.getElementById('val-depth'),
            tilt: document.getElementById('val-tilt')
        };
        const statusTip = document.getElementById('statusTip');

        // --- äº‹ä»¶ç›‘å¬ ---
        radios.forEach(r => {
            r.addEventListener('change', (e) => {
                currentMode = e.target.value;
                switchMode(currentMode);
            });
        });

        function switchMode(mode) {
            Object.values(panels).forEach(p => p.classList.add('hidden'));
            panels[mode].classList.remove('hidden');

            // å…³é”®é€»è¾‘ï¼šåˆ‡æ¢æ¨¡å¼æ—¶ï¼Œé‡ç½®æ‰€æœ‰å‚æ•°ä¸º0ï¼Œä¿è¯â€œä¸€å¼€å§‹æ˜¯ä¸€æ•´å—â€
            // ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨æ‹–åŠ¨æ»‘å—æ‰èƒ½çœ‹åˆ°æ•ˆæœ
            params.split = 0;
            params.depth = 0;
            params.tilt = 0;

            // é‡ç½®æ»‘å—UI
            sliders.split.value = 0;
            sliders.depth.value = 0;
            sliders.tilt.value = 0;

            update();
        }

        sliders.split.addEventListener('input', (e) => { params.split = parseInt(e.target.value); update(); });
        sliders.depth.addEventListener('input', (e) => { params.depth = parseInt(e.target.value); update(); });
        sliders.tilt.addEventListener('input',  (e) => { params.tilt = parseInt(e.target.value); update(); });

        // --- æ ¸å¿ƒç»˜å›¾é€»è¾‘ ---

        let cx, cy;
        function resize() {
            const rect = container.getBoundingClientRect();
            // è€ƒè™‘è®¾å¤‡åƒç´ æ¯”ï¼Œè®©ç”»é¢æ›´æ¸…æ™°
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            cx = canvas.width / 2;
            cy = canvas.height / 2;
            ctx.scale(dpr, dpr);
            // å­˜å‚¨é€»è¾‘å®½é«˜ç”¨äºè®¡ç®—
            window.logicWidth = rect.width;
            window.logicHeight = rect.height;
            window.logicCX = rect.width / 2;
            window.logicCY = rect.height / 2;
            
            draw();
        }
        window.addEventListener('resize', resize);

        function update() {
            labels.split.textContent = params.split + " px";
            labels.depth.textContent = params.depth + " px";
            labels.tilt.textContent = params.tilt + "Â°";

            if (params.depth > 0) {
                statusTip.textContent = "åƒåˆ†è£‚æˆä¸¤ä¸ª";
                statusTip.className = "absolute top-4 right-4 bg-amber-600/90 text-white px-5 py-2 rounded-full font-bold shadow-lg transition-all border border-white/20 backdrop-blur-sm";
            } else if (params.tilt !== 0) {
                statusTip.textContent = "åƒå‘ç”Ÿåè½¬";
                statusTip.className = "absolute top-4 right-4 bg-purple-600/90 text-white px-5 py-2 rounded-full font-bold shadow-lg transition-all border border-white/20 backdrop-blur-sm";
            } else if (params.split > 0) {
                statusTip.textContent = "åƒä½ç½®ä¸å˜ (é‡åˆ)";
                statusTip.className = "absolute top-4 right-4 bg-green-600/90 text-white px-5 py-2 rounded-full font-bold shadow-lg transition-all border border-white/20 backdrop-blur-sm";
            } else {
                statusTip.textContent = "å®Œæ•´å¹³é¢é•œæˆåƒ";
                statusTip.className = "absolute top-4 right-4 bg-blue-600/90 text-white px-5 py-2 rounded-full font-bold shadow-lg transition-all border border-white/20 backdrop-blur-sm";
            }

            draw();
        }

        // åæ ‡è½¬æ¢
        const toScreen = (x, y) => ({ x: window.logicCX + x, y: window.logicCY - y });

        // å¯¹ç§°ç‚¹è®¡ç®—
        function getReflection(px, py, x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const a = (dx * dx - dy * dy) / (dx * dx + dy * dy);
            const b = 2 * dx * dy / (dx * dx + dy * dy);
            const x2_ = a * (px - x1) + b * (py - y1) + x1;
            const y2_ = b * (px - x1) - a * (py - y1) + y1;
            return { x: x2_, y: y2_ };
        }

        function draw() {
            // ä½¿ç”¨é€»è¾‘å®½é«˜æ¸…ç©º
            ctx.clearRect(0, 0, window.logicWidth, window.logicHeight);

            // 1. ç»˜åˆ¶åœ°é¢/å…‰è½´
            ctx.beginPath();
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.moveTo(0, window.logicCY);
            ctx.lineTo(window.logicWidth, window.logicCY);
            ctx.stroke();

            // --- å®šä¹‰ç‰©ç†å¯¹è±¡ ---
            const objTop = { x: config.objX, y: config.objH };
            const objBot = { x: config.objX, y: 0 };
            const halfH = config.mirrorH / 2;
            
            // é•œå­1 (ä¸ŠåŠéƒ¨)
            const m1X = config.mirrorX;
            // å³ä½¿æ˜¯Unifiedï¼Œæˆ‘ä»¬ä¹ŸæŒ‰ä¸¤ä¸ªéƒ¨åˆ†è®¡ç®—ï¼Œåªè¦ä½ç½®é‡åˆå³å¯
            const m1BotY = params.split / 2;
            const m1TopY = m1BotY + halfH;
            
            // é•œå­2 (ä¸‹åŠéƒ¨)
            const m2CenterX = config.mirrorX + params.depth;
            const m2CenterY = -params.split/2 - halfH/2;
            const rad = params.tilt * Math.PI / 180;
            const dx = -Math.sin(rad) * (halfH/2);
            const dy = Math.cos(rad) * (halfH/2);
            const m2TopPt = { x: m2CenterX + dx, y: m2CenterY + dy };
            const m2BotPt = { x: m2CenterX - dx, y: m2CenterY - dy };

            // çŠ¶æ€åˆ¤æ–­
            const isUnified = (params.split === 0 && params.depth === 0 && params.tilt === 0);

            // --- åƒçš„è®¡ç®— ---
            const img1Top = { x: 2*m1X - objTop.x, y: objTop.y }; 
            const img1Bot = { x: 2*m1X - objBot.x, y: objBot.y };
            
            const img2Top = getReflection(objTop.x, objTop.y, m2TopPt.x, m2TopPt.y, m2BotPt.x, m2BotPt.y);
            const img2Bot = getReflection(objBot.x, objBot.y, m2TopPt.x, m2TopPt.y, m2BotPt.x, m2BotPt.y);

            // --- ç»˜åˆ¶è¾…åŠ©çº¿ ---
            ctx.save();
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            
            // ä¸Šé•œé¢æ— é™å¹³é¢
            ctx.strokeStyle = '#475569';
            drawInfiniteLine(ctx, m1X, 0, m1X, 100); 
            
            // ä¸‹é•œé¢æ— é™å¹³é¢ (ä»…å½“æœ‰å·®å¼‚æ—¶ç»˜åˆ¶)
            if (params.depth !== 0 || params.tilt !== 0) {
                ctx.strokeStyle = '#64748b';
                drawInfiniteLine(ctx, m2BotPt.x, m2BotPt.y, m2TopPt.x, m2TopPt.y);
            }
            ctx.restore();

            // ç‰©åƒè¿çº¿
            drawAuxConnection(ctx, objTop, img1Top, '#ef4444');
            if (!isUnified && (params.depth > 0 || params.tilt !== 0)) {
                drawAuxConnection(ctx, objBot, img2Bot, '#a855f7');
            } else if (isUnified) {
                // Unifiedæ—¶ï¼Œç‰©ä½“åº•éƒ¨è¿çº¿
                drawAuxConnection(ctx, objBot, img1Bot, '#ef4444');
            }


            // --- ç»˜åˆ¶å®ä½“ ---

            // åƒ2 (ç´«è‰²)
            if (!isUnified && (params.depth !== 0 || params.tilt !== 0 || params.split > 0)) {
                drawArrow(ctx, img2Bot, img2Top, '#c084fc', true);
                if(params.depth > 0 || params.tilt !== 0) {
                     ctx.fillStyle = '#c084fc'; 
                     ctx.font = '12px sans-serif';
                     ctx.fillText("åƒ2", toScreen(img2Top.x, img2Top.y).x + 10, toScreen(img2Top.x, img2Top.y).y);
                }
            }

            // åƒ1 (çº¢è‰²)
            drawArrow(ctx, img1Bot, img1Top, '#fca5a5', true);
            ctx.fillStyle = '#fca5a5'; 
            ctx.font = '14px sans-serif';
            ctx.fillText("åƒ", toScreen(img1Top.x, img1Top.y).x + 10, toScreen(img1Top.x, img1Top.y).y);

            // ç‰©ä½“ (å®ç‰©)
            drawArrow(ctx, objBot, objTop, '#ef4444', false);
            ctx.fillStyle = '#ef4444'; 
            ctx.fillText("ç‰©", toScreen(objTop.x, objTop.y).x - 20, toScreen(objTop.x, objTop.y).y);

            // é•œå­
            if (isUnified) {
                drawMirrorBar(ctx, m1X, -halfH, m1X, halfH); // åˆä½“
            } else {
                drawMirrorBar(ctx, m1X, m1BotY, m1X, m1TopY);
                drawMirrorBar(ctx, m2BotPt.x, m2BotPt.y, m2TopPt.x, m2TopPt.y);
            }

            // --- ç»˜åˆ¶å…‰æŸ (Ray Bundles) ---
            
            // å…‰æŸ1: ç‰©ä½“é¡¶éƒ¨ A -> ä¸Šé•œ -> åƒ A'
            // ä½¿ç”¨å…‰æŸï¼Œéœ€è¦å¤šä¸ªå…¥å°„ç‚¹ã€‚
            // ä¸Šé•œåŒºé—´ï¼šm1BotY åˆ° m1TopY
            const m1Start = {x: m1X, y: m1BotY};
            const m1End = {x: m1X, y: m1TopY};
            
            // å…‰æŸ2: ç‰©ä½“åº•éƒ¨ B -> ä¸‹é•œ -> åƒ B'
            // ä¸‹é•œåŒºé—´ï¼šm2BotPt åˆ° m2TopPt
            
            // ç»˜åˆ¶é€»è¾‘
            // A -> Top Mirror (Reddish)
            drawLightBundle(ctx, objTop, m1Start, m1End, img1Top, '#fca5a5', '#ef4444');
            
            // B -> Bottom Mirror (Purplish)
            // å¦‚æœUnifiedï¼Œå…¶å®Bottom Mirrorå°±åœ¨Top Mirrorä¸‹é¢ã€‚
            // æˆ‘ä»¬ä¾ç„¶åˆ†åˆ«ç”»ï¼Œå±•ç¤ºä¸Šä¸‹ä¸¤éƒ¨åˆ†çš„å…‰è·¯ã€‚
            drawLightBundle(ctx, objBot, m2BotPt, m2TopPt, img2Bot, '#d8b4fe', '#a855f7');

        }

        // --- ç»˜å›¾è¾…åŠ©å‡½æ•° ---

        function drawLightBundle(ctx, pStart, mStart, mEnd, pImg, rayColor, coreColor) {
            const steps = 6; // å…‰çº¿æ•°é‡
            const startS = toScreen(pStart.x, pStart.y);
            const imgS = toScreen(pImg.x, pImg.y);

            for (let i = 1; i < steps; i++) {
                const t = i / steps;
                // æ’å€¼è®¡ç®—é•œé¢ä¸Šçš„å…¥å°„ç‚¹
                const mx = mStart.x + (mEnd.x - mStart.x) * t;
                const my = mStart.y + (mEnd.y - mStart.y) * t;
                const hitS = toScreen(mx, my);

                // 1. å…¥å°„å…‰çº¿ (å˜æš—)
                ctx.beginPath();
                ctx.strokeStyle = rayColor;
                ctx.lineWidth = 1; // ç»†çº¿
                ctx.globalAlpha = 0.3; // è°ƒæš—
                ctx.moveTo(startS.x, startS.y);
                ctx.lineTo(hitS.x, hitS.y);
                ctx.stroke();

                // 2. åå°„å…‰çº¿
                // è®¡ç®—æ–¹å‘ (hit -> ext)
                const dx = hitS.x - imgS.x;
                const dy = hitS.y - imgS.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                const scale = 200 / len; // å»¶é•¿

                ctx.beginPath();
                ctx.moveTo(hitS.x, hitS.y);
                ctx.lineTo(hitS.x + dx * scale, hitS.y + dy * scale);
                ctx.stroke();

                // 3. åå‘å»¶é•¿çº¿ (ææ·¡)
                ctx.beginPath();
                ctx.setLineDash([2, 4]);
                ctx.globalAlpha = 0.15;
                ctx.moveTo(imgS.x, imgS.y);
                ctx.lineTo(hitS.x, hitS.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            ctx.globalAlpha = 1.0;

            // ç”»ä¸€æ¡ä¸­å¿ƒä¸»å…‰çº¿ (é«˜äº®)
            const t = 0.5;
            const mx = mStart.x + (mEnd.x - mStart.x) * t;
            const my = mStart.y + (mEnd.y - mStart.y) * t;
            const hitS = toScreen(mx, my);
            
            ctx.beginPath();
            ctx.strokeStyle = coreColor;
            ctx.lineWidth = 1.5;
            ctx.globalAlpha = 0.8;
            ctx.moveTo(startS.x, startS.y);
            ctx.lineTo(hitS.x, hitS.y);
            ctx.stroke();

            const dx = hitS.x - imgS.x;
            const dy = hitS.y - imgS.y;
            const len = Math.sqrt(dx*dx + dy*dy);
            const scale = 200 / len;
            
            ctx.beginPath();
            ctx.moveTo(hitS.x, hitS.y);
            ctx.lineTo(hitS.x + dx * scale, hitS.y + dy * scale);
            ctx.stroke();
            ctx.globalAlpha = 1.0;

            // ç”»ç®­å¤´
            drawRayArrow(ctx, startS, hitS);
            drawRayArrow(ctx, hitS, {x: hitS.x + dx * scale, y: hitS.y + dy * scale});
        }

        function drawAuxConnection(ctx, p1, p2, color) {
            const s1 = toScreen(p1.x, p1.y);
            const s2 = toScreen(p2.x, p2.y);
            ctx.beginPath();
            ctx.strokeStyle = '#fbbf24'; 
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            ctx.moveTo(s1.x, s1.y);
            ctx.lineTo(s2.x, s2.y);
            ctx.stroke();
            ctx.setLineDash([]);
            const midX = (s1.x + s2.x) / 2;
            const midY = (s1.y + s2.y) / 2;
            ctx.fillStyle = color;
            ctx.fillRect(midX - 2, midY - 2, 4, 4);
        }

        function drawInfiniteLine(ctx, x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const len = 3000;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 0.001) return;
            const ux = dx/dist;
            const uy = dy/dist;
            const p1 = toScreen(x1 - ux*len, y1 - uy*len);
            const p2 = toScreen(x1 + ux*len, y1 + uy*len);
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
        }

        function drawMirrorBar(ctx, x1, y1, x2, y2) {
            const p1 = toScreen(x1, y1);
            const p2 = toScreen(x2, y2);
            ctx.beginPath();
            ctx.strokeStyle = '#06b6d4'; 
            ctx.lineWidth = 8;
            ctx.lineCap = 'butt'; 
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 2;
            ctx.moveTo(p1.x + 2, p1.y); 
            ctx.lineTo(p2.x + 2, p2.y);
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 1;
            const dist = Math.sqrt((p2.x-p1.x)**2 + (p2.y-p1.y)**2);
            const steps = Math.floor(dist / 8);
            for(let i=0; i<=steps; i++) {
                const t = i/steps;
                const px = p1.x + (p2.x - p1.x)*t;
                const py = p1.y + (p2.y - p1.y)*t;
                ctx.moveTo(px, py);
                ctx.lineTo(px + 6, py + 6);
            }
            ctx.stroke();
        }

        function drawArrow(ctx, p1World, p2World, color, dashed) {
            const p1 = toScreen(p1World.x, p1World.y);
            const p2 = toScreen(p2World.x, p2World.y);
            
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            if (dashed) ctx.setLineDash([6, 4]);
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
            ctx.setLineDash([]);

            const headLen = 14;
            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.moveTo(p2.x, p2.y);
            ctx.lineTo(p2.x - headLen * Math.cos(angle - Math.PI / 6), p2.y - headLen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(p2.x - headLen * Math.cos(angle + Math.PI / 6), p2.y - headLen * Math.sin(angle + Math.PI / 6));
            ctx.fill();
        }

        function drawRayArrow(ctx, p1, p2) {
            const t = 0.6; 
            const mx = p1.x + (p2.x - p1.x) * t;
            const my = p1.y + (p2.y - p1.y) * t;
            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
            const len = 6;
            
            ctx.beginPath();
            ctx.strokeStyle = ctx.strokeStyle; 
            ctx.lineWidth = 1.5;
            ctx.moveTo(mx, my);
            ctx.lineTo(mx - len * Math.cos(angle - Math.PI / 6), my - len * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(mx, my);
            ctx.lineTo(mx - len * Math.cos(angle + Math.PI / 6), my - len * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        setTimeout(resize, 100); 
        switchMode('split');
    </script>
</body>
</html>