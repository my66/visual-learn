<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸­æ•°å­¦ï¼šè´Ÿæ•°æ„ä¹‰ä¸ç»å¯¹å€¼æ•°è½´æ¼”ç¤º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        #controls {
            width: 300px;
            background: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        h1 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 5px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .value-display {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
            text-align: center;
            margin: 5px 0;
            font-family: monospace;
        }

        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        #btn-run {
            background-color: #2ecc71;
            color: white;
            box-shadow: 0 4px 0 #27ae60;
        }
        #btn-run:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #27ae60;
        }
        
        #btn-reset {
            background-color: #95a5a6;
            color: white;
            margin-top: 5px;
        }
        #btn-reset:hover { background-color: #7f8c8d; }

        .tips-box {
            font-size: 13px;
            color: #666;
            background: #eef2f5;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.6;
        }
        
        .tips-box strong {
            color: #2c3e50;
        }

        /* å³ä¾§ç”»å¸ƒå®¹å™¨ */
        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eef2f5;
            position: relative;
            cursor: crosshair;
        }
    </style>
</head>
<body>

    <div id="controls">
        <h1>ğŸƒ æ•°è½´è·‘é“ v2.1</h1>
        
        <div class="control-group">
            <label>è®¾å®šç›®æ ‡ä½ç½® (x)</label>
            <input type="range" id="target-slider" min="-8" max="8" step="1" value="-3">
            <div class="value-display" id="target-val">-3</div>
        </div>

        <button id="btn-run">å¼€å§‹è·‘åŠ¨ (GO)</button>
        <button id="btn-reset">å›åˆ°åŸç‚¹ (Reset)</button>

        <div class="tips-box">
            <strong>æ ¸å¿ƒè§‚å¯Ÿç‚¹ï¼š</strong>
            <ul style="margin:5px 0; padding-left:20px;">
                <li>æ³¨æ„çœ‹å°äººå¤´é¡¶çš„æ°”æ³¡å˜åŒ–ã€‚</li>
                <li>è´Ÿå·(-)å‡ºç°æ—¶ï¼Œå°äººä¼š<b>è½¬èº«</b>ã€‚</li>
                <li>ç»å¯¹å€¼(è·ç¦»)æ°¸è¿œåœ¨å¢åŠ ï¼Œä¸ä¼šå˜è´Ÿã€‚</li>
            </ul>
        </div>
        
        <div style="margin-top:auto; font-size:12px; color:#999; text-align:center;">
            å»ºè®®å…¨å±è§‚çœ‹æ•™å­¦
        </div>
    </div>

    <div id="canvas-container"></div>

    <script>
        // p5.js Sketch
        let slider;
        let btnRun, btnReset;
        let targetValDisplay;

        // System Constants
        const UNIT_PIXELS = 70; // æ”¾å¤§ä¸€ç‚¹é—´è·ä»¥ä¾¿æ˜¾ç¤ºæ°”æ³¡
        const LINE_Y = 60; // ç¨å¾®ä¸‹ç§»ä¸€ç‚¹ï¼Œç•™å‡ºæ›´å¤šä¸Šæ–¹ç©ºé—´
        
        // State Variables
        let runner = {
            x: 0,           // Visual X (pixels relative to center)
            val: 0,         // Logical Value (float)
            facing: 1,      // 1 = Right, -1 = Left
            state: 'IDLE',  // IDLE, TURNING, RUNNING, ARRIVED
            targetVal: -3,  // Target integer
            fuelUsed: 0     // Pedometer (Absolute distance)
        };

        let animTimer = 0;

        function setup() {
            let canvas = createCanvas(windowWidth - 300, windowHeight);
            canvas.parent('canvas-container');
            
            slider = select('#target-slider');
            targetValDisplay = select('#target-val');
            
            btnRun = select('#btn-run');
            btnRun.mousePressed(startRun);
            
            btnReset = select('#btn-reset');
            btnReset.mousePressed(resetRunner);
            
            slider.input(updateUI);
            updateUI(); 
        }

        function windowResized() {
            resizeCanvas(windowWidth - 300, windowHeight);
        }

        function updateUI() {
            let val = int(slider.value());
            runner.targetVal = val;
            
            let signStr = val > 0 ? "+" : (val < 0 ? "-" : "");
            let colorStr = val > 0 ? "green" : (val < 0 ? "red" : "black");
            
            // Format + sign for positive numbers
            let displayNum = val > 0 ? "+" + val : val;
            targetValDisplay.html(displayNum);
            targetValDisplay.style('color', colorStr);
            
            // If dragging slider while idle, reset logic to allow new visualization
            if (runner.state === 'IDLE') {
                // Don't move runner yet, wait for GO
            }
        }

        function startRun() {
            // Always start from 0 for clear concept demonstration
            resetRunnerState(); 
            
            if (runner.targetVal === 0) {
                runner.state = 'ARRIVED';
                return;
            }

            runner.state = 'TURNING';
            animTimer = 0;
        }

        function resetRunner() {
            resetRunnerState();
            slider.value(0);
            updateUI();
        }
        
        function resetRunnerState() {
            runner.val = 0;
            runner.x = 0;
            runner.facing = 1;
            runner.state = 'IDLE';
            runner.fuelUsed = 0;
        }

        function draw() {
            background(245, 247, 250);
            
            translate(width / 2, height / 2); // Origin at center

            // 1. Draw Number Line
            drawNumberLine();

            // 2. Draw Origin Flag
            drawOriginFlag();

            // 3. Update Logic
            updateRunnerLogic();

            // 4. Draw Runner Character
            drawRunnerCharacter();

            // 5. Draw Dynamic Info Bubble (The Core Feature)
            drawInfoBubble();
        }

        function drawNumberLine() {
            push();
            translate(0, LINE_Y);
            
            // Main axis
            stroke(160);
            strokeWeight(3);
            line(-width/2 + 20, 0, width/2 - 20, 0);

            // Arrow heads
            fill(160);
            noStroke();
            triangle(width/2 - 20, -6, width/2 - 20, 6, width/2 - 5, 0);
            triangle(-width/2 + 20, -6, -width/2 + 20, 6, -width/2 + 5, 0);

            // Ticks
            let range = floor((width / 2) / UNIT_PIXELS);
            for (let i = -range; i <= range; i++) {
                let x = i * UNIT_PIXELS;
                
                stroke(160);
                strokeWeight(2);
                line(x, -5, x, 5);
                
                noStroke();
                fill(100);
                textAlign(CENTER, TOP);
                
                if (i === 0) {
                    textStyle(BOLD);
                    fill(231, 76, 60); // Red for Origin
                    textSize(16);
                } else {
                    textStyle(NORMAL);
                    textSize(14);
                }
                text(i, x, 15);
            }
            pop();
        }

        function drawOriginFlag() {
            let x = 0;
            let y = LINE_Y;
            
            stroke(200);
            strokeWeight(2);
            line(x, y, x, y - 50); // Pole
            
            fill(231, 76, 60);
            noStroke();
            rect(x, y - 50, 25, 16); // Flag
            
            fill(255);
            textSize(10);
            textAlign(CENTER, CENTER);
            text("0", x + 12.5, y - 42);
        }

        function updateRunnerLogic() {
            let targetX = runner.targetVal * UNIT_PIXELS;
            
            if (runner.state === 'TURNING') {
                animTimer += 0.04; // Slower turn for emphasis
                
                let desiredFacing = runner.targetVal >= 0 ? 1 : -1;
                
                if (desiredFacing === 1) {
                    runner.facing = 1;
                    runner.state = 'RUNNING';
                } else {
                    if (animTimer > 0.8) {
                        runner.facing = desiredFacing;
                        runner.state = 'RUNNING';
                    }
                }
                
            } else if (runner.state === 'RUNNING') {
                let speed = 4; // pixels per frame
                let dist = targetX - runner.x;
                
                if (Math.abs(dist) <= speed) {
                    runner.x = targetX;
                    runner.state = 'ARRIVED';
                    runner.fuelUsed = Math.abs(runner.targetVal); // Ensure exact final value
                } else {
                    let move = dist > 0 ? speed : -speed;
                    runner.x += move;
                    runner.fuelUsed += Math.abs(move) / UNIT_PIXELS;
                }
            }
        }

        function drawRunnerCharacter() {
            push();
            translate(runner.x, LINE_Y);
            
            // Draw Trail (Distance visualization)
            let trailColor = runner.targetVal >= 0 ? 'rgba(46, 204, 113, 0.4)' : 'rgba(231, 76, 60, 0.4)';
            stroke(trailColor);
            strokeWeight(8);
            strokeCap(ROUND);
            line(-runner.x, 0, 0, 0); 
            
            // Character drawing
            scale(runner.facing, 1); 
            
            // Head
            fill(255);
            stroke(50);
            strokeWeight(2);
            ellipse(0, -40, 24, 24);
            
            // Eyes
            fill(50);
            noStroke();
            ellipse(6, -42, 4, 4); 
            
            // Body
            stroke(50);
            strokeWeight(2);
            line(0, -28, 0, -10);
            
            // Animation States
            if (runner.state === 'RUNNING') {
                let armS = sin(frameCount * 0.3) * 8;
                let legS = cos(frameCount * 0.3) * 8;
                line(0, -25, 10, -20 + armS);
                line(0, -25, -10, -20 - armS);
                line(0, -10, 8 + legS, 10);
                line(0, -10, -8 - legS, 10);
            } else if (runner.state === 'TURNING') {
                line(0, -25, 8, -35); // Hand up
                line(0, -25, -5, -15);
                line(0, -10, 5, 10);
                line(0, -10, -5, 10);
                fill(0, 150, 255);
                noStroke();
                ellipse(-15, -50, 4, 6);
            } else {
                line(0, -25, 5, -15);
                line(0, -25, -5, -15);
                line(0, -10, 4, 10);
                line(0, -10, -4, 10);
            }
            pop();
        }

        // --- The New Core Feature: Dynamic Info Bubble ---
        function drawInfoBubble() {
            // Position above runner
            let bx = runner.x;
            // è°ƒæ•´ä½ç½®ï¼šä»åŸæ¥çš„ -80 ä¸Šç§»åˆ° -135ï¼Œå¤§å¹…æå‡é«˜åº¦é¿å…é®æŒ¡
            let by = LINE_Y - 135; 
            
            // Bubble dimensions
            let bWidth = 180; // ç¨å¾®åŠ å®½
            let bHeight = 100; // ç¨å¾®åŠ é«˜ä»¥å®¹çº³æ›´æ¸…æ™°çš„åº•éƒ¨æ–‡å­—
            let r = 10;
            
            let bob = sin(frameCount * 0.05) * 3;
            by += bob;

            push();
            translate(bx, by);
            
            // 1. Draw Bubble Shape
            fill(255, 255, 255, 245);
            stroke(100);
            strokeWeight(1);
            drawingContext.shadowBlur = 10;
            drawingContext.shadowColor = "rgba(0,0,0,0.15)";
            rect(-bWidth/2, -bHeight/2, bWidth, bHeight, r);
            noStroke();
            fill(255, 255, 255, 245);
            triangle(-8, bHeight/2, 8, bHeight/2, 0, bHeight/2 + 10);
            drawingContext.shadowBlur = 0;

            // 2. Content Logic
            textAlign(CENTER, CENTER);
            noStroke();
            
            // --- TOP ROW: Target Number ---
            let numColor = runner.targetVal >= 0 ? '#27ae60' : '#c0392b';
            fill(numColor);
            textSize(24);
            textStyle(BOLD);
            let sign = runner.targetVal > 0 ? "+" : "";
            text(sign + runner.targetVal, 0, -30); // ç¨å¾®ä¸Šç§»

            // --- MIDDLE ROW: Action/State ---
            textSize(14);
            textStyle(NORMAL);
            fill(80);
            let actionText = "";
            
            if (runner.state === 'IDLE') {
                actionText = "å‡†å¤‡å‡ºå‘";
            } else if (runner.state === 'TURNING') {
                fill('#e67e22'); // Orange for alert
                textStyle(BOLD);
                if (runner.targetVal < 0) actionText = "âš ï¸ è´Ÿå·: å‘åè½¬!";
                else actionText = "æ­£å·: ä¿æŒå‘å‰";
            } else if (runner.state === 'RUNNING') {
                actionText = "æ­£åœ¨ç§»åŠ¨...";
            } else if (runner.state === 'ARRIVED') {
                actionText = "åˆ°è¾¾ç»ˆç‚¹";
            }
            text(actionText, 0, -5); // å±…ä¸­

            // --- BOTTOM ROW: Absolute Value / Distance ---
            // ç»˜åˆ¶ä¸€ä¸ªæ›´æ˜æ˜¾çš„â€œæ•°æ®æ¡â€èƒŒæ™¯
            fill(235, 245, 251); // æµ…è“è‰²èƒŒæ™¯
            rectMode(CENTER);
            rect(0, 28, 160, 26, 4);
            
            fill('#2980b9');
            textSize(14); // å­—ä½“ç¨å¾®åŠ å¤§
            textStyle(BOLD);
            
            let currentDist = nf(runner.fuelUsed, 1, 1);
            if (runner.state === 'ARRIVED') currentDist = Math.abs(runner.targetVal); // Snap to int
            
            let mathStr = `è·ç¦»ç´¯ç§¯: ${currentDist}`;
            
            if (runner.state === 'ARRIVED') {
                // é‡ç‚¹ï¼šæ¸…æ™°å±•ç¤ºç»å¯¹å€¼ç­‰äºè·ç¦»
                mathStr = `ç»å¯¹å€¼ = è·ç¦» = ${currentDist}`;
            } else if (runner.state === 'IDLE') {
                mathStr = `è·ç¦»: 0.0`;
            }
            
            text(mathStr, 0, 29); // åœ¨æ¡å½¢æ¡†å†…å±…ä¸­

            pop();
        }

    </script>
</body>
</html>