<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰çš„æŠ˜å°„ï¼šå²¸ä¸Šçœ‹é±¼ (Apparent Depth)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header {
            background-color: #ffffff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            color: #1a73e8;
            font-size: 1.5rem;
        }

        p.subtitle {
            margin: 0.5rem 0 0;
            color: #5f6368;
            font-size: 0.9rem;
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ */
        #main-container {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden; /* å†…éƒ¨æ»šåŠ¨ */
            height: calc(100vh - 80px); /* å‡å»å¤´éƒ¨é«˜åº¦ */
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        #controls {
            width: 320px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            flex-shrink: 0;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #202124;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
            display: inline-block;
        }

        .control-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .control-item label {
            font-size: 0.9rem;
            color: #3c4043;
            user-select: none;
        }

        /* è‡ªå®šä¹‰æ»‘å— */
        input[type=range] {
            width: 120px;
            accent-color: #1a73e8;
        }

        /* è‡ªå®šä¹‰å¤é€‰æ¡† */
        input[type=checkbox] {
            transform: scale(1.2);
            accent-color: #1a73e8;
            cursor: pointer;
        }

        /* çŠ¶æ€æ˜¾ç¤ºåŒº */
        #status-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #202124;
            color: #4caf50;
            padding: 10px;
            border-radius: 4px;
            line-height: 1.4;
        }

        /* å³ä¾§ç”»å¸ƒå®¹å™¨ */
        #canvas-container {
            flex: 1;
            position: relative;
            background-color: #ffffff;
            overflow: hidden;
            cursor: crosshair;
        }
        
        /* æç¤ºæµ®å±‚ */
        .overlay-hint {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
            font-size: 0.9rem;
            color: #1a73e8;
            font-weight: bold;
        }

        /* é’ˆå¯¹å°å±å¹•çš„ç®€å•é€‚é… */
        @media (max-width: 800px) {
            #main-container {
                flex-direction: column;
                overflow-y: auto;
            }
            #controls {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            #canvas-container {
                height: 500px; /* ç§»åŠ¨ç«¯å›ºå®šé«˜åº¦ */
            }
        }
    </style>
    <!-- å¼•å…¥ p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
</head>
<body>

<header>
    <h1>å…‰çš„æŠ˜å°„ï¼šå²¸ä¸Šçœ‹é±¼ (Apparent Depth)</h1>
    <p class="subtitle">äº’åŠ¨æ¼”ç¤ºï¼šå…‰ä»æ°´ä¸­å°„å…¥ç©ºæ°”å‘ç”ŸæŠ˜å°„ï¼Œå¯¼è‡´é±¼çœ‹èµ·æ¥å˜æµ…ï¼ˆè§†æ·±ç°è±¡ï¼‰</p>
</header>

<div id="main-container">
    <div id="controls">
        <div class="control-group">
            <h3>åŸç†è§£æ</h3>
            <p style="font-size: 0.85rem; color: #555; line-height: 1.5;">
                å¦‚å›¾æ‰€ç¤ºï¼Œå…‰çº¿ä»æ°´ï¼ˆå…‰å¯†ä»‹è´¨ï¼‰å°„å‘ç©ºæ°”ï¼ˆå…‰ç–ä»‹è´¨ï¼‰ã€‚<br><br>
                1. <b>æŠ˜å°„è§„å¾‹</b>ï¼šæŠ˜å°„è§’ &gt; å…¥å°„è§’ï¼ˆè¿œç¦»æ³•çº¿ï¼‰ã€‚<br>
                2. <b>æˆåƒåŸç†</b>ï¼šäººçœ¼é€†ç€æŠ˜å°„å…‰çº¿çœ‹å»ï¼Œå…‰çº¿çš„åå‘å»¶é•¿çº¿äº¤æ±‡ç‚¹å³ä¸º<b>è™šåƒ B</b>ã€‚<br>
                3. <b>ç»“æœ</b>ï¼šçœ‹åˆ°çš„é±¼ B æ¯”å®é™…çš„é±¼ A ä½ç½®æ›´æµ…ã€‚
            </p>
        </div>

        <div class="control-group">
            <h3>æ˜¾ç¤ºè®¾ç½®</h3>
            <div class="control-item">
                <label for="toggle-normal">æ˜¾ç¤ºæ³•çº¿ (Normal)</label>
                <input type="checkbox" id="toggle-normal" checked>
            </div>
            <div class="control-item">
                <label for="toggle-angles">æ˜¾ç¤ºè§’åº¦ (Angles)</label>
                <input type="checkbox" id="toggle-angles" checked>
            </div>
            <div class="control-item">
                <label for="toggle-virtual">æ˜¾ç¤ºè™šåƒä¸è§†æ·± (Virtual Image)</label>
                <input type="checkbox" id="toggle-virtual" checked>
            </div>
            <div class="control-item">
                <label for="toggle-rays">æ˜¾ç¤ºè¾…åŠ©å…‰æŸ (Ray Beam)</label>
                <input type="checkbox" id="toggle-rays">
            </div>
        </div>

        <div class="control-group">
            <h3>ç¯å¢ƒå‚æ•°</h3>
            <div class="control-item">
                <label>æ°´çš„æŠ˜å°„ç‡ (n): <span id="val-n">1.33</span></label>
                <input type="range" id="slider-n" min="1.0" max="2.0" step="0.01" value="1.33">
            </div>
        </div>

        <div id="status-display">
            ç­‰å¾…æ“ä½œ...
        </div>
        
        <div style="margin-top: auto; font-size: 0.8rem; color: #999;">
            æ“ä½œæç¤ºï¼šç›´æ¥æ‹–åŠ¨ç”»é¢ä¸­çš„â€œé±¼â€æˆ–â€œçœ¼ç›â€æ”¹å˜ä½ç½®ã€‚
        </div>
    </div>

    <div id="canvas-container">
        <div class="overlay-hint">ğŸ’¡ è¯•ä¸€è¯•ï¼šæ‹–åŠ¨æ°´ä¸­çš„é±¼æˆ–ç©ºä¸­çš„çœ¼ç›</div>
    </div>
</div>

<script>
/**
 * è§†æ·±ç°è±¡äº’åŠ¨ä»¿çœŸ
 * å¼•æ“ï¼šp5.js (æ— ç‰©ç†å¼•æ“ï¼Œçº¯å‡ ä½•è®¡ç®—)
 * æ ¸å¿ƒç®—æ³•ï¼šä½¿ç”¨äºŒåˆ†æ³•/ç‰›é¡¿è¿­ä»£æ±‚è§£è´¹é©¬åŸç†ï¼ˆå¯»æ‰¾å…‰ç¨‹æå€¼ç‚¹/æ»¡è¶³æ–¯æ¶…å°”å®šå¾‹çš„å…¥å°„ç‚¹ï¼‰
 */

// å…¨å±€å˜é‡
let fishPos, eyePos;
let waterLevel; // æ°´é¢ Y åæ ‡
let draggingFish = false;
let draggingEye = false;

// ç‰©ç†å¸¸é‡
let nAir = 1.00;
let nWater = 1.33;

// UI çŠ¶æ€
let showNormal = true;
let showAngles = true;
let showVirtual = true;
let showRays = false; // æ˜¯å¦æ˜¾ç¤ºä¸€æŸå…‰ï¼ˆè€Œä¸åªæ˜¯ä¸€æ¡çº¿ï¼‰

// é±¼å’Œçœ¼ç›çš„å›¾æ ‡ç»˜åˆ¶å‚æ•°
const fishSize = 40;
const eyeSize = 30;

function setup() {
    // åˆ›å»ºç”»å¸ƒå¹¶æ”¾å…¥å®¹å™¨
    let container = document.getElementById('canvas-container');
    let w = container.offsetWidth;
    let h = container.offsetHeight;
    let canvas = createCanvas(w, h);
    canvas.parent('canvas-container');
    
    // åˆå§‹åŒ–ä½ç½®
    waterLevel = height * 0.45; // æ°´é¢ä½ç½®
    fishPos = createVector(width * 0.3, height * 0.75); // åˆå§‹é±¼åœ¨å·¦ä¸‹
    eyePos = createVector(width * 0.7, height * 0.2);  // åˆå§‹çœ¼åœ¨å³ä¸Š

    // ç»‘å®š UI äº‹ä»¶
    select('#slider-n').input(e => {
        nWater = parseFloat(e.target.value);
        select('#val-n').html(nWater.toFixed(2));
    });
    
    select('#toggle-normal').changed(e => showNormal = e.target.checked);
    select('#toggle-angles').changed(e => showAngles = e.target.checked);
    select('#toggle-virtual').changed(e => showVirtual = e.target.checked);
    select('#toggle-rays').changed(e => showRays = e.target.checked);
}

function windowResized() {
    let container = document.getElementById('canvas-container');
    resizeCanvas(container.offsetWidth, container.offsetHeight);
    waterLevel = height * 0.45;
    // é™åˆ¶é±¼å’Œçœ¼ä¸è·‘å‡ºå±å¹•
    clampPositions();
}

function draw() {
    background(255);
    
    // 1. ç»˜åˆ¶ç¯å¢ƒ (æ°´å’Œç©ºæ°”)
    drawEnvironment();

    // 2. è®¡ç®—å…‰è·¯äº¤ç‚¹ (ç•Œé¢ä¸Šçš„æŠ˜å°„ç‚¹)
    // é—®é¢˜ï¼šå·²çŸ¥ç‚¹ A(é±¼) å’Œ B(çœ¼)ï¼Œæ±‚ç•Œé¢ä¸Šçš„ç‚¹ P(x, waterLevel)ï¼Œä½¿å¾—æ»¡è¶³æ–¯æ¶…å°”å®šå¾‹ã€‚
    // è¿™æ˜¯ä¸€ä¸ªæ±‚æ ¹é—®é¢˜ã€‚å‡½æ•° f(x) = n1 * sin(theta1) - n2 * sin(theta2) = 0
    let incidenceX = solveSnell(fishPos, eyePos, waterLevel, nWater, nAir);
    let incidencePoint = createVector(incidenceX, waterLevel);

    // 3. è®¡ç®—è™šåƒä½ç½® (Image B)
    // è™šåƒæ˜¯æŠ˜å°„å…‰çº¿åå‘å»¶é•¿çº¿ä¸ é±¼æ‰€åœ¨çš„å‚ç›´çº¿çš„äº¤ç‚¹ (ç®€åŒ–æ¨¡å‹) 
    // æˆ–è€…æ›´å‡†ç¡®åœ°ï¼šç”±å¾®å°å…‰æŸåå‘å»¶é•¿äº¤æ±‡ç‚¹ã€‚
    // åœ¨å•çœ¼è§‚å¯Ÿæ¨¡å‹ä¸­ï¼Œé€šå¸¸è®¤ä¸ºè™šåƒåœ¨æŠ˜å°„å…‰çº¿çš„åå‘å»¶é•¿çº¿ä¸Šï¼Œä¸”ä¸ç‰©ä½“åœ¨åŒä¸€å‚ç›´çº¿ä¸Šï¼ˆè¿™æ˜¯æ—è½´è¿‘ä¼¼ä¸‹çš„ç»“æœï¼‰ã€‚
    // ä½†ä¸ºäº†æ›´ä¸¥è°¨çš„å‡ ä½•ä½œå›¾ï¼Œå±•ç¤ºâ€œè§†æ·±â€ï¼Œæˆ‘ä»¬å–æŠ˜å°„å…‰çº¿çš„åå‘å»¶é•¿çº¿ï¼Œä¸â€œé±¼çš„å‚ç›´çº¿â€çš„äº¤ç‚¹ä½œä¸ºè™šåƒä½ç½®ã€‚
    // (å®é™…ä¸Šï¼ŒåŒçœ¼è§†è§‰ä¼šæœ‰è§†å·®ï¼Œä½†åœ¨2Dç¤ºæ„å›¾ä¸­ï¼Œæ•™ç§‘ä¹¦é€šå¸¸å®šä¹‰ä¸ºï¼šh' = h / n)
    
    // è®¡ç®—æŠ˜å°„å…‰çº¿ï¼ˆç•Œé¢->çœ¼ï¼‰çš„æ–¹å‘å‘é‡
    let rayDir = p5.Vector.sub(eyePos, incidencePoint).normalize();
    
    // è®¡ç®—è™šåƒåæ ‡
    // è™šåƒ X åæ ‡è¿‘ä¼¼ç­‰äº å®ç‰© X åæ ‡ (å‚ç›´å…¥å°„æ—¶)ï¼Œä½†åœ¨æ–œå°„æ—¶ï¼Œåƒä¼šå‘ç”Ÿä¾§ç§»ã€‚
    // ä¸ºäº†ç¬¦åˆæ•™ç§‘ä¹¦å›¾ç¤º (é€šå¸¸åªç”»æ·±åº¦å˜åŒ–ï¼Œå¿½ç•¥ä¾§ç§»ï¼Œæˆ–è€…ç”»å‡ºä¾§ç§»)ï¼Œæˆ‘ä»¬ç”¨åå‘å»¶é•¿çº¿æ³•ã€‚
    // è™šåƒç‚¹ V æ»¡è¶³ï¼š V åœ¨ç›´çº¿ (incidencePoint + t * rayDir) ä¸Šã€‚
    // ä¸” V.x = fishPos.x (è¿™æ˜¯è¿‘ä¼¼ï¼Œå®é™…ä¸Šä¼šæœ‰ä¾§ç§»ï¼Œæ•™ç§‘ä¹¦å›¾ C ä¸­ é±¼B å’Œ é±¼A åœ¨åŒä¸€å‚ç›´çº¿ä¸Šå—ï¼Ÿ
    // ä»”ç»†çœ‹é¢˜ç›®å›¾ï¼ŒB ç•¥å¾®åå·¦ã€‚
    // æ­£ç¡®çš„ç‰©ç†åšæ³•ï¼šè™šåƒä½ç½®å–å†³äºè§‚å¯Ÿè§’åº¦ã€‚
    // æˆ‘ä»¬ç”¨åå‘å»¶é•¿çº¿ä¸ x = fishPos.x çš„äº¤ç‚¹ä½œä¸ºâ€œè§†ä½ç½®â€ã€‚
    
    // ä¿®æ­£ï¼šå®é™…ä¸Šï¼Œäººçœ¼çœ‹åˆ°çš„è™šåƒæ˜¯ç”±è¿›å…¥ç³å­”çš„å¾®å°å…‰æŸå†³å®šçš„ã€‚
    // å¯¹å•æ¡å…‰çº¿è€Œè¨€ï¼Œè™šåƒå°±åœ¨åå‘å»¶é•¿çº¿ä¸Šä»»ä½•åœ°æ–¹ã€‚
    // ä½†ä¸ºäº†ç¡®å®šæ·±åº¦ï¼Œæˆ‘ä»¬é€šå¸¸æ±‚ä¸¤æ¡å¾®å°å…‰çº¿çš„äº¤ç‚¹ï¼Œæˆ–è€…ç®€å•åœ°æ±‚åå‘å»¶é•¿çº¿ä¸ x=fishX çš„äº¤ç‚¹ã€‚
    // ä¸ºäº†æ¼”ç¤ºæ•ˆæœæœ€ä½³ï¼Œæˆ‘ä»¬è®¡ç®—åå‘å»¶é•¿çº¿ä¸ x=fishX çš„äº¤ç‚¹ã€‚
    
    let slope = (eyePos.y - incidencePoint.y) / (eyePos.x - incidencePoint.x);
    // ç›´çº¿æ–¹ç¨‹: y - y0 = k(x - x0)  =>  y = k(x - x0) + y0
    // ä»¤ x = fishPos.x
    let virtualY = slope * (fishPos.x - incidencePoint.x) + incidencePoint.y;
    let virtualPos = createVector(fishPos.x, virtualY); 
    
    // å¦‚æœçœ¼å’Œé±¼åœ¨åŒä¸€ä¾§ï¼ˆä¸å¯èƒ½ï¼Œå·²è¢«é™åˆ¶ï¼‰ï¼Œæˆ–è€…å‚ç›´ï¼ˆslopeæ— ç©·å¤§ï¼‰ï¼Œåšç‰¹æ®Šå¤„ç†
    if (Math.abs(fishPos.x - eyePos.x) < 1) {
        // å‚ç›´è§‚çœ‹
        // è§†æ·± h' = h / n
        let realDepth = Math.abs(fishPos.y - waterLevel);
        let apparentDepth = realDepth / (nWater / nAir);
        virtualPos = createVector(fishPos.x, waterLevel + apparentDepth);
    }

    // 4. ç»˜åˆ¶å…‰è·¯
    drawLightPath(fishPos, incidencePoint, eyePos, virtualPos);

    // 5. ç»˜åˆ¶ç‰©ä½“ (é±¼å’Œçœ¼)
    drawFish(fishPos, 'A', false); // å®ç‰© A
    if (showVirtual) {
        drawFish(virtualPos, 'B', true);  // è™šåƒ B
    }
    drawEye(eyePos);

    // 6. æ›´æ–°æ•°æ®é¢æ¿
    updateStatus(fishPos, incidencePoint, eyePos, virtualPos);

    // 7. å¤„ç†äº¤äº’é€»è¾‘
    handleDrag();
}

/**
 * ç»˜åˆ¶ç¯å¢ƒèƒŒæ™¯
 */
function drawEnvironment() {
    noStroke();
    
    // ç©ºæ°”
    fill(250, 250, 255);
    rect(0, 0, width, waterLevel);
    
    // æ°´
    // ä½¿ç”¨æ¸å˜æ•ˆæœä¼šæ›´å¥½ï¼Œä½† p5 é»˜è®¤ä¸æ”¯æŒç®€ä¾¿çš„æ¸å˜ï¼Œç”¨çº¯è‰²å³å¯
    fill(220, 240, 255);
    rect(0, waterLevel, width, height - waterLevel);

    // åˆ†ç•Œçº¿
    stroke(0, 100, 200);
    strokeWeight(2);
    line(0, waterLevel, width, waterLevel);

    // æ–‡å­—æ ‡ç­¾
    noStroke();
    fill(100, 100, 100);
    textSize(16);
    textAlign(LEFT, BOTTOM);
    text("ç©ºæ°” (Air) nâ‰ˆ1.0", 20, waterLevel - 10);
    fill(0, 100, 180);
    textAlign(LEFT, TOP);
    text(`æ°´ (Water) n=${nWater}`, 20, waterLevel + 10);
}

/**
 * ç»˜åˆ¶å…‰è·¯
 */
function drawLightPath(pFish, pIncidence, pEye, pVirtual) {
    // 1. å…¥å°„å…‰çº¿ (é±¼ -> ç•Œé¢)
    stroke(255, 100, 0); // æ©™è‰²å…‰çº¿
    strokeWeight(3);
    line(pFish.x, pFish.y, pIncidence.x, pIncidence.y);
    drawArrow(pFish, pIncidence, 0.6); // ç®­å¤´

    // 2. æŠ˜å°„å…‰çº¿ (ç•Œé¢ -> çœ¼)
    stroke(255, 100, 0);
    line(pIncidence.x, pIncidence.y, pEye.x, pEye.y);
    drawArrow(pIncidence, pEye, 0.5);

    // 3. è¾…åŠ©å…‰æŸï¼ˆå¯é€‰ï¼Œå¢å¼ºè§†è§‰æ•ˆæœï¼‰
    if (showRays) {
        stroke(255, 150, 0, 50);
        strokeWeight(10);
        line(pFish.x, pFish.y, pIncidence.x, pIncidence.y);
        line(pIncidence.x, pIncidence.y, pEye.x, pEye.y);
    }

    // 4. è™šåƒåå‘å»¶é•¿çº¿
    if (showVirtual) {
        stroke(100, 100, 100);
        strokeWeight(1);
        drawingContext.setLineDash([5, 5]); // è™šçº¿
        line(pVirtual.x, pVirtual.y, pIncidence.x, pIncidence.y);
        
        // ç»˜åˆ¶å‚ç›´è¾…åŠ©çº¿ (æ˜¾ç¤ºæ·±åº¦)
        stroke(0, 0, 0, 50);
        line(pFish.x, pFish.y, pFish.x, waterLevel);
        
        // æ ‡æ³¨æ·±åº¦ h å’Œ h'
        noStroke();
        fill(0);
        drawingContext.setLineDash([]);
        textSize(12);
        textAlign(RIGHT, CENTER);
        
        // çœŸå®æ·±åº¦
        text("H (å®æ·±)", pFish.x - 5, (pFish.y + waterLevel)/2);
        // è§†æ·±
        text("h' (è§†æ·±)", pVirtual.x - 5, (pVirtual.y + waterLevel)/2);
    }
    drawingContext.setLineDash([]); // æ¢å¤å®çº¿

    // 5. æ³•çº¿
    if (showNormal) {
        stroke(80);
        strokeWeight(1);
        drawingContext.setLineDash([2, 4]);
        line(pIncidence.x, pIncidence.y - 100, pIncidence.x, pIncidence.y + 100);
        drawingContext.setLineDash([]);
    }

    // 6. è§’åº¦æ ‡æ³¨
    if (showAngles) {
        drawAngle(pIncidence, -PI/2, Math.atan2(pFish.y - pIncidence.y, pFish.x - pIncidence.x), "i", color(200, 0, 0)); // å…¥å°„è§’
        drawAngle(pIncidence, -PI/2, Math.atan2(pEye.y - pIncidence.y, pEye.x - pIncidence.x), "r", color(0, 150, 0)); // æŠ˜å°„è§’
    }
}

/**
 * æ±‚è§£æ–¯æ¶…å°”å®šå¾‹çš„å…¥å°„ç‚¹ X åæ ‡
 * ä½¿ç”¨äºŒåˆ†æ³•é€¼è¿‘
 * y1 > 0 (æ°´ä¸­), y2 < 0 (ç©ºæ°”ä¸­), ç•Œé¢ y=0
 */
function solveSnell(pos1, pos2, boundaryY, n1, n2) {
    // åæ ‡å˜æ¢ï¼šä»¥ç•Œé¢ä¸Šçš„ç‚¹ä¸ºåŸç‚¹
    // è®¾å…¥å°„ç‚¹ x åœ¨ pos1.x å’Œ pos2.x ä¹‹é—´
    let x1 = Math.min(pos1.x, pos2.x);
    let x2 = Math.max(pos1.x, pos2.x);
    let y1 = Math.abs(pos1.y - boundaryY); // æ·±åº¦
    let y2 = Math.abs(pos2.y - boundaryY); // é«˜åº¦
    
    // å¦‚æœä¸¤ç‚¹å‚ç›´å¯¹é½ï¼Œç›´æ¥è¿”å› x
    if (Math.abs(pos1.x - pos2.x) < 0.1) return pos1.x;

    // ç›®æ ‡å‡½æ•°ï¼š n1 * sin(theta1) - n2 * sin(theta2) = 0
    // sin(theta) = opposite / hypotenuse
    // å¯¹äºç‚¹ P(x)ï¼Œtheta1 æ˜¯ä¸æ³•çº¿çš„å¤¹è§’ => sin(theta1) = (x - x_fish) / dist1
    // æ³¨æ„æ–¹å‘ã€‚è¿™é‡Œæˆ‘ä»¬ç®€åŒ–æ¨¡å‹ï¼Œæ±‚è§£æ—¶é—´æå€¼ç‚¹å¯¼æ•°ä¸º0ï¼Œæˆ–è€…ç›´æ¥ç”¨ Snellã€‚
    // è®¾ x ä¸ºå˜é‡ï¼Œx ä» fishX åˆ° eyeXã€‚
    // sin1 = (x - x_fish_real) / sqrt(...)
    // sin2 = (x_eye_real - x) / sqrt(...)
    
    // ç¡®ä¿ x_left æ˜¯é±¼ä¸€ä¾§çš„ xï¼Œx_right æ˜¯çœ¼ä¸€ä¾§çš„ xï¼Œæ–¹ä¾¿è®¡ç®—
    let fishLeft = pos1.x < pos2.x;
    let start = fishLeft ? pos1.x : pos2.x;
    let end = fishLeft ? pos2.x : pos1.x;
    
    // è¿­ä»£ 20 æ¬¡è¶³å¤Ÿç²¾ç¡®
    for (let i = 0; i < 20; i++) {
        let mid = (start + end) / 2;
        
        let d1 = Math.sqrt(Math.pow(mid - pos1.x, 2) + Math.pow(y1, 2));
        let sin1 = Math.abs(mid - pos1.x) / d1;
        
        let d2 = Math.sqrt(Math.pow(mid - pos2.x, 2) + Math.pow(y2, 2));
        let sin2 = Math.abs(mid - pos2.x) / d2;
        
        let val = n1 * sin1 - n2 * sin2;
        
        // è¿™é‡Œçš„ val ç¬¦å·å–å†³äº mid åå‘å“ªè¾¹ã€‚
        // å¦‚æœ mid é è¿‘ pos1ï¼Œåˆ™ sin1 å°ï¼Œsin2 å¤§ï¼Œn1*sin1 - n2*sin2 < 0 (å‡è®¾ n1 n2 å·®ä¸å¤š)
        // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°é›¶ç‚¹ã€‚
        
        if (val < 0) {
            // éœ€è¦å¢å¤§ sin1ï¼Œå³ mid è¿œç¦» pos1
            if (fishLeft) start = mid; else end = mid;
        } else {
            if (fishLeft) end = mid; else start = mid;
        }
    }
    return (start + end) / 2;
}

/**
 * ç»˜åˆ¶è§’åº¦å¼§çº¿å’Œæ ‡ç­¾
 */
function drawAngle(center, baseAngle, targetAngle, label, col) {
    noFill();
    stroke(col);
    strokeWeight(2);
    let r = 40;
    
    // ç¡®ä¿è§’åº¦åœ¨æ­£ç¡®çš„è±¡é™
    // baseAngle æ˜¯æ³•çº¿æ–¹å‘ (-PI/2 æŒ‡å‘ä¸Šï¼ŒPI/2 æŒ‡å‘ä¸‹)
    // æˆ‘ä»¬çš„å…¥å°„ç‚¹åœ¨ç•Œé¢ï¼Œæ³•çº¿æ˜¯å‚ç›´çš„ã€‚
    // å…¥å°„è§’ï¼šå…‰çº¿ä¸æ³•çº¿(å‘ä¸‹)å¤¹è§’ï¼Ÿä¸ï¼Œå…¥å°„è§’æ˜¯å…¥å°„å…‰çº¿ä¸æ³•çº¿å¤¹è§’ã€‚
    // ç®€å•çš„ç”»æ³•ï¼šè®¡ç®—ä¸¤ä¸ªè§’åº¦ï¼Œç”»ä¸­é—´çš„å¼§ã€‚
    
    // æ—¢ç„¶ p5 arc æ¯”è¾ƒéº»çƒ¦å¤„ç†é¡ºé€†æ—¶é’ˆï¼Œæˆ‘ä»¬ç”¨ç®€å•çš„æ’å€¼ç”»çº¿
    beginShape();
    // æ³•çº¿æ–¹å‘
    let normalDir = (center.y < fishPos.y) ? PI/2 : -PI/2; 
    // è¿™é‡Œæ³•çº¿æ˜¯å›ºå®šçš„ï¼šå‚ç›´çº¿ã€‚
    // åŒºåˆ†ä¸Šä¸‹ï¼š
    // å¦‚æœæ˜¯å…¥å°„è§’ï¼ˆåœ¨æ°´ä¸­ï¼‰ï¼Œæ³•çº¿æ˜¯å‚ç›´å‘ä¸Šè¿˜æ˜¯å‘ä¸‹ï¼Ÿé€šå¸¸å®šä¹‰æ³•çº¿æ˜¯å‚ç›´ç•Œé¢çš„çº¿ã€‚
    // å…¥å°„å…‰çº¿æ¥è‡ªä¸‹æ–¹ï¼Œæ‰€ä»¥å…¥å°„è§’æ˜¯å…‰çº¿ä¸å‚ç›´çº¿çš„å¤¹è§’ã€‚
    
    let angle1 = PI/2; // ä¸‹æ³•çº¿
    let angle2 = targetAngle; // å…‰çº¿è§’åº¦
    
    // å¦‚æœæ˜¯ç©ºæ°”ä¾§ï¼ˆä¸Šæ–¹ï¼‰
    if (targetAngle < 0) {
        angle1 = -PI/2; // ä¸Šæ³•çº¿
    }

    // ç»˜åˆ¶å¼§çº¿
    let startA = Math.min(angle1, angle2);
    let endA = Math.max(angle1, angle2);
    arc(center.x, center.y, r, r, startA, endA);
    
    // æ–‡å­—
    noStroke();
    fill(col);
    textSize(14);
    let midA = (startA + endA) / 2;
    text(label, center.x + (r + 15) * cos(midA), center.y + (r + 15) * sin(midA));
}

function drawFish(pos, label, isVirtual) {
    push();
    translate(pos.x, pos.y);
    if (isVirtual) {
        tint(255, 128); // åŠé€æ˜
    }
    
    // ç»˜åˆ¶ç®€å•çš„é±¼
    noStroke();
    if (isVirtual) fill(100, 100, 100);
    else fill(255, 100, 100); // çº¢è‰²å®ä½“é±¼
    
    // é±¼èº«
    ellipse(0, 0, fishSize, fishSize * 0.6);
    // é±¼å°¾
    triangle(-fishSize/2, 0, -fishSize*0.8, -10, -fishSize*0.8, 10);
    
    // æ ‡ç­¾ A æˆ– B
    fill(0);
    textAlign(CENTER, CENTER);
    textStyle(BOLD);
    text(label, 10, -15);
    
    // é±¼çœ¼
    fill(255);
    circle(fishSize/4, -5, 5);
    fill(0);
    circle(fishSize/4, -5, 2);
    
    pop();
}

function drawEye(pos) {
    push();
    translate(pos.x, pos.y);
    
    // ç»˜åˆ¶çœ¼ç›å›¾æ ‡
    stroke(0);
    strokeWeight(2);
    fill(255);
    // çœ¼çƒè½®å»“
    beginShape();
    vertex(-eyeSize/2, 0);
    bezierVertex(-eyeSize/4, -eyeSize/2, eyeSize/4, -eyeSize/2, eyeSize/2, 0);
    bezierVertex(eyeSize/4, eyeSize/2, -eyeSize/4, eyeSize/2, -eyeSize/2, 0);
    endShape(CLOSE);
    
    // ç³å­” (çœ‹å‘å…¥å°„ç‚¹æ–¹å‘ï¼Œç¨å¾®åŠ¨ä¸€ä¸‹å¾ˆæœ‰è¶£ï¼Œè¿™é‡Œç®€åŒ–å±…ä¸­)
    fill(0);
    circle(0, 0, eyeSize/3);
    
    noStroke();
    fill(0);
    textAlign(CENTER, TOP);
    text("äººçœ¼", 0, eyeSize/2 + 5);
    
    pop();
}

function drawArrow(p1, p2, ratio) {
    let x = lerp(p1.x, p2.x, ratio);
    let y = lerp(p1.y, p2.y, ratio);
    let angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
    
    push();
    translate(x, y);
    rotate(angle);
    fill(255, 100, 0);
    noStroke();
    triangle(-5, 3, -5, -3, 5, 0);
    pop();
}

function updateStatus(pFish, pIncidence, pEye, pVirtual) {
    let dy = Math.abs(pFish.y - waterLevel);
    let dy_prime = Math.abs(pVirtual.y - waterLevel);
    
    // è®¡ç®—å…¥å°„è§’ i å’ŒæŠ˜å°„è§’ r
    // å‘é‡ vectorFishToSurface
    let v1 = createVector(pFish.x - pIncidence.x, pFish.y - pIncidence.y); // æŒ‡å‘ä¸‹æ–¹
    let normalDown = createVector(0, 1);
    let angleI = degrees(v1.angleBetween(normalDown)); 
    
    // å‘é‡ vectorSurfaceToEye
    let v2 = createVector(pEye.x - pIncidence.x, pEye.y - pIncidence.y); // æŒ‡å‘ä¸Šæ–¹
    let normalUp = createVector(0, -1);
    let angleR = degrees(v2.angleBetween(normalUp));

    let html = `
        <span style="color:#d32f2f">å®æ·± (H): ${dy.toFixed(0)} px</span><br>
        <span style="color:#757575">è§†æ·± (h'): ${dy_prime.toFixed(0)} px</span><br>
        -----------------<br>
        å…¥å°„è§’ i: ${Math.abs(angleI).toFixed(1)}Â°<br>
        æŠ˜å°„è§’ r: ${Math.abs(angleR).toFixed(1)}Â°<br>
        <br>
        <b>ç»“è®º:</b> è§†æ·± < å®æ·±<br>
        (é±¼çœ‹èµ·æ¥å˜æµ…äº†)
    `;
    select('#status-display').html(html);
}

/**
 * äº¤äº’é€»è¾‘ï¼šæ‹–åŠ¨æ£€æµ‹
 */
function mousePressed() {
    // æ£€æµ‹æ˜¯å¦ç‚¹å‡»äº†é±¼
    if (dist(mouseX, mouseY, fishPos.x, fishPos.y) < fishSize) {
        draggingFish = true;
        return;
    }
    // æ£€æµ‹æ˜¯å¦ç‚¹å‡»äº†çœ¼
    if (dist(mouseX, mouseY, eyePos.x, eyePos.y) < eyeSize) {
        draggingEye = true;
        return;
    }
}

function mouseReleased() {
    draggingFish = false;
    draggingEye = false;
}

function handleDrag() {
    if (draggingFish) {
        fishPos.x = constrain(mouseX, 50, width - 50);
        fishPos.y = constrain(mouseY, waterLevel + 20, height - 20); // å¿…é¡»åœ¨æ°´ä¸­
        cursor('grabbing');
    } else if (draggingEye) {
        eyePos.x = constrain(mouseX, 50, width - 50);
        eyePos.y = constrain(mouseY, 20, waterLevel - 20); // å¿…é¡»åœ¨ç©ºæ°”ä¸­
        cursor('grabbing');
    } else {
        // é¼ æ ‡æ‚¬åœæ£€æµ‹æ”¹å˜å…‰æ ‡
        if (dist(mouseX, mouseY, fishPos.x, fishPos.y) < fishSize || 
            dist(mouseX, mouseY, eyePos.x, eyePos.y) < eyeSize) {
            cursor('grab');
        } else {
            cursor('default');
        }
    }
}

function clampPositions() {
    fishPos.x = constrain(fishPos.x, 50, width - 50);
    fishPos.y = constrain(fishPos.y, waterLevel + 20, height - 20);
    eyePos.x = constrain(eyePos.x, 50, width - 50);
    eyePos.y = constrain(eyePos.y, 20, waterLevel - 20);
}
</script>

</body>
</html>